<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>View Operation</title>
    <style>
        body{ font-family:'Segoe UI',sans-serif; background:#f5f7fa; margin:0; padding:0; display:flex; justify-content:center; }
        .card{ background:white; padding:26px; border-radius:12px; box-shadow:0 10px 25px rgba(0,0,0,0.08); max-width:900px; width:100%; margin:20px; }
        h2{ text-align:center; color:#0369a1; margin-bottom:8px; }
        .top-info{ text-align:center; font-weight:700; margin-bottom:14px; }
        table{ width:100%; border-collapse:collapse; margin-top:8px; }
        table th, table td{ border:1px solid #e6eef6; padding:10px; }
        table th{ background:#0369a1; color:white; text-align:left; }
        .progress-bar{ width:220px; height:16px; background:#eef6fb; border-radius:10px; overflow:hidden; margin:12px auto; }
        .progress-fill{ height:100%; width:0; transition:width .25s ease-in-out; }
        .progress-red{ background:#ef4444; }
        .progress-yellow{ background:#f59e0b; }
        .progress-green{ background:#10b981; }
        .buttons{ text-align:center; margin-top:16px; }
        .btn{ padding:10px 18px; margin:0 8px; border:none; border-radius:6px; cursor:pointer; }
        .btn-update{ background:#059669; color:white; }
        .btn-back{ background:#94a3b8; color:white; }
        @media (max-width:720px){ .card{ padding:14px; } table th,table td{ padding:8px; } }
    </style>
</head>
<body>

<div class="card">
    <h2>Operation Details</h2>
    <div class="top-info" id="infoBox"></div>

    <div style="text-align:center;">
        <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
        <div id="progressText" style="font-weight:700; margin-bottom:12px;"></div>
    </div>

    <table>
        <thead><tr><th>Field</th><th>Value</th></tr></thead>
        <tbody id="fieldsBody"></tbody>
    </table>

    <div class="buttons">
        <button class="btn btn-update" id="updateBtn">Update</button>
        <button class="btn btn-back" id="backBtn">Back</button>
    </div>
</div>

<script>

    const params = new URLSearchParams(window.location.search);
    const plantID = params.get('plantID');
    const date = params.get('date');
    const filter = params.get('filter');
    const value = params.get('value');

    function goBack() {
        let url = `index.html?date=${encodeURIComponent(date)}`;
        if (filter && value) url += `&filter=${encodeURIComponent(filter)}&value=${encodeURIComponent(value)}`;
        window.location.href = url;
    }

    document.getElementById('backBtn').addEventListener('click', goBack);

    if (!plantID) goBack();

    document.getElementById('infoBox').innerHTML =
        `Date: <span style="color:#f97316">${date}</span> &nbsp; | &nbsp; Plant ID: <span style="color:#059669">${plantID}</span>`;

    const fields = [
        "sludgeTankLevel","sludgeProcessed","sludgeReceived","biocharProduced","plantRunningHrs",
        "solarReadingAm","solarReadingPm","powerReadingAm","powerReadingPm",
        "noOfTrips","vehicleReadingAm","vehicleReadingPm","dgUsed","dgRunHrs"
    ];

    const fieldsBody = document.getElementById('fieldsBody');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const updateBtn = document.getElementById('updateBtn');

    function applyProgressBar(progress) {
        const cls = progress === 100 ? 'progress-green' :
                     progress > 0 ? 'progress-yellow' :
                     'progress-red';

        progressFill.className = `progress-fill ${cls}`;
        progressFill.style.width = progress + '%';
        progressText.innerText = progress + '% Completed';
    }

    function calculateProgressFromOp(op) {
        let filled = 0;
        fields.forEach(f => {
            if (f === 'dgRunHrs') {
                if (op['dgUsed'] === false) filled++;
                else if (op[f] !== null && op[f] !== undefined && op[f] !== '') filled++;
            } else {
                if (op[f] !== null && op[f] !== undefined && op[f] !== '') filled++;
            }
        });
        return Math.round((filled / fields.length) * 100);
    }

    async function loadOperation() {
        try {
            const res = await fetch(`/api/operations/plant/${plantID}?date=${date}`);
            let op = {};
            if (res.ok) {
                const text = await res.text();
                if (text && text.trim()) {
                    try { op = JSON.parse(text); } catch(e) { op = {}; }
                }
            }

            fieldsBody.innerHTML = '';
            fields.forEach(f => {
                const tr = document.createElement('tr');
                const label = f.replace(/([A-Z])/g, ' $1');
                const val = (op[f] === null || op[f] === undefined || op[f] === '') ? '-' : op[f];
                tr.innerHTML = `<td>${label}</td><td>${val}</td>`;
                fieldsBody.appendChild(tr);
            });

            const progress = calculateProgressFromOp(op);
            applyProgressBar(progress);

            updateBtn.addEventListener('click', () => {
                let url = `update-operation.html?plantID=${encodeURIComponent(plantID)}&date=${encodeURIComponent(date)}`;
                if (filter && value) url += `&filter=${encodeURIComponent(filter)}&value=${encodeURIComponent(value)}`;
                window.location.href = url;
            });

        } catch (e) {
            fieldsBody.innerHTML = `<tr><td colspan="2">Error: ${e.message}</td></tr>`;
        }
    }

    loadOperation();
</script>
</body>
</html>
