<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="https://mvrtech.org/MVR_Company_Logo%20copy.png">
    <title>View Operation</title>

    <style>
        body {
            font-family:'Segoe UI', sans-serif;
            background:#eef2f7;
            margin:0;
            padding:0;
            display:flex;
            justify-content:center;
        }

        .card {
            background:white;
            padding:26px;
            border-radius:12px;
            box-shadow:0 10px 25px rgba(0,0,0,0.08);
            max-width:900px;
            width:100%;
            margin:20px;
        }

        h2 {
            text-align:center;
            margin-bottom:8px;
            color:#0369a1;
        }

        .top-info {
            font-weight:700;
            text-align:center;
            margin-bottom:16px;
            color:#374151;
        }

        table {
            width:100%;
            border-collapse:collapse;
            margin-top:10px;
        }

        table th, table td {
            border:1px solid #d9e2ec;
            padding:10px;
            font-size:15px;
        }

        table th {
            background:#0369a1;
            color:white;
            text-align:left;
            width:260px;
        }

        .progress-bar {
            width:240px;
            height:18px;
            background:#e5edf5;
            margin:12px auto;
            border-radius:10px;
            overflow:hidden;
        }

        .progress-fill {
            height:100%;
            width:0;
            transition:width 0.25s ease-out;
        }

        .progress-green { background:#10b981; }
        .progress-yellow { background:#f59e0b; }
        .progress-red { background:#ef4444; }

        .buttons {
            margin-top:20px;
            text-align:center;
        }

        .btn {
            padding:10px 18px;
            font-size:15px;
            border:none;
            border-radius:6px;
            color:white;
            cursor:pointer;
            margin:0 6px;
        }

        .btn-update { background:#059669; }
        .btn-back { background:#6b7280; }

        @media(max-width:700px){
            .card { padding:14px; }
            table th, table td { padding:8px; font-size:14px; }
        }
    </style>
</head>

<body>

<div class="card">

    <h2>Operation Details</h2>
    <div class="top-info" id="infoBox"></div>

    <div style="text-align:center;">
        <div class="progress-bar">
            <div id="progressFill" class="progress-fill"></div>
        </div>
        <div id="progressText" style="font-weight:700; margin-bottom:14px;"></div>
    </div>

    <table>
        <thead>
        <tr><th>Field</th><th>Value</th></tr>
        </thead>
        <tbody id="fieldsBody"></tbody>
    </table>

    <div class="buttons">
        <button class="btn btn-update" id="updateBtn">Update</button>
        <button class="btn btn-back" id="backBtn">Back</button>
    </div>

</div>

<script>

    const params = new URLSearchParams(window.location.search);
    const plantID = params.get('plantID');
    const date = params.get('date');

    document.getElementById("infoBox").innerHTML =
        `Date: <span style="color:#f97316">${date}</span> &nbsp; | &nbsp;
         Plant ID: <span style="color:#059669">${plantID}</span>`;

    function goBack() {
        window.location.href = `index.html?date=${encodeURIComponent(date)}`;
    }
    document.getElementById("backBtn").addEventListener("click", goBack);

    // ------------------------------------
    // EXACT SEQUENCE AS ENTITY CLASS
    // ------------------------------------
    const fields = [
        "operationDate",
        "sludgeTankLevelAm",
        "sludgeTankLevelPm",
        "sludgeReceived",
        "noOfTrips",
        "sludgeProcessed",
        "biocharProduced",
        "plantRunningHrs",
        "solarIntegration",

        "powerReadingAmImport",
        "powerReadingAmExport",
        "powerReadingPmImport",
        "powerReadingPmExport",

        "powerReadingAm",
        "powerReadingPm",

        "powerConsumed",

        "dgReadingAm",
        "dgReadingPm",
        "dgDiesalPercentageAm",
        "dgDiesalPercentagePm",
        "dgRunHours",

        "vehicleReadingAm",
        "vehicleReadingPm",
        "vehicleFuelLevel",

        "polymerUsage",
        "pillets",
        "flowMeterReadingAm",
        "flowMeterReadingPm",
        "cod",
        "bod",
        "tn",
        "temperature",
        "tss",
        "ph",
        "remarks"
    ];

    // For progress calculation
    const backendFields = [
        "sludgeTankLevelAm","sludgeTankLevelPm","sludgeReceived","noOfTrips","sludgeProcessed",
        "biocharProduced","plantRunningHrs","solarIntegration",

        "powerReadingAmImport","powerReadingAmExport","powerReadingPmImport","powerReadingPmExport",
        "powerReadingAm","powerReadingPm",

        "powerConsumed",

        "dgReadingAm","dgReadingPm","dgDiesalPercentageAm","dgDiesalPercentagePm",,"dgRunHours",

        "vehicleReadingAm","vehicleReadingPm","vehicleFuelLevel",

        "polymerUsage","pillets","flowMeterReadingAm","flowMeterReadingPm","cod","bod","tn","temperature","tss","ph"
    ];

    const fieldsBody = document.getElementById("fieldsBody");
    const progressFill = document.getElementById("progressFill");
    const progressText = document.getElementById("progressText");

    // ------------------------------------
    // PROGRESS LOGIC: 23 (YES) / 21 (NO)
    // ------------------------------------
    function calculateProgress(op) {

        const total = op.solarIntegration === true ? 31 : 29;
        let filled = 0;

        backendFields.forEach(f => {

            // Hide AM/PM when solar = YES
            if (op.solarIntegration === true &&
                (f === "powerReadingAm" || f === "powerReadingPm"))
                return;

            // Hide import/export when solar = NO
            if (op.solarIntegration === false &&
                (f === "powerReadingAmImport" || f === "powerReadingAmExport" ||
                 f === "powerReadingPmImport" || f === "powerReadingPmExport"))
                return;

            if (op[f] !== null && op[f] !== undefined && op[f] !== "")
                filled++;
        });

        return Math.min(100, Math.round((filled / total) * 100));
    }

    function applyProgressBar(progress) {
        const color =
            progress === 100 ? "progress-green" :
            progress >= 1   ? "progress-yellow" :
                              "progress-red";

        progressFill.className = `progress-fill ${color}`;
        progressFill.style.width = progress + "%";
        progressText.textContent = progress + "% Completed";
    }

    async function loadOperation() {
        const res = await fetch(`/api/operations/plant/${plantID}?date=${date}`);
        let op = {};
        const text = await res.text();
        if (text && text.trim()) op = JSON.parse(text);

        fieldsBody.innerHTML = "";

        fields.forEach(f => {
            let label = f.replace(/([A-Z])/g, " $1")
                         .replace(/^./, c => c.toUpperCase());

            let value = op[f];

            if (f === "solarIntegration")
                value = value === true ? "Yes" : value === false ? "No" : "-";

            value = (value === null || value === undefined || value === "") ? "-" : value;

            const tr = document.createElement("tr");
            tr.innerHTML = `<td>${label}</td><td>${value}</td>`;
            fieldsBody.appendChild(tr);
        });

        const progress = calculateProgress(op);
        applyProgressBar(progress);

        document.getElementById("updateBtn").onclick = () =>
            window.location.href = `update-operation.html?plantID=${plantID}&date=${date}`;
    }

    // ------------------------------------
    // AUTO-REFRESH ON ANY UPDATE (SSE)
    // ------------------------------------
    function startSSE() {
        const evt = new EventSource("/api/events/updates");
        evt.onmessage = () => loadOperation();
        evt.onerror   = () => setTimeout(startSSE, 2000);
    }

    startSSE();
    loadOperation();

</script>

</body>
</html>
