<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>View Operation</title>

    <!-- pdf libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        body { font-family: "Segoe UI", sans-serif; background:#eef2f7; margin:0; display:flex; justify-content:center; }
        .card { background:#fff; width:100%; max-width:960px; margin:18px; padding:22px; border-radius:10px; box-shadow:0 10px 25px rgba(2,6,23,0.06); }
        h2 { color:#0369a1; text-align:center; margin:0 0 8px 0; }
        .top-info { text-align:center; font-weight:700; color:#374151; margin-bottom:14px; }
        table { width:100%; border-collapse:collapse; margin-top:12px; }
        th, td { border:1px solid #d9e2ec; padding:10px; font-size:14px; vertical-align:top; }
        th { background:#0369a1; color:#fff; text-align:left; width:320px; }
        .vehicle-title { margin-top:16px; font-weight:700; color:#0f172a; }
        .buttons { text-align:center; margin-top:18px; }
        .btn { padding:10px 14px; border-radius:6px; border:none; cursor:pointer; color:#fff; font-weight:700; margin:0 6px; }
        .btn-update { background:#059669; }
        .btn-back { background:#6b7280; }
        .btn-pdf { background:#2563eb; }
        .progress-bar { width:260px; height:18px; background:#e9f0fb; border-radius:10px; margin:12px auto; overflow:hidden; }
        .progress-fill { height:100%; width:0; transition:width .25s ease; }
        .progress-green { background:#10b981; }
        .progress-yellow { background:#f59e0b; }
        .progress-red { background:#ef4444; }
        .progress-text { text-align:center; font-weight:700; margin-top:6px; color:#374151; }
        .muted { color:#6b7280; font-size:13px; }
        .inline-row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
        @media (max-width:720px){ th { width:180px; } table td { font-size:13px } }

        .section-header td{
            background:#0f172a;
            color:#ffffff;
            font-weight:700;
            font-size:15px;
            padding:12px;
        }
        .section-header{
            border-top:14px solid #eef2f7;
        }

        .trip-line {
  display: grid;
  grid-template-columns: 160px 20px 1fr;
  padding: 6px 4px;
  font-size: 14px;
  align-items: center;
}

.trip-label {
  font-weight: 700;
  color: #0f172a;
}

.trip-sep {
  text-align: center;
  font-weight: 700;
}

.trip-values {
  display: flex;
  gap: 28px;
  color: #374151;
}

.trip-values span {
  white-space: nowrap;
}

.sludge-summary {
  display: flex;
  gap: 40px;
  font-weight: 700;
  padding: 6px 4px;
}


    </style>
</head>
<body>
<div class="card" id="mainCard">
    <h2 id="title">Operation Details</h2>
    <div class="top-info" id="infoBox">Loading...</div>

    <div style="text-align:center">
        <div class="progress-bar" aria-hidden="true">
            <div id="progressFill" class="progress-fill progress-red"></div>
        </div>
        <div id="progressText" class="progress-text">0% Completed</div>
    </div>

    <table aria-describedby="operation-fields">
        <thead>
        <tr>
            <th>Field</th>
            <th>Value</th>
        </tr>
        </thead>
        <tbody id="fieldsBody"></tbody>
    </table>

    <h3 style="margin-top:18px;color:#0369a1">Vehicle Operations</h3>
    <div id="vehicleOps"></div>

    <h3 style="margin-top:14px;color:#0369a1">Private Vehicles</h3>
    <table id="privateTable" style="margin-top:8px">
        <thead>
        <tr>
            <th>Field</th>
            <th>Value</th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td>Private Vehicles Present</td>
            <td id="pv_present">-</td>
        </tr>
        <tr>
            <td>Private Vehicles No. of Trips</td>
            <td id="pv_trips">-</td>
        </tr>
        <tr>
            <td>Private Vehicles Sludge (Ltrs)</td>
            <td id="pv_sludge">-</td>
        </tr>
        <tr>
            <td>Private Vehicles Sludge (Kgs)</td>
            <td id="pv_sludge_kgs">-</td>
        </tr>
        </tbody>
    </table>
    <h3 style="margin-top:14px;color:#0369a1">Private Vehicle Details</h3>
    <div id="privateVehicleDetails"></div>

    <div class="buttons">
        <button id="updateBtn" class="btn btn-update">Update</button>
        <button id="backBtn" class="btn btn-back">Back</button>
        <button id="pdfBtn" class="btn btn-pdf">Download PDF</button>
    </div>
</div>

<script>
    let plantSolar = false;
    (function(){
        // get params
        const params = new URLSearchParams(window.location.search);
        const plantID = params.get('plantID');
        const date = params.get('date');

        const infoBox = document.getElementById('infoBox');
        const fieldsBody = document.getElementById('fieldsBody');
        const vehicleOpsDiv = document.getElementById('vehicleOps');
        const pvPresentEl = document.getElementById('pv_present');
        const pvTripsEl = document.getElementById('pv_trips');
        const pvSludgeEl = document.getElementById('pv_sludge');
        const pvSludgeKgsEl = document.getElementById('pv_sludge_kgs');

        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const updateBtn = document.getElementById('updateBtn');
        const backBtn = document.getElementById('backBtn');
        const pdfBtn = document.getElementById('pdfBtn');

        // fields in exact order
        const fields = [
            "operationDate",
            "sludgeTankLevelAm",
            "sludgeTankLevelPm",
            "sludgeReceived",
            "totalNoOfTrips",
            "sludgeProcessed",
            "biocharProduced",
            "plantRunningHrs",
            "powerReadingAmImport",
            "powerReadingAmExport",
            "powerReadingPmImport",
            "powerReadingPmExport",
            "powerConsumed",
            "dgReadingAm",
            "dgReadingPm",
            "dgDiesalPercentageAm",
            "dgDiesalPercentagePm",
            "dgRunHours",
            "polymerUsage",
            "polymerStock",
            "pillets",
            "pilletsStock",
            "remarks"
        ];

        const labelMap = {
            operationDate: "Operation Date",
            sludgeTankLevelAm: "Sludge Tank Level Morning (Ltrs)",
            sludgeTankLevelPm: "Sludge Tank Level Evening (Ltrs)",
            sludgeReceived: "Sludge Received (Ltrs)",
            totalNoOfTrips: "Total No. Of Trips",
            sludgeProcessed: "Sludge Processed (Ltrs)",
            biocharProduced: "Biochar Produced (Kgs)",
            plantRunningHrs: "Plant Running Hours (Hrs)",
            solarIntegration: "Solar Integration",
            powerReadingAmImport: "Power Reading AM - Import (Kwh)",
            powerReadingAmExport: "Power Reading AM - Export (Kwh)",
            powerReadingPmImport: "Power Reading PM - Import (Kwh)",
            powerReadingPmExport: "Power Reading PM - Export (Kwh)",
            powerConsumed: "Power Consumed (Kwh)",
            dgReadingAm: "DG RunHours Morning (Hrs)",
            dgReadingPm: "DG RunHours Evening (Hrs)",
            dgDiesalPercentageAm: "DG Diesel % Morning",
            dgDiesalPercentagePm: "DG Diesel % Evening",
            dgRunHours: "DG Total Run Hours (Hrs)",
            polymerUsage: "Polymer Usage (grms)",
            polymerStock: "Polymer Stock (Kgs)",
            pillets: "Pillets Usage (Kgs)",
            pilletsStock: "Pillets Stock (Kgs)",
            remarks: "Remarks"
        };

        const units = {
            sludgeTankLevelAm: "Ltrs", sludgeTankLevelPm: "Ltrs", sludgeReceived: "Ltrs",
            sludgeProcessed: "Ltrs", biocharProduced: "Kgs", plantRunningHrs: "Hrs",
            powerReadingAmImport: "Kwh", powerReadingAmExport: "Kwh", powerReadingPmImport: "Kwh",
            powerReadingPmExport: "Kwh", powerConsumed: "Kwh",
            dgReadingAm: "Hrs", dgReadingPm: "Hrs", dgRunHours: "Hrs",
            dgDiesalPercentageAm: "%", dgDiesalPercentagePm: "%",
            polymerUsage: "grms", polymerStock: "Kgs", pillets: "Kgs", pilletsStock: "Kgs"
        };

        // helper format
        function fmt(field, v){
            if (v === null || v === undefined || v === "") return "-";
            if (units[field]) return `${v} ${units[field]}`;
            if (field === "operationDate") {
                try {
                    const d = new Date(v);
                    if (!isNaN(d.getTime())) return d.toLocaleDateString();
                } catch {}
                return v;
            }
            return v;
        }
        function to2(val) {
            if (val === null || val === undefined || val === "") return "-";
            const num = Number(val);
            return isNaN(num) ? "-" : num.toFixed(2);
        }


        // compute progress according to rules:
        // base fields + solar logic + vehicle counts + private aggregates logic
      function computeProgress(op, vehicleOps, privateAgg, privateList) {
  let filled = 0;
  let total = 0;

  /* ================= PLANT FIELDS ================= */
  const alwaysPlant = [
    "sludgeTankLevelAm",
    "sludgeTankLevelPm",
    "sludgeProcessed",
    "biocharProduced",
    "plantRunningHrs",
    "dgReadingAm",
    "dgReadingPm",
    "dgDiesalPercentageAm",
    "dgDiesalPercentagePm",
    "polymerUsage",
    "polymerStock",
    "pillets",
    "pilletsStock"
  ];

  alwaysPlant.forEach(f => {
    total++;
    if (op && op[f] !== null && op[f] !== "") filled++;
  });

  /* ================= POWER IMPORT ================= */
  ["powerReadingAmImport", "powerReadingPmImport"].forEach(f => {
    total++;
    if (op && op[f] !== null && op[f] !== "") filled++;
  });

  /* ================= SOLAR EXPORT ================= */
  if (plantSolar) {
    ["powerReadingAmExport", "powerReadingPmExport"].forEach(f => {
      total++;
      if (op && op[f] !== null && op[f] !== "") filled++;
    });
  }

  /* ================= POWER BILL ================= */
  total++; // powerBill checkbox always counts
  if (op && typeof op.powerBill === "boolean") filled++;

  if (op && op.powerBill === true) {
    ["lastBillDate", "TotalNoOfUnits", "totalBillAmount"].forEach(f => {
      total++;
      if (op[f] !== null && op[f] !== "") filled++;
    });
  }

  /* ================= PRIVATE VEHICLES ================= */
  if (privateAgg && privateAgg.privateVehicle === true) {
  total += 3;

  if (privateAgg.noOfTripsPrivateVehicle !== null && privateAgg.noOfTripsPrivateVehicle !== "")
    filled++;

  if (privateAgg.sludgeCollectPrivateVehicle !== null && privateAgg.sludgeCollectPrivateVehicle !== "")
    filled++;

  if (op.sludgeCollectPrivateVehicleKgs !== null && op.sludgeCollectPrivateVehicleKgs !== "")
    filled++;
}


  /* ================= PRIVATE VEHICLE PER-TRIP DETAILS ================= */
if (Array.isArray(privateList) && privateAgg?.privateVehicle === true) {
  privateList.forEach(pv => {
    total += 2; // Ltrs + Kgs
    if (pv.receivedSludgeLtrs !== null && pv.receivedSludgeLtrs !== "") filled++;
    if (pv.receivedSludgeKgs !== null && pv.receivedSludgeKgs !== "") filled++;
  });
}

  /* ================= VEHICLES ================= */
if (Array.isArray(vehicleOps)) {
  vehicleOps.forEach(v => {

    total += 6;

    if (v.vehicleReadingAm !== null && v.vehicleReadingAm !== "") filled++;
    if (v.vehicleReadingPm !== null && v.vehicleReadingPm !== "") filled++;
    if (v.vehicleFuelLevel !== null && v.vehicleFuelLevel !== "") filled++;
    if (v.noOfTrips !== null && v.noOfTrips !== "") filled++;
    if (v.sludgeCollect !== null && v.sludgeCollect !== "") filled++;
    if (v.sludgeCollectKgs !== null && v.sludgeCollectKgs !== "") filled++;

    if (v.lastFuelFilled === true) {
      total += 3;

      // checkbox itself
      filled++;

      if (v.lastFuelFilledDate !== null && v.lastFuelFilledDate !== "") filled++;
      if (v.filledLiters !== null && v.filledLiters !== "") filled++;
    }
  });
}

  return total === 0 ? 0 : Math.round((filled / total) * 100);
}


        function applyProgressBar(pct){
            progressFill.style.width = pct + "%";
            progressFill.classList.remove("progress-green","progress-yellow","progress-red");
            if (pct === 100) progressFill.classList.add("progress-green");
            else if (pct > 0) progressFill.classList.add("progress-yellow");
            else progressFill.classList.add("progress-red");
            progressText.textContent = pct + "% Completed";
        }

        // load plant op + vehicles + vehicle ops
        async function loadAll(){
            try {
            let privateAgg = {
                privateVehicle: false,
                noOfTripsPrivateVehicle: null,
                sludgeCollectPrivateVehicle: null
            };
            let pvList = [];


                // fetch plant info (for name)
               let plantName = null;
                try {
                    const pr = await fetch(`/api/plants/${plantID}`);
                    if (pr.ok) {
                        const plant = await pr.json();
                        plantName = plant.plantName || plant.name || null;
                        plantSolar = plant.solar === true; // ✅ IMPORTANT
                    }
                } catch(e){
                    plantName = null;
                    plantSolar = false;
                }
                if (plantName) {
                    document.getElementById('title').textContent = `${plantName} — Operation Details`;
                } else {
                    document.getElementById('title').textContent = `Operation Details`;
                }
                infoBox.innerHTML = `
                      Date: <strong style="color:#f97316">${escapeHtml(date)}</strong>
                      &nbsp; | &nbsp;
                      Plant ID: <strong style="color:#059669">${escapeHtml(plantID)}</strong>
                      ${plantName ? `&nbsp; | &nbsp; Plant Name: <strong style="color:#2563eb">${escapeHtml(plantName)}</strong>` : ""}
                    `;


                // fetch plant operation
                const resOp = await fetch(`/api/operations/plant/${plantID}?date=${encodeURIComponent(date)}`);
                const textOp = await resOp.text();
                const op = (textOp && textOp.trim()) ? JSON.parse(textOp) : {};

                /* ================= ALWAYS LOAD LATEST POWER BILL ================= */

try {
    const rb = await fetch(
        `/api/operations/plant/${plantID}/latest-power-bill`
    );

    if (rb.ok) {
        const latestBill = await rb.json();

        // Apply latest bill values ONLY if missing in current day
        if (!op.lastBillDate) {
            op.lastBillDate = latestBill.lastBillDate;
        }

        if (!op.TotalNoOfUnits) {
            op.TotalNoOfUnits = latestBill.TotalNoOfUnits;
        }

        if (!op.totalBillAmount) {
            op.totalBillAmount = latestBill.totalBillAmount;
        }
    }
} catch (e) {
    console.warn("Latest power bill fetch failed", e);
}


                fieldsBody.innerHTML = `
<tr class="section-header"><td colspan="2">Sludge Report</td></tr>

<tr>
  <th>Sludge Tank Level (Ltrs)</th>
  <td class="inline-row">
    <div>Morning: <strong>${fmt("sludgeTankLevelAm", op.sludgeTankLevelAm)}</strong></div>
    <div>Evening: <strong>${fmt("sludgeTankLevelPm", op.sludgeTankLevelPm)}</strong></div>
  </td>
</tr>

<tr><th>Sludge Processed (Ltrs)</th><td>${fmt("sludgeProcessed", op.sludgeProcessed)}</td></tr>
<tr><th>Biochar Produced (Kgs)</th><td>${fmt("biocharProduced", op.biocharProduced)}</td></tr>
<tr><th>Plant Running Hrs (Hrs)</th><td>${fmt("plantRunningHrs", op.plantRunningHrs)}</td></tr>

<tr>
  <th>Total Sludge Received (Ltrs)</th>
  <td style="background:#dcfce7;font-weight:700">${fmt("sludgeReceived", op.sludgeReceived)}</td>
</tr>

<tr>
  <th>Total Sludge Received (Kgs)</th>
  <td style="background:#dcfce7;font-weight:700">
    ${fmt("sludgeReceivedKgs", op.sludgeReceivedKgs)}
  </td>
</tr>

<tr>
  <th>Total No. Of Trips</th>
  <td style="background:#dcfce7;font-weight:700">${fmt("totalNoOfTrips", op.totalNoOfTrips)}</td>
</tr>
`;
fieldsBody.innerHTML += `
<tr class="section-header"><td colspan="2">Power & Solar Report</td></tr>

<tr>
  <th>Power Import (Kwh)</th>
  <td class="inline-row">
    <div>Morning: <strong>${fmt("powerReadingAmImport", op.powerReadingAmImport)}</strong></div>
    <div>Evening: <strong>${fmt("powerReadingPmImport", op.powerReadingPmImport)}</strong></div>
  </td>
</tr>
`;

if (plantSolar === true) {
  fieldsBody.innerHTML += `
  <tr>
    <th>Solar Power Export (Kwh)</th>
    <td class="inline-row">
      <div>Morning: <strong>${fmt("powerReadingAmExport", op.powerReadingAmExport)}</strong></div>
      <div>Evening: <strong>${fmt("powerReadingPmExport", op.powerReadingPmExport)}</strong></div>
    </td>
  </tr>

  <tr>
  <th>Solar Power Generated (Kwh)</th>
  <td style="background:#dcfce7;font-weight:700">
    ${
      (op.powerReadingPmExport != null && op.powerReadingAmExport != null)
        ? to2(op.powerReadingPmExport - op.powerReadingAmExport)
        : "-"
    }
  </td>
</tr>
  `;
}
fieldsBody.innerHTML += `
<tr>
  <th>Power Consumed (Kwh)</th>
  <td style="background:#dcfce7;font-weight:700">
    ${to2(op.powerConsumed)}
  </td>
</tr>
`;


fieldsBody.innerHTML += `
<tr><th>Power Bill Generated?</th><td>${op.powerBill ? "Yes" : "No"}</td></tr>
<tr><th>Last Bill Date</th><td>${op.lastBillDate ?? "-"}</td></tr>

<tr>
  <th>Power Bill Details</th>
  <td class="inline-row">
    <div>Total Units: <strong>${op.TotalNoOfUnits ?? "-"}</strong></div>
    <div>Total Amount: <strong>${op.totalBillAmount ?? "-"}</strong></div>
  </td>
</tr>

`;
fieldsBody.innerHTML += `
<tr class="section-header"><td colspan="2">DG Report</td></tr>

<tr>
  <th>DG RunHours (Hrs)</th>
  <td class="inline-row">
    <div>Morning: <strong>${fmt("dgReadingAm", op.dgReadingAm)}</strong></div>
    <div>Evening: <strong>${fmt("dgReadingPm", op.dgReadingPm)}</strong></div>
  </td>
</tr>

<tr>
  <th>DG Diesel %</th>
  <td class="inline-row">
    <div>Morning: <strong>${fmt("dgDiesalPercentageAm", op.dgDiesalPercentageAm)}</strong></div>
    <div>Evening: <strong>${fmt("dgDiesalPercentagePm", op.dgDiesalPercentagePm)}</strong></div>
  </td>
</tr>

<tr>
  <th>DG Total Run Hours (Hrs)</th>
  <td style="background:#dcfce7;font-weight:700">${to2(op.dgRunHours)}</td>
</tr>
<tr>
  <th>DG Used Fuel (%)</th>
  <td style="background:#dcfce7;font-weight:700">
    ${
      (op.dgDiesalPercentageAm != null && op.dgDiesalPercentagePm != null)
        ? to2(op.dgDiesalPercentageAm - op.dgDiesalPercentagePm)
        : "-"
    }
  </td>
</tr>
`;
fieldsBody.innerHTML += `
<tr class="section-header"><td colspan="2">Polymer & Pillets Report</td></tr>

<tr>
  <th>Polymer</th>
  <td class="inline-row">
    <div>Usage: <strong>${fmt("polymerUsage", op.polymerUsage)}</strong></div>
    <div>Stock: <strong>${fmt("polymerStock", op.polymerStock)}</strong></div>
  </td>
</tr>

<tr>
  <th>Pillets</th>
  <td class="inline-row">
    <div>Usage: <strong>${fmt("pillets", op.pillets)}</strong></div>
    <div>Stock: <strong>${fmt("pilletsStock", op.pilletsStock)}</strong></div>
  </td>
</tr>

<tr>
  <th>Remarks</th>
  <td>${op.remarks ?? "-"}</td>
</tr>
`;


                // fetch vehicles for this plant
                vehicleOpsDiv.innerHTML = "";
                const rv = await fetch(`/api/vehicle-operations/plant/${plantID}/vehicles`);
                const vehicles = rv.ok ? await rv.json() : [];


  // gather all vehicle operation objects for progress calc
const vehicleOpsList = [];
vehicleOpsDiv.innerHTML = "";


for (const v of vehicles) {

    /* ===== LOAD VEHICLE OP ===== */
    let vo = {};
    try {
        const rvo = await fetch(
            `/api/vehicle-operations/${v.vehicleID}?date=${encodeURIComponent(date)}`
        );
        const tv = await rvo.text();
        vo = (tv && tv.trim()) ? JSON.parse(tv) : {};
    } catch (e) {
        vo = {};
    }

    vehicleOpsList.push(vo); // ✅ important for progress

    /* ===== LOAD TRIP DETAILS ===== */
    let tripDetails = [];
    if (vo.vehicleOpID) {
        try {
            const rt = await fetch(
                `/api/vehicle-trip-details/operation/${vo.vehicleOpID}`
            );
            if (rt.ok) {
                tripDetails = await rt.json();
            }
        } catch (e) {
            tripDetails = [];
        }
    }

    /* ===== BUILD TRIP LINES ===== */
    const tripsHtml = tripDetails.length
        ? tripDetails.map((t, i) => `
            <div class="trip-line">
                <div class="trip-label">Trip ${i + 1} Detail</div>
                <div class="trip-sep">|</div>
                <div class="trip-values">
                    <span>Sludge Ltrs: <strong>${t.sludgeCollectLtrs ?? "-"}</strong></span>
                    <span>Sludge Kgs: <strong>${t.sludgeCollectKgs ?? "-"}</strong></span>
                    <span>Time: <strong>${t.tripTime ?? "-"}</strong></span>
                </div>
            </div>
        `).join("")
        : `<div class="muted">No trip details</div>`;



                    // render block for this vehicle
                    const html = `
                        <div class="vehicle-title">${escapeHtml(v.vehicleNumber || "Vehicle")} - <span class="muted">${escapeHtml(v.vehicleModelName || "")}</span></div>
                        <table style="margin-top:8px">
                            <tr><th>Vehicle Odometer Reading Morning (Km)</th><td>${vo.vehicleReadingAm ?? "-"}</td></tr>
                            <tr><th>Vehicle Odometer Reading Evening (Km)</th><td>${vo.vehicleReadingPm ?? "-"}</td></tr>
                            <tr><th>Fuel Level (0-6)</th><td>${vo.vehicleFuelLevel ?? "-"}</td></tr>
                            <tr><th>Last Fuel Filled?</th><td>${vo.lastFuelFilled ? "Yes" : "No"}</td></tr>
                            <tr><th>Last Fuel Filled Date</th><td>${vo.lastFuelFilled ? (vo.lastFuelFilledDate ?? "-") : "-"}</td></tr>
                            <tr><th>Fuel Filled (Liters)</th><td>${vo.lastFuelFilled ? (vo.filledLiters ?? "-") : "-"}</td></tr>
                            <tr>
                              <th>No. of Trips</th>
                              <td>
                                <strong>${vo.noOfTrips ?? "-"}</strong>
                                ${tripsHtml}
                              </td>
                            </tr>

                            <tr>
                              <th>Sludge Collected</th>
                              <td>
                                  <div class="sludge-summary">
                                    <span>Ltrs: ${vo.sludgeCollect ?? "-"}</span>
                                    <span>Kgs: ${vo.sludgeCollectKgs ?? "-"}</span>
                                  </div>
                               </td>
                            </tr>

                        </table>
                    `;
                    vehicleOpsDiv.insertAdjacentHTML('beforeend', html);
                }

                // private aggregates (part of PlantOperation response maybe)
                privateAgg.privateVehicle = op.privateVehicle ?? false;
                privateAgg.noOfTripsPrivateVehicle = op.noOfTripsPrivateVehicle ?? null;
                privateAgg.sludgeCollectPrivateVehicle = op.sludgeCollectPrivateVehicle ?? null;

                if (privateAgg.privateVehicle) {
                    try {
                        const rpv = await fetch(
                            `/api/private-vehicles/privateveh/${plantID}?date=${encodeURIComponent(date)}`
                        );
                        pvList = rpv.ok ? await rpv.json() : [];
                    } catch (e) {
                        pvList = [];
                    }
                }


                pvPresentEl.textContent = privateAgg.privateVehicle ? "Yes" : "No";
                pvTripsEl.textContent = (privateAgg.privateVehicle ? (privateAgg.noOfTripsPrivateVehicle ?? "-") : "0");
                pvSludgeEl.textContent = (privateAgg.privateVehicle ? (privateAgg.sludgeCollectPrivateVehicle ?? "-") : "0");
                pvSludgeKgsEl.textContent =privateAgg.privateVehicle ? (op.sludgeCollectPrivateVehicleKgs ?? "-") : "0";


                /* ================= PRIVATE VEHICLE DETAILS ================= */

                let pvDiv = document.getElementById("privateVehicleDetails");
                pvDiv.innerHTML = "";

                if (privateAgg.privateVehicle) {

                    if (pvList.length === 0) {
                        pvDiv.innerHTML = `<div class="muted">No private vehicle details found</div>`;
                    }

                    pvList.forEach((pv, i) => {
                        pvDiv.innerHTML += `
                            <table style="margin-top:10px">
                                <tr><th>Vehicle Number</th><td>${pv.privateVehNumber ?? "-"}</td></tr>
                                <tr><th>Driver Number</th><td>${pv.driverNumber ?? "-"}</td></tr>
                                <tr><th>Driver Name</th><td>${pv.driverName ?? "-"}</td></tr>
                                <tr><th>Sludge Received (Ltrs)</th><td>${pv.receivedSludgeLtrs ?? "-"}</td></tr>
                                <tr><th>Sludge Received (Kgs)</th><td>${pv.receivedSludgeKgs ?? "-"}</td></tr>
                            </table>
                        `;
                    });
                }

                // compute and apply progress
                const pct = computeProgress(op, vehicleOpsList, privateAgg, pvList);
                applyProgressBar(pct);

                // wire update/back/pdf buttons
                updateBtn.onclick = () => {
                    window.location.href = `update-operation.html?plantID=${encodeURIComponent(plantID)}&date=${encodeURIComponent(date)}`;
                };
                backBtn.onclick = () => {
                    window.location.href = `index.html?date=${encodeURIComponent(date)}`;
                };
                pdfBtn.onclick = () => downloadPdf(op, vehicles, vehicleOpsList, plantName);

            } catch (e){
                fieldsBody.innerHTML = `<tr><td colspan="2" style="color:#6b7280">Error loading operation</td></tr>`;
                vehicleOpsDiv.innerHTML = `<div style="color:#6b7280; padding:8px">Error loading vehicles</div>`;
                console.error(e);
            }
        }

        // simple escape to avoid injection when injecting into innerHTML for small strings
        function escapeHtml(txt){
            if (txt === null || txt === undefined) return "";
            return String(txt)
                .replaceAll("&","&amp;")
                .replaceAll("<","&lt;")
                .replaceAll(">","&gt;")
                .replaceAll("\"","&quot;")
                .replaceAll("'","&#39;");
        }

        // PDF generation: create a compact PDF covering plant + operation + vehicles + private aggregates
        async function downloadPdf(op, vehiclesMeta, vehicleOpsList, plantName) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ unit:"pt", format:"a4", orientation:"portrait" });
            const pageW = doc.internal.pageSize.getWidth();
            const margin = 40;
            let y = margin;

            doc.setFontSize(16);
            doc.setFont("helvetica", "bold");
            const title = (plantName ? plantName + " — " : "") + `Plant Operation (${plantID})`;
            doc.text(title, pageW/2, y, { align: "center" });
            y += 22;
            doc.setFontSize(11);
            doc.setFont("helvetica", "normal");
            doc.text(`Operation Date: ${op.operationDate ?? date}`, pageW - margin, margin+2, { align:"right" });
            y += 8;

            // Build rows for autoTable
            const rows = [];
            function addRow(label, value){ rows.push([label, String(value ?? "-")]); }

            // Plant fields order (same as fields array)
            for (const f of fields) {
                addRow(labelMap[f] || f, fmt(f, op[f]));
            }

            // Private aggregates
            addRow("Private Vehicles Present", op.privateVehicle ? "Yes" : "No");
            addRow("Private - No. of Trips", op.privateVehicle ? (op.noOfTripsPrivateVehicle ?? "-") : "0");
            addRow("Private - Sludge (Ltrs)", op.privateVehicle ? (op.sludgeCollectPrivateVehicle ?? "-") : "0");

            // Vehicle sections (list each vehicle and its op)
            for (let i=0;i<vehiclesMeta.length;i++){
                const v = vehiclesMeta[i];
                // header row for vehicle
                rows.push([`Vehicle: ${v.vehicleNumber} (${v.vehicleModelName || ""})`, ""]);
                // try load its op from vehicleOpsList by index if available
                let vo = {};
                // attempt match by vehicleID if vehicleOpsList elements had vehicle id? We didn't store ids there.
                // We'll fetch again quickly to be robust
                try {
                    const r = await fetch(`/api/vehicle-operations/${v.vehicleID}?date=${encodeURIComponent(date)}`);
                    const t = await r.text();
                    vo = (t && t.trim()) ? JSON.parse(t) : {};
                } catch(e){ vo = {}; }
                addRow("Vehicle Reading AM (Km)", vo.vehicleReadingAm ?? "-");
                addRow("Vehicle Reading PM (Km)", vo.vehicleReadingPm ?? "-");
                addRow("Vehicle Fuel Level (0-6 %)", vo.vehicleFuelLevel ?? "-");
                addRow("Last Fuel Filled?", vo.lastFuelFilled ? "Yes" : "No");
                addRow("Last Fuel Filled Date", vo.lastFuelFilled ? (vo.lastFuelFilledDate ?? "-") : "-");
                addRow("No. of Trips", vo.noOfTrips ?? "-");
                addRow("Sludge Collect (Ltrs)", vo.sludgeCollect ?? "-");
                addRow("Sludge Collect (Kgs)", vo.sludgeCollectKgs ?? "-");
            }

            doc.autoTable({
                startY: y,
                head: [["Field","Value"]],
                body: rows,
                styles: { fontSize: 10, cellPadding: 6 },
                headStyles: { fillColor: [3,105,161], textColor: [255,255,255], fontStyle: "bold" },
                columnStyles: { 0: { cellWidth: 220 }, 1: { cellWidth: pageW - margin*2 - 220 } },
                theme: "grid",
                didDrawPage: function (data) {
                    // nothing extra
                }
            });

            doc.save(`Plant_${plantName || plantID}_Operation_${date}.pdf`);
        }

        // Simple SSE refresh (throttled)
        let sseCooldown = false;
        function startSSE(){
            try {
                const es = new EventSource("/api/events/updates");
                es.onmessage = () => {
                    if (sseCooldown) return;
                    sseCooldown = true;
                    loadAll();
                    setTimeout(()=> sseCooldown = false, 1000);
                };
                es.onerror = ()=> setTimeout(startSSE, 2000);
            } catch(e){}
        }

        // initial load
        loadAll();
        startSSE();

    })();
</script>
</body>
</html>
