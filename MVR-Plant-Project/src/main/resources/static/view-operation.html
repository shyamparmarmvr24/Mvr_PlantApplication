<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="https://mvrtech.org/MVR_Company_Logo%20copy.png">
    <title>View Operation</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>



    <style>
        body {
            font-family:'Segoe UI', sans-serif;
            background:#eef2f7;
            margin:0;
            padding:0;
            display:flex;
            justify-content:center;
        }

        .card {
            background:white;
            padding:26px;
            border-radius:12px;
            box-shadow:0 10px 25px rgba(0,0,0,0.08);
            max-width:900px;
            width:100%;
            margin:20px;
        }

        h2 {
            text-align:center;
            margin-bottom:8px;
            color:#0369a1;
        }

        .top-info {
            font-weight:700;
            text-align:center;
            margin-bottom:16px;
            color:#374151;
        }

        table {
            width:100%;
            border-collapse:collapse;
            margin-top:10px;
        }

        table th, table td {
            border:1px solid #d9e2ec;
            padding:10px;
            font-size:15px;
        }

        table th {
            background:#0369a1;
            color:white;
            text-align:left;
            width:260px;
        }

        .progress-bar {
            width:240px;
            height:18px;
            background:#e5edf5;
            margin:12px auto;
            border-radius:10px;
            overflow:hidden;
        }

        .progress-fill {
            height:100%;
            width:0;
            transition:width 0.25s ease-out;
        }

        .progress-green { background:#10b981; }
        .progress-yellow { background:#f59e0b; }
        .progress-red { background:#ef4444; }

        .vehicle-title {
            margin-top:18px;
            font-size:17px;
            font-weight:700;
            color:#0f172a;
        }

        .buttons {
            margin-top:20px;
            text-align:center;
        }

        .btn {
            padding:10px 18px;
            font-size:15px;
            border:none;
            border-radius:6px;
            color:white;
            cursor:pointer;
            margin:0 6px;
        }

        .btn-update { background:#059669; }
        .btn-back { background:#6b7280; }

        /* Prevent table rows from splitting across PDF pages */
table, tr, td, th {
    page-break-inside: avoid !important;
}

/* Keep the whole card together unless it's too long */
.card {
    page-break-inside: avoid !important;
}

/* Page break BEFORE vehicle section if too long */
.vehicle-section {
    page-break-before: always;
}

/* Make PDF look tighter */
.pdf-scale {
    transform: scale(0.85);
    transform-origin: top left;
}

    </style>
</head>

<body>

<div class="card">

    <h2>Operation Details</h2>
    <div class="top-info" id="infoBox"></div>

    <div style="text-align:center;">
        <div class="progress-bar">
            <div id="progressFill" class="progress-fill"></div>
        </div>
        <div id="progressText" style="font-weight:700; margin-bottom:14px;"></div>
    </div>

    <table>
        <thead>
        <tr><th>Field</th><th>Value</th></tr>
        </thead>
        <tbody id="fieldsBody"></tbody>
    </table>

    <!-- Vehicle operations section (dynamic, repeated blocks per vehicle) -->
    <h2 style="margin-top:22px;">Vehicle Operations</h2>
    <div id="vehicleOps"></div>

    <div class="buttons">
        <button class="btn btn-update" id="updateBtn">Update</button>
        <button class="btn btn-back" id="backBtn">Back</button>
        <button class="btn" style="background:#2563eb;" id="pdfBtn">Download PDF</button>
    </div>

</div>

<script>

    const params = new URLSearchParams(window.location.search);
    const plantID = params.get('plantID');
    const date = params.get('date');

    document.getElementById("infoBox").innerHTML =
        `Date: <span style="color:#f97316">${date}</span> &nbsp; | &nbsp;
         Plant ID: <span style="color:#059669">${plantID}</span>`;

    document.getElementById("backBtn").onclick = () =>
        window.location.href = `index.html?date=${encodeURIComponent(date)}`;

    // ---------------------- FIELD ORDER ----------------------
    // Note: vehicleReadingAm/vehicleReadingPm/vehicleFuelLevel REMOVED from this list
    const fields = [
        "operationDate",
        "sludgeTankLevelAm",
        "sludgeTankLevelPm",
        "sludgeReceived",
        "noOfTrips",
        "sludgeProcessed",
        "biocharProduced",
        "plantRunningHrs",
        "solarIntegration",

        "powerReadingAmImport",
        "powerReadingAmExport",
        "powerReadingPmImport",
        "powerReadingPmExport",

        "powerReadingAm",
        "powerReadingPm",

        "powerConsumed",
        "dgReadingAm",
        "dgReadingPm",
        "dgDiesalPercentageAm",
        "dgDiesalPercentagePm",

        "dgRunHours",

        // vehicle fields removed here intentionally

        "polymerUsage",
        "pillets",

        "remarks"
    ];

    const fieldsBody = document.getElementById("fieldsBody");

    // ---------------------- UNITS MAP ----------------------
    const units = {
        sludgeTankLevelAm: "liters",
        sludgeTankLevelPm: "liters",
        sludgeReceived: "liters",
        sludgeProcessed: "liters",
        biocharProduced: "kgs",
        noOfTrips: "",
        plantRunningHrs: "",
        powerReadingAmImport: "kwh",
        powerReadingAmExport: "kwh",
        powerReadingPmImport: "kwh",
        powerReadingPmExport: "kwh",
        powerReadingAm: "kwh",
        powerReadingPm: "kwh",
        powerConsumed: "kwh",
        dgReadingAm: "",
        dgReadingPm: "",
        dgRunHours: "",
        dgDiesalPercentageAm: "%",
        dgDiesalPercentagePm: "%",
        // vehicleReadingAm/vehicleReadingPm/vehicleFuelLevel removed from units map usage
        polymerUsage: "grams",
        pillets: "kgs",
        remarks: ""
    };

    // ---------------------- TIME FORMATTER ----------------------
    function formatTimeDecimal(value) {
        if (value === null || value === undefined || value === "" || isNaN(value)) return "-";

        const hours = Math.floor(value);
        const minutes = Math.round((value - hours) * 100);

        let parts = [];
        if (hours > 0) parts.push(`${hours} hour${hours > 1 ? "s" : ""}`);
        if (minutes > 0) parts.push(`${minutes} minutes`);

        return parts.join(" ");
    }

    // ---------------------- VALUE FORMATTER ----------------------
    function formatValue(field, value) {

        if (value === null || value === "" || value === undefined)
            return "-";

        if (field === "solarIntegration")
            return value ? "Yes" : "No";

        if (["plantRunningHrs", "dgReadingAm", "dgReadingPm", "dgRunHours"].includes(field))
            return formatTimeDecimal(parseFloat(value));

        if (units[field] === "%")
            return `${value} %`;

        if (units[field])
            return `${value} ${units[field]}`;

        return value;
    }

    // ---------------------- PROGRESS FIELDS (EXCLUDES VEHICLE FIELDS) ----------------------
    // removed vehicleReadingAm/vehicleReadingPm/vehicleFuelLevel from baseProgressFields
    const baseProgressFields = [
        "sludgeTankLevelAm","sludgeTankLevelPm","sludgeReceived","noOfTrips",
        "sludgeProcessed","biocharProduced","plantRunningHrs","solarIntegration",
        "dgReadingAm","dgReadingPm","dgDiesalPercentageAm","dgDiesalPercentagePm",
        "polymerUsage","pillets"
    ];

    function calculateProgress(op) {

        let fieldsToCheck = [...baseProgressFields];

        // Solar Yes → use IMPORT/EXPORT fields
        if (op.solarIntegration === true) {
            fieldsToCheck.push(
                "powerReadingAmImport",
                "powerReadingAmExport",
                "powerReadingPmImport",
                "powerReadingPmExport"
            );
        }
        // Solar No → use normal AM/PM fields
        else {
            fieldsToCheck.push(
                "powerReadingAm",
                "powerReadingPm"
            );
        }

        // Count filled plant fields
        let filled = 0;
        fieldsToCheck.forEach(f => {
            if (op[f] !== null && op[f] !== "" && op[f] !== undefined)
                filled++;
        });

        const total = fieldsToCheck.length;
        return total === 0 ? 0 : Math.round((filled / total) * 100);
    }

    function applyProgressBar(progress) {
        const bar = document.getElementById("progressFill");

        bar.className =
            progress === 100 ? "progress-fill progress-green" :
            progress > 0     ? "progress-fill progress-yellow" :
                               "progress-fill progress-red";

        bar.style.width = progress + "%";
        document.getElementById("progressText").textContent = progress + "% Completed";
    }

    // ---------------------- LOAD OPERATION ----------------------
    async function loadOperation() {
        const res = await fetch(`/api/operations/plant/${plantID}?date=${date}`);
        const text = await res.text();

        let op = {};
        if (text.trim()) op = JSON.parse(text);

        fieldsBody.innerHTML = "";

        fields.forEach(f => {
            let label = f.replace(/([A-Z])/g, " $1")
                         .replace(/^./, c => c.toUpperCase());
            let value = formatValue(f, op[f]);

            const tr = document.createElement("tr");
            tr.innerHTML = `<td>${label}</td><td>${value}</td>`;
            fieldsBody.appendChild(tr);
        });

        const progress = calculateProgress(op);
        applyProgressBar(progress);

        // load vehicles after plant fields are rendered
        loadVehicleOps();

        // update button binding (keeps same redirection logic)
        document.getElementById("updateBtn").onclick = () =>
            window.location.href =
                `update-operation.html?plantID=${plantID}&date=${encodeURIComponent(date)}`;
    }

    // ---------------------- LOAD VEHICLE OPERATIONS ----------------------
    async function loadVehicleOps() {

        const container = document.getElementById("vehicleOps");
        container.innerHTML = "";

        try {
            const vehRes = await fetch(`/api/vehicle-operations/plant/${plantID}/vehicles`);
            if (!vehRes.ok) {
                container.innerHTML = `<div style="color:#6b7280; padding:10px;">No vehicles found</div>`;
                return;
            }
            const vehicles = await vehRes.json();

            for (const v of vehicles) {
                // fetch operation for this vehicle
                let op = {};
                try {
                    const opRes = await fetch(`/api/vehicle-operations/${v.vehicleID}?date=${date}`);
                    const text = await opRes.text();
                    if (text.trim()) op = JSON.parse(text);
                } catch (e) {
                    op = {};
                }

                container.innerHTML += `
                    <div class="vehicle-title">${v.vehicleNumber} - ${v.vehicleModelName}</div>

                    <table>
                        <tr><th>Vehicle Reading AM</th><td>${op.vehicleReadingAm ?? "-"}</td></tr>
                        <tr><th>Vehicle Reading PM</th><td>${op.vehicleReadingPm ?? "-"}</td></tr>
                        <tr><th>Fuel Level</th><td>${op.vehicleFuelLevel ?? "-"}</td></tr>
                    </table>
                `;
            }

        } catch (e) {
            container.innerHTML = `<div style="color:#6b7280; padding:10px;">Error loading vehicles</div>`;
        }
    }

    // ---------------------- SSE AUTO REFRESH ----------------------
    function startSSE() {
        try {
            const evt = new EventSource("/api/events/updates");
            evt.onmessage = () => loadOperation();
            evt.onerror = () => setTimeout(startSSE, 2000);
        } catch (e) {
            // ignore SSE if not available
        }
    }

document.getElementById("pdfBtn").onclick = () => {

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: "portrait", unit: "pt", format: "a4" });

    const title = `Operation Details`;
    const info = `Date: ${date}    |    Plant ID: ${plantID}`;

    // Title
    doc.setFontSize(18);
    doc.setTextColor(30, 80, 160);
    doc.text(title, 40, 40);

    // Subtitle
    doc.setFontSize(12);
    doc.setTextColor(0, 0, 0);
    doc.text(info, 40, 60);

    // ----------------------------
    // Extract TABLE DATA
    // ----------------------------
    const rows = [];
    document.querySelectorAll("#fieldsBody tr").forEach(tr => {
        const cols = tr.querySelectorAll("td");
        rows.push([cols[0].innerText, cols[1].innerText]);
    });

    // ----------------------------
    // Add Table to PDF
    // ----------------------------
    doc.autoTable({
        head: [["Field", "Value"]],
        body: rows,
        startY: 90,
        theme: 'grid',
        headStyles: { fillColor: [3, 105, 161], halign: "left" },
        styles: { fontSize: 10, cellPadding: 5 },
        columnStyles: {
            0: { cellWidth: 180 },
            1: { cellWidth: 330 }
        }
    });

    // ----------------------------
    // Vehicle Operations Section
    // ----------------------------
    let y = doc.lastAutoTable.finalY + 30;

    doc.setFontSize(15);
    doc.text("Vehicle Operations", 40, y);
    y += 10;

    const vehicleBlocks = document.querySelectorAll("#vehicleOps table");
    const vehicleTitles = document.querySelectorAll(".vehicle-title");

    vehicleBlocks.forEach((table, index) => {
        const rowsVeh = [];

        table.querySelectorAll("tr").forEach(tr => {
            const td = tr.querySelectorAll("td");
            rowsVeh.push([tr.querySelector("th").innerText, td[0].innerText]);
        });

        doc.autoTable({
            head: [[vehicleTitles[index].innerText, ""]],
            body: rowsVeh,
            startY: doc.lastAutoTable.finalY + 10,
            theme: 'grid',
            headStyles: { fillColor: [15, 23, 42], halign: "left" },
            styles: { fontSize: 10, cellPadding: 5 },
            columnStyles: { 0: { cellWidth: 200 }, 1: { cellWidth: 300 } }
        });
    });

    doc.save(`Plant_${plantID}_Operation_${date}.pdf`);
};



startSSE();
    loadOperation();


</script>

</body>
</html>
