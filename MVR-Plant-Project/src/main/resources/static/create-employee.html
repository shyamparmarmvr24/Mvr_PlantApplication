<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="mvrlogo.png">
    <title>Create Employee - MVR TECHNOLOGY</title>

    <style>
        body {
            margin: 0;
            font-family: "Segoe UI", sans-serif;
            background: #f5f7fa;
        }

        header {
            background: linear-gradient(90deg, #0f172a, #0ea5e9);
            padding: 15px 20px;
            color: white;
            font-size: 22px;
            font-weight: 700;
            text-align: center;
            letter-spacing: 1px;
        }

        .container {
            max-width: 650px;
            margin: 40px auto;
            background: white;
            border-radius: 10px;
            padding: 28px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        h2 {
            text-align: center;
            margin-bottom: 25px;
            color: #0f172a;
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            color: #333;
        }

        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 15px;
        }

        .btn-submit {
            width: 100%;
            padding: 12px;
            background: #0ea5e9;
            border: none;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 17px;
            margin-top: 10px;
        }

        .btn-submit:hover {
            background: #0284c7;
        }

        .back-btn {
            display: inline-block;
            margin-top: 15px;
            text-align: center;
            width: 100%;
            padding: 12px;
            background: #6b7280;
            color: white;
            border-radius: 6px;
            text-decoration: none;
        }
        .form-table {
    width: 100%;
    border-collapse: collapse;
}

.form-table td {
    padding: 10px;
    vertical-align: middle;
}

.form-table td:first-child {
    width: 35%;
    font-weight: 600;
    color: #374151;
}

.form-table input,
.form-table select {
    width: 100%;
    padding: 9px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 14px;
}

.form-table tr:nth-child(even) {
    background-color: #f9fafb;
}

/* BUTTONS */
.btn-row {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-top: 20px;
}

.btn-submit-small {
    padding: 8px 18px;
    background: #16a34a;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
}

.btn-submit-small:hover {
    background: #15803d;
}

.btn-back-small {
    padding: 8px 18px;
    background: #6b7280;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
}

.btn-back-small:hover {
    background: #4b5563;
}
        .form-table select {
    background-color: #fff;
    cursor: pointer;
}
input[type=number]::-webkit-inner-spin-button,
input[type=number]::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
}
input[type=number] {
    -moz-appearance: textfield;
}


    </style>
</head>

<body>

<header>Create Employee</header>

<div class="container">

    <h2>Add New Employee</h2>

    <form id="empForm">

        <table class="form-table">
            <tr>
                <td><label>Employee ID *</label></td>
                <td><input type="number" id="employeeId" required></td>
            </tr>

            <tr>
                <td><label>Employee Name *</label></td>
                <td><input type="text" id="employeeName" required></td>
            </tr>

            <tr>
                <td><label>Designation *</label></td>
                <td>
                    <select id="designation" required>
                        <option value="">-- Select Designation --</option>
                        <option value="Supervisor">Supervisor</option>
                        <option value="Operator">Operator</option>
                        <option value="Helper">Helper</option>
                        <option value="Driver">Driver</option>
                        <option value="Security Guard">Security Guard</option>
                    </select>
                </td>
            </tr>

            <tr>
                <td><label>Mobile Number *</label></td>
                <td><input type="number" id="mobileNo" required></td>
            </tr>

            <tr>
                <td><label>Alternate Number</label></td>
                <td><input type="number" id="alternateMobNo" placeholder="Optional (10 digits)"></td>
            </tr>

            <tr>
                <td><label>Address *</label></td>
                <td><input type="text" id="address" required></td>
            </tr>

            <tr>
                <td><label>Date of Birth *</label></td>
                <td><input type="date" id="dateOfBirth" required></td>
            </tr>

            <tr>
                <td><label>Date of Joining *</label></td>
                <td><input type="date" id="dateOfJoining" required></td>
            </tr>

            <tr class="driver-only" style="display:none;">
                <td><label>Licence Type *</label></td>
                <td>
                    <select id="licenceType">
                        <option value="">-- Select Licence Type --</option>
                        <option value="Heavy">Heavy</option>
                        <option value="Light">Light</option>
                    </select>
                </td>
            </tr>

            <tr class="driver-only" style="display:none;">
                <td><label>Licence Number *</label></td>
                <td><input type="text" id="licenceNumber"></td>
            </tr>

            <tr class="driver-only" style="display:none;">
                <td><label>Licence Issue Date *</label></td>
                <td><input type="date" id="licenceIssueDate"></td>
            </tr>

            <tr class="driver-only" style="display:none;">
                <td><label>Licence Expiry Date *</label></td>
                <td><input type="date" id="licenceExpiryDate"></td>
            </tr>

        </table>

        <div class="btn-row">
            <button type="submit" class="btn-submit-small">Submit</button>
            <button type="button" class="btn-back-small" onclick="goBack()">Back</button>
        </div>

    </form>

</div>

<script>

    const plantID = new URLSearchParams(window.location.search).get("plantID");
    const FORM_KEY = "createEmployeeForm";


    // -------------------------------------------------------
    // DISABLE FUTURE DATES FOR DOB & DOJ
    // -------------------------------------------------------
    const today = new Date().toISOString().split("T")[0];

    document.getElementById("dateOfBirth").setAttribute("max", today);
    document.getElementById("dateOfJoining").setAttribute("max", today);
    // Disable future dates for Licence Issue Date ONLY
    document.getElementById("licenceIssueDate").setAttribute("max", today);

    document.getElementById("dateOfBirth").addEventListener("change", () => {
    const dob = document.getElementById("dateOfBirth").value;
    if (dob) {
        document.getElementById("licenceIssueDate").setAttribute("min", dob);
    }
});

function goBack() {
    sessionStorage.removeItem(FORM_KEY); // clear draft
    history.back();
}


// ---------------------------------------------
// SAVE FORM DATA TO SESSION (AUTOSAVE)
// ---------------------------------------------
function saveDraft() {
    const data = {};
    document.querySelectorAll("input, select").forEach(el => {
        if (el.id) data[el.id] = el.value;
    });
    sessionStorage.setItem(FORM_KEY, JSON.stringify(data));
}

document.querySelectorAll("input, select").forEach(el => {
    el.addEventListener("input", saveDraft);
    el.addEventListener("change", saveDraft);
});



    // -------------------------------------------------------
    // AUTOSAVE FORM ON INPUT
    // -------------------------------------------------------

    const designationSelect = document.getElementById("designation");
const driverFields = document.querySelectorAll(".driver-only");

function toggleDriverFields() {
    const isDriver = designationSelect.value === "Driver";

    driverFields.forEach(row => {
        row.style.display = isDriver ? "table-row" : "none";
    });

    if (!isDriver) {
        ["licenceType", "licenceNumber", "licenceIssueDate", "licenceExpiryDate"]
            .forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = "";
            });

        // reset min/max when not driver
        document.getElementById("licenceIssueDate").removeAttribute("min");
    }
}


   // ---------------------------------------------
// LOAD FORM DATA ON PAGE LOAD
// ---------------------------------------------
function loadDraft() {
    const draft = sessionStorage.getItem(FORM_KEY);
    if (!draft) return;

    const data = JSON.parse(draft);
    for (const key in data) {
        const el = document.getElementById(key);
        if (el) el.value = data[key];
    }
}

loadDraft();

  toggleDriverFields();

  designationSelect.addEventListener("change", toggleDriverFields);


    // -------------------------------------------------------
    // FRONTEND VALIDATION
    // -------------------------------------------------------
    function validateFields() {
        const id = document.getElementById("employeeId").value.trim();
        const name = document.getElementById("employeeName").value.trim();
        const des = document.getElementById("designation").value.trim();
        const mob = document.getElementById("mobileNo").value.trim();
        const altMob = document.getElementById("alternateMobNo").value.trim();
        const addr = document.getElementById("address").value.trim();
        const dob = document.getElementById("dateOfBirth").value;
        const doj = document.getElementById("dateOfJoining").value;

        if (!id || isNaN(id)) return "Employee ID must be a valid number.";
        if (!name) return "Employee name is required.";
        if (!des) return "Designation is required.";
        if (!/^\d{10}$/.test(mob)) return "Mobile number must be exactly 10 digits.";
        if (altMob && !/^\d{10}$/.test(altMob)) return "Alternate number must be exactly 10 digits.";
        if (!addr) return "Address is required.";
        if (!dob) return "Date of birth is required.";
        if (!doj) return "Date of joining is required.";

        if (des === "Driver") {
            const lt = document.getElementById("licenceType").value;
            const ln = document.getElementById("licenceNumber").value.trim();
            const lid = document.getElementById("licenceIssueDate").value;
            const led = document.getElementById("licenceExpiryDate").value;

            if (!lt) return "Licence type is required for Driver.";
            if (!ln) return "Licence number is required for Driver.";
            if (!lid) return "Licence issue date is required for Driver.";
            if (!led) return "Licence expiry date is required for Driver.";

            if (new Date(lid) > new Date())
                return "Licence issue date cannot be in the future.";

            if (new Date(led) <= new Date(lid))
                return "Licence expiry date must be after issue date.";
        }


        if (new Date(doj) < new Date(dob))
            return "Date of Joining cannot be earlier than Date of Birth.";

        return null; // valid
    }


    // -------------------------------------------------------
    // FORM SUBMIT
    // -------------------------------------------------------
    document.getElementById("empForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        // Client-side validation
        const error = validateFields();
        if (error) {
            alert("❌ " + error);
            return;
        }

        const data = {
            employeeId: document.getElementById("employeeId").value,
            employeeName: document.getElementById("employeeName").value,
            designation: document.getElementById("designation").value,
            mobileNo: document.getElementById("mobileNo").value,
            alternateMobNo: document.getElementById("alternateMobNo").value || null,
            address: document.getElementById("address").value,
            dateOfBirth: document.getElementById("dateOfBirth").value,
            dateOfJoining: document.getElementById("dateOfJoining").value,
            licenceType: document.getElementById("licenceType")?.value || null,
            licenceNumber: document.getElementById("licenceNumber")?.value || null,
            licenceIssueDate: document.getElementById("licenceIssueDate")?.value || null,
            licenceExpiryDate: document.getElementById("licenceExpiryDate")?.value || null
        };

        let res;
        try {
            res = await fetch(`/api/plantemployees/create/${plantID}`, {
                method: "POST",
                headers: { "Content-Type": "application/json"},
                body: JSON.stringify(data)
            });
        } catch (networkErr) {
            alert("❌ Network error — please check your internet connection.");
            return;
        }

        // -------------------------------------------------------
        // HANDLE BACKEND ERRORS (400, duplicate, JSON, etc.)
        // -------------------------------------------------------
        if (!res.ok) {
            let message = "❌ Failed to create employee.";

            try {
                const err = await res.json();
                if (err.message) message = "❌ " + err.message;
            } catch {
                // if server sends plain text
                const t = await res.text();
                message = "❌ " + t;
            }

            alert(message);
            return;
        }

        // SUCCESS
        alert("✔ Employee created successfully!");

        // clear session data ONLY after submit
        sessionStorage.removeItem(FORM_KEY);

        window.location.href = `view-employees.html?plantID=${plantID}`;
    });

</script>


</body>
</html>
