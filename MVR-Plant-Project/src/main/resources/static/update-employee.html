<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Update Employee - MVR TECHNOLOGY</title>

    <style>
        body {
            margin: 0;
            font-family: "Segoe UI", sans-serif;
            background: #f5f7fa;
        }

        header {
            background: linear-gradient(90deg, #0f172a, #0ea5e9);
            padding: 15px;
            color: white;
            font-size: 22px;
            font-weight: 700;
            text-align: center;
        }

        .container {
            max-width: 650px;
            margin: 40px auto;
            background: white;
            border-radius: 10px;
            padding: 28px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        h2 {
            text-align: center;
            margin-bottom: 25px;
            color: #0f172a;
        }

        .form-table {
            width: 100%;
            border-collapse: collapse;
        }

        .form-table td {
            padding: 10px;
        }

        .form-table td:first-child {
            width: 35%;
            font-weight: 600;
        }

        .form-table input,
        .form-table select {
            width: 100%;
            padding: 9px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-table tr:nth-child(even) {
            background: #f9fafb;
        }

        .btn-row {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .btn-save {
            padding: 8px 20px;
            background: #16a34a;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .btn-back {
            padding: 8px 20px;
            background: #6b7280;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
    </style>
</head>

<body>

<header>Update Employee</header>

<div class="container">
    <h2>Edit Employee Details</h2>

    <table class="form-table">

        <tr>
            <td>Employee ID</td>
            <td><input id="employeeId" disabled></td>
        </tr>

        <tr>
            <td>Employee Name *</td>
            <td><input id="employeeName"></td>
        </tr>

        <tr>
            <td>Designation *</td>
            <td>
                <select id="designation">
                    <option value="">-- Select Designation --</option>
                    <option>Supervisor</option>
                    <option>Operator</option>
                    <option>Helper</option>
                    <option>Driver</option>
                    <option>Security Guard</option>
                </select>
            </td>
        </tr>

        <tr>
            <td>Mobile Number *</td>
            <td><input id="mobileNo"></td>
        </tr>

        <tr>
            <td>Alternate Number</td>
            <td><input id="alternateMobNo"></td>
        </tr>

        <tr>
            <td>Address *</td>
            <td><input id="address"></td>
        </tr>

        <tr>
            <td>Date of Birth *</td>
            <td><input type="date" id="dateOfBirth"></td>
        </tr>

        <tr>
            <td>Date of Joining *</td>
            <td><input type="date" id="dateOfJoining"></td>
        </tr>

        <tr class="driver-only" style="display:none;">
            <td>Licence Type *</td>
            <td>
                <select id="licenceType">
                    <option value="">-- Select Licence --</option>
                    <option>Heavy</option>
                    <option>Light</option>
                </select>
            </td>
        </tr>

        <tr class="driver-only" style="display:none;">
            <td>Licence Number *</td>
            <td><input id="licenceNumber"></td>
        </tr>

        <tr class="driver-only" style="display:none;">
            <td>Licence Issue Date *</td>
            <td><input type="date" id="licenceIssueDate"></td>
        </tr>

        <tr class="driver-only" style="display:none;">
            <td>Licence Expiry Date *</td>
            <td><input type="date" id="licenceExpiryDate"></td>
        </tr>

    </table>

    <div class="btn-row">
        <button class="btn-save" onclick="updateEmployee()">Save</button>
        <button class="btn-back" onclick="history.back()">Back</button>
    </div>
</div>

<script>
    const params = new URLSearchParams(location.search);
    const plantID = params.get("plantID");
    const empID = params.get("employeeId");

    const today = new Date().toISOString().split("T")[0];
    ["dateOfBirth","dateOfJoining","licenceIssueDate"]
    .forEach(id => document.getElementById(id)?.setAttribute("max", today));

    const driverRows = document.querySelectorAll(".driver-only");
    const designation = document.getElementById("designation");

    designation.addEventListener("change", toggleDriver);

    function toggleDriver() {
        const isDriver = designation.value === "Driver";
        driverRows.forEach(r => r.style.display = isDriver ? "table-row" : "none");
        if (!isDriver) {
            ["licenceType","licenceNumber","licenceIssueDate","licenceExpiryDate"]
            .forEach(id => document.getElementById(id).value = "");
        }
    }

    // LOAD DATA
    (async () => {
        const res = await fetch(`/api/plantemployees/plant/${plantID}`);
        const list = await res.json();
        const emp = list.find(e => String(e.employeeId) === empID);

        employeeId.value = emp.employeeId;
        employeeName.value = emp.employeeName;
        designation.value = emp.designation;
        mobileNo.value = emp.mobileNo;
        alternateMobNo.value = emp.alternateMobNo ?? "";
        address.value = emp.address;
        dateOfBirth.value = emp.dateOfBirth ?? "";
        dateOfJoining.value = emp.dateOfJoining ?? "";

        licenceType.value = emp.licenceType ?? "";
        licenceNumber.value = emp.licenceNumber ?? "";
        licenceIssueDate.value = emp.licenceIssueDate ?? "";
        licenceExpiryDate.value = emp.licenceExpiryDate ?? "";

        toggleDriver();
    })();

    async function updateEmployee() {

        if (!/^\d{10}$/.test(mobileNo.value)) {
            alert("Mobile number must be 10 digits");
            return;
        }

        if (alternateMobNo.value && !/^\d{10}$/.test(alternateMobNo.value)) {
            alert("Alternate number must be 10 digits");
            return;
        }

        const payload = {
            employeeName: employeeName.value,
            designation: designation.value,
            mobileNo: Number(mobileNo.value),
            alternateMobNo: alternateMobNo.value ? Number(alternateMobNo.value) : null,
            address: address.value,
            dateOfBirth: dateOfBirth.value,
            dateOfJoining: dateOfJoining.value,
            licenceType: licenceType.value || null,
            licenceNumber: licenceNumber.value || null,
            licenceIssueDate: licenceIssueDate.value || null,
            licenceExpiryDate: licenceExpiryDate.value || null
        };

        const res = await fetch(`/api/plantemployees/update/${plantID}/${empID}`, {
            method: "PUT",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(payload)
        });

        if (!res.ok) {
            alert("Update failed");
            return;
        }

        alert("Employee updated successfully");
        location.href = `view-employees.html?plantID=${plantID}`;
    }
</script>

</body>
</html>
