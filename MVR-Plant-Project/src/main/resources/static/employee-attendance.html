<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="https://mvrtech.org/MVR_Company_Logo%20copy.png">

    <title>MVR TECHNOLOGY - Plant Management Dashboard</title>

    <style>
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            margin:0; padding:0;
            background:#f5f7fa;
            color:#222;
        }

        header {
            position: sticky;
            top: 0;
            z-index: 999;
            display:flex;
            justify-content:space-between;
            align-items:center;
            background: linear-gradient(90deg,#0f172a,#0ea5e9);
            padding:14px 20px;
            color:#fff;
            gap:12px;
        }

        .logo-left {
            display:flex;
            align-items:center;
            gap:12px;
            cursor:pointer;
        }

        .logo-left img { height:28px; }

        .logo-left .brand {
            font-family: "Times New Roman", serif !important;
            font-size:25px;
            font-weight:700;
        }

        .date-picker { display:flex; align-items:center; gap:8px; }
        .date-picker label { font-weight:600; color:#fff; }
        .date-picker input[type="date"]{
            padding:6px 10px;
            border-radius:6px;
            border:1px solid #ddd;
            background:#fff;
            color:#000;
            font-size:15px;
            cursor:pointer;
        }

        .dashboard-title {
            text-align:center;
            margin:18px auto 6px;
            font-size:26px;
            color:#0f172a;
            font-weight:700;
            font-family:"Times New Roman", serif !important;
        }

        .container {
            max-width:1100px;
            margin:8px auto 40px;
            padding:0 16px;
        }

        .search-section {
            display:flex;
            gap:12px;
            flex-wrap:wrap;
            margin-bottom:18px;
            align-items:center;
        }

        .search-box { flex:1; min-width:180px; display:flex; }

        .search-box input {
            flex:1;
            padding:10px;
            border:1px solid #ccc;
            border-radius:6px 0 0 6px;
            font-size:15px;
        }

        .search-box button {
            padding:10px 16px;
            border:none;
            background:#0369a1;
            color:white;
            font-size:15px;
            border-radius:0 6px 6px 0;
            cursor:pointer;
        }

        .addBtn {
            padding:10px 16px;
            background:#059669;
            color:white;
            border:none;
            border-radius:6px;
            font-size:15px;
            cursor:pointer;
        }

        table {
            width:100%;
            border-collapse:collapse;
            background:white;
            border-radius:8px;
            overflow:hidden;
            box-shadow:0 4px 12px rgba(2,6,23,0.06);
            table-layout: fixed;
        }

        thead {
            display:table;
            width:100%;
            table-layout:fixed;
        }

        tbody {
            display:block;
            max-height: calc(100vh - 260px);
            overflow-y:auto;
            width:100%;
        }

        tbody tr {
            display:table;
            width:100%;
            table-layout:fixed;
        }

        th, td {
            padding:14px 12px;
            text-align:center;
            border-bottom:1px solid #f1f5f9;
            white-space: nowrap;
        }

        th:nth-child(1), td:nth-child(1) { width: 8%; }
        th:nth-child(2), td:nth-child(2) { width: 12%; }
        th:nth-child(3), td:nth-child(3) { width: 22%; }
        th:nth-child(4), td:nth-child(4) { width: 12%; }
        th:nth-child(5), td:nth-child(5) { width: 10%; }
        th:nth-child(6), td:nth-child(6) { width: 14%; }

        th {
            background:#0369a1;
            color:white;
            font-weight:600;
            text-transform:uppercase;
            font-size:13px;
        }

        tr:nth-child(even){ background:#fbfdff; }

        tr:hover { background:#f0f9ff; }

        .btn-view {
    padding: 8px 12px;
    background:#10b981;
    color:white;
    border:none;
    border-radius: 6px;
    cursor:pointer;
    font-weight:600;
    min-width:120px;
}

.btn-create {
    padding: 8px 12px;
    background:#3b82f6;
    color:white;
    border:none;
    border-radius: 6px;
    cursor:pointer;
    font-weight:600;
    margin-left:6px;
    min-width:120px;
}

    </style>
</head>

<body>

<header>
    <div class="logo-left" onclick="redirectHome()">
        <img src="https://mvrtech.org/MVR_Company_Logo%20copy.png" alt="MVR Logo" />
        <div class="brand">MVR TECHNOLOGY</div>
    </div>

    <div class="date-picker">
        <label for="reportDate">Date:</label>
        <input type="date" id="reportDate" />
    </div>
</header>

<div class="dashboard-title">Employee Attendance Dashboard</div>

<div class="container">

    <div class="search-section">
        <div class="search-box">
            <input type="number" id="plantIDInput" placeholder="Search by Plant ID" min="1" />
            <button id="searchIdBtn">Search</button>
        </div>

        <div class="search-box">
            <input type="number" id="zoneInput" placeholder="Search by Zone" min="1" />
            <button id="searchZoneBtn">Search</button>
        </div>

        <button class="addBtn" id="resetBtn" style="background:#6b7280;">Reset</button>
    </div>

    <table>
        <thead>
        <tr>
            <th>S.No</th>
            <th>Plant ID</th>
            <th>Name</th>
            <th>KLD</th>
            <th>Zone</th>
            <th>Action</th>
        </tr>
        </thead>

        <tbody id="plantTableBody">
        <tr><td colspan="6" class="no-data">Loading...</td></tr>
        </tbody>
    </table>

</div>

<script>

    const plantTableBody = document.getElementById("plantTableBody");
    const reportDateInput = document.getElementById("reportDate");

    const today = new Date().toISOString().split("T")[0];
    reportDateInput.max = today;

    const urlDate = new URLSearchParams(window.location.search).get("date");
    reportDateInput.value = (urlDate && urlDate <= today) ? urlDate : today;

    let allPlants = [];
    let originalPlants = [];

    let filterType = null;
    let filterValue = null;

    // ---------------- FETCH PLANTS ---------------- //
    async function fetchPlants() {
        plantTableBody.innerHTML = `<tr><td colspan="6" class="no-data">Refreshing...</td></tr>`;
        try {
            const res = await fetch("/api/plants");
            allPlants = await res.json();
            originalPlants = [...allPlants];

            applyFilter(true);
        } catch (e) {
            plantTableBody.innerHTML =
                `<tr><td colspan="6" class="no-data">Error loading plants</td></tr>`;
        }
    }

    // ---------------- RENDER ROW ---------------- //
    function makeRowHtml(p) {

    return `
    <tr data-plant="${p.plantID}">
        <td>${p.serialNo}</td>
        <td>${p.plantID}</td>
        <td>${p.plantName}</td>
        <td>${p.kld}</td>
        <td>${p.zones}</td>
        <td>
            <button class="btn-view"
                onclick="window.location.href='view-employees.html?plantID=${p.plantID}'">
                View Employees
            </button>

            <button class="btn-create"
                onclick="window.location.href='create-employee.html?plantID=${p.plantID}'">
                Create Employee
            </button>
        </td>
    </tr>`;
}



    // ---------------- RENDER TABLE ---------------- //
    async function renderTable() {

        if (!allPlants.length) return;

        plantTableBody.innerHTML = "";

        allPlants.forEach((p, index) => {
            p.serialNo = index + 1;

            plantTableBody.insertAdjacentHTML("beforeend", makeRowHtml(p));
        });
    }

    // ---------------- APPLY FILTER ---------------- //
    function applyFilter(skipUrlUpdate = false) {

        if (filterType === "id" && filterValue) {
            allPlants = originalPlants.filter(p => p.plantID == filterValue);

            if (allPlants.length === 0) {
                plantTableBody.innerHTML =
                    `<tr><td colspan="6" class="no-data">Plant Not Found</td></tr>`;
                return;
            }
        }
        else if (filterType === "zone" && filterValue) {
            allPlants = originalPlants.filter(p => p.zones == filterValue);

            if (allPlants.length === 0) {
                plantTableBody.innerHTML =
                    `<tr><td colspan="6" class="no-data">Plants Not Found</td></tr>`;
                return;
            }
        }
        else {
            allPlants = [...originalPlants];
        }

        if (!skipUrlUpdate) updateURL();
        renderTable();
    }

    function updateURL() {
        let url = `index.html?date=${reportDateInput.value}`;
        if (filterType && filterValue) url += `&filter=${filterType}&value=${filterValue}`;
        history.replaceState({}, "", url);
    }

    // ---------------- SEARCH EVENTS ---------------- //
    document.getElementById("searchIdBtn").onclick = () => {
        filterType = "id";
        filterValue = document.getElementById("plantIDInput").value.trim();
        applyFilter();
    };

    document.getElementById("searchZoneBtn").onclick = () => {
        filterType = "zone";
        filterValue = document.getElementById("zoneInput").value.trim();
        applyFilter();
    };

    // ENTER key search
    document.getElementById("plantIDInput").addEventListener("keypress", e => {
        if (e.key === "Enter") document.getElementById("searchIdBtn").click();
    });

    document.getElementById("zoneInput").addEventListener("keypress", e => {
        if (e.key === "Enter") document.getElementById("searchZoneBtn").click();
    });

    // ---------------- RESET ---------------- //
    document.getElementById("resetBtn").onclick = () => {
        document.getElementById("plantIDInput").value = "";
        document.getElementById("zoneInput").value = "";
        filterType = null;
        filterValue = null;
        applyFilter();
    };

    // ---------------- DATE CHANGE ---------------- //
    reportDateInput.addEventListener("change", () => {
        updateURL();
        renderTable();
    });

    // ---------------- REDIRECT HOME ---------------- //
    function redirectHome() {
        updateURL();
        window.location.href = location.href;
    }

    // ---------------- SSE AUTO REFRESH ---------------- //
    function startSSE() {
        const evt = new EventSource("/api/events/updates");

        evt.onmessage = () => {
            fetchPlants();
        };

        evt.onerror = () => setTimeout(startSSE, 2000);
    }

    startSSE();
    fetchPlants();

</script>
</body>
</html>
