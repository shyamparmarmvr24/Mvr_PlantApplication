<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="https://mvrtech.org/MVR_Company_Logo%20copy.png">

    <title>MVR TECHNOLOGY - Plant Management Dashboard</title>

    <style>
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            margin:0;
            padding:0;
            background:#f5f7fa;
            color:#222;
        }

        header {
            position: sticky;
            top: 0;
            z-index: 999;
            display:flex;
            justify-content:space-between;
            align-items:center;
            background: linear-gradient(90deg,#0f172a,#0ea5e9);
            padding:14px 20px;
            color:#fff;
        }

        .logo-left {
            display:flex;
            align-items:center;
            gap:12px;
            cursor:pointer;
        }
        .logo-left img { height:28px; }

        .brand {
            font-family:"Times New Roman", serif;
            font-size:25px;
            font-weight:700;
        }

        .date-picker { display:flex; align-items:center; gap:8px; }
        .date-picker label { font-weight:600; color:#fff; }
        .date-picker input[type="date"]{
            padding:6px 10px;
            border-radius:6px;
            border:1px solid #ddd;
            background:#fff;
            color:#000;
            font-size:15px;
            cursor:pointer;
        }

        .dashboard-title {
            text-align:center;
            margin:18px auto 6px;
            font-size:26px;
            color:#0f172a;
            font-weight:700;
            font-family:"Times New Roman", serif;
        }

        .container {
            max-width:1250px;
            margin:10px auto 40px;
            padding:0 16px;
        }

        .search-section {
            display:flex;
            gap:12px;
            flex-wrap:wrap;
            margin-bottom:18px;
            align-items:center;
        }

        .search-box { flex:1; min-width:200px; display:flex; }
        .search-box input {
            flex:1;
            padding:10px;
            border:1px solid #ccc;
            border-radius:6px 0 0 6px;
            font-size:15px;
        }
        .search-box button {
            padding:10px 16px;
            border:none;
            background:#0369a1;
            color:white;
            font-size:15px;
            border-radius:0 6px 6px 0;
            cursor:pointer;
        }

        .addBtn {
            padding:10px 16px;
            background:#059669;
            color:white;
            border:none;
            border-radius:6px;
            font-size:15px;
            cursor:pointer;
        }

        table {
            width:100%;
            border-collapse:collapse;
            background:white;
            border-radius:8px;
            overflow:hidden;
            box-shadow:0 4px 12px rgba(2,6,23,0.06);
            table-layout: fixed;
        }

        thead {
            display:table;
            width:100%;
            table-layout:fixed;
        }

        tbody {
            display:block;
            max-height: calc(100vh - 260px);
            overflow-y:auto;
            width:100%;
        }

        tbody tr {
            display:table;
            width:100%;
            table-layout:fixed;
        }

        th, td {
            padding:14px 12px;
            text-align:center;
            border-bottom:1px solid #f1f5f9;
            white-space: nowrap;
            font-size:15px;
        }

        th:nth-child(1), td:nth-child(1) { width: 6%; }
        th:nth-child(2), td:nth-child(2) { width: 10%; }
        th:nth-child(3), td:nth-child(3) { width: 24%; }
        th:nth-child(4), td:nth-child(4) { width: 10%; }
        th:nth-child(5), td:nth-child(5) { width: 10%; }
        th:nth-child(6), td:nth-child(6) { width: 13%; }
        th:nth-child(7), td:nth-child(7) { width: 13%; }
        th:nth-child(8), td:nth-child(8) { width: 14%; }

        th {
            background:#0369a1;
            color:white;
            font-weight:600;
            text-transform:uppercase;
            font-size:13px;
        }

        tr:nth-child(even){ background:#fbfdff; }
        tr:hover { background:#f0f9ff; }

        .btn-status {
            padding: 10px 16px;
            border:none;
            border-radius:6px;
            font-weight:600;
            cursor:pointer;
            width:130px;
            font-size:14px;
            text-transform: capitalize;
        }

        .update { background:#ef4444; color:white; }
        .pending { background:#f59e0b; color:white; }
        .view { background:#10b981; color:white; }

        .no-data {
            text-align:center;
            padding:18px;
            color:#6b7280;
            font-size:16px;
        }

    </style>
</head>

<body>

<header>
    <div class="logo-left" onclick="redirectHome()">
        <img src="https://mvrtech.org/MVR_Company_Logo%20copy.png">
        <div class="brand">MVR TECHNOLOGY</div>
    </div>

    <div class="date-picker">
        <label for="reportDate">Date:</label>
        <input type="date" id="reportDate" />
    </div>
</header>

<div class="dashboard-title">Plant Management Dashboard</div>

<div class="container">

    <div class="search-section">
        <div class="search-box">
            <input type="number" id="plantIDInput" placeholder="Search by Plant ID" min="1" />
            <button id="searchIdBtn">Search</button>
        </div>

        <div class="search-box">
            <input type="number" id="zoneInput" placeholder="Search by Zone" min="1" />
            <button id="searchZoneBtn">Search</button>
        </div>

        <button class="addBtn" id="resetBtn" style="background:#6b7280;">Reset</button>
        <button class="addBtn" onclick="window.location.href='create-plant.html'" style="background:#16a34a;">
            Add Plant
        </button>
    </div>

    <table>
        <thead>
        <tr>
            <th>S.No</th>
            <th>Plant ID</th>
            <th>Name</th>
            <th>KLD</th>
            <th>Zone</th>
            <th>Plant Operation</th>
            <th>Lab Operation</th>
            <th>Attendance</th>
        </tr>
        </thead>

        <tbody id="plantTableBody">
        <tr><td colspan="8" class="no-data">Loading...</td></tr>
        </tbody>
    </table>

</div>

<script>
    const plantTableBody = document.getElementById("plantTableBody");
    const reportDateInput = document.getElementById("reportDate");

    const today = new Date().toISOString().split("T")[0];
    reportDateInput.max = today;

    const urlDate = new URLSearchParams(window.location.search).get("date");
    reportDateInput.value = (urlDate && urlDate <= today) ? urlDate : today;

    let allPlants = [];
    let originalPlants = [];
    let filterType = null;
    let filterValue = null;

    // ----------------------- NAVIGATION ----------------------- //
    function openPlantOperation(id, date, status) {
        if (status === "view")
            window.location.href = `view-operation.html?plantID=${id}&date=${date}`;
        else
            window.location.href = `update-operation.html?plantID=${id}&date=${date}`;
    }

    function openLabOperation(id, date, status) {
        if (status === "view")
            window.location.href = `view-lab.html?plantID=${id}&date=${date}`;
        else
            window.location.href = `update-lab.html?plantID=${id}&date=${date}`;
    }

    function openAttendance(id, date, status) {
        // kept for future implementation
        if (status === "view")
            window.location.href = `view-attendance.html?plantID=${id}&date=${date}`;
        else
            window.location.href = `update-attendance.html?plantID=${id}&date=${date}`;
    }

    // ============================================================
    //           SEPARATE STATUS LOGIC FOR EACH TYPE
    // ============================================================

    // ------------ PLANT OPERATION STATUS ------------ //
    function calcPlantStatus(op) {
        if (!op || typeof op !== "object") return "update";

        const solar = op.solarIntegration;

        const baseFields = [
            "sludgeTankLevelAm",
            "sludgeTankLevelPm",
            "sludgeReceived",
            "noOfTrips",
            "sludgeProcessed",
            "biocharProduced",
            "plantRunningHrs",
            "solarIntegration",
            "dgReadingAm",
            "dgReadingPm",
            "dgDiesalPercentageAm",
            "dgDiesalPercentagePm",
            "vehicleReadingAm",
            "vehicleReadingPm",
            "vehicleFuelLevel",
            "polymerUsage",
            "pillets"
        ];

        const solarYesExtra = [
            "powerReadingAmImport",
            "powerReadingAmExport",
            "powerReadingPmImport",
            "powerReadingPmExport"
        ];

        const solarNoExtra = [
            "powerReadingAm",
            "powerReadingPm"
        ];

        let fieldsToCheck = [...baseFields];

        if (solar === true) {
            fieldsToCheck = fieldsToCheck.concat(solarYesExtra);
        } else if (solar === false) {
            fieldsToCheck = fieldsToCheck.concat(solarNoExtra);
        }
        // if solarIntegration is null -> only base fields considered

        const total = fieldsToCheck.length;
        let filled = 0;

        fieldsToCheck.forEach(f => {
            const v = op[f];
            if (v !== null && v !== undefined && v !== "") filled++;
        });

        if (filled === 0) return "update";
        if (filled < total) return "pending";
        return "view";
    }

    async function getPlantStatus(plantID, date) {
        try {
            const res = await fetch(`/api/operations/plant/${plantID}?date=${date}`);
            const text = await res.text();

            if (!text || !text.trim() || text.trim() === "null") return "update";

            const data = JSON.parse(text);
            return calcPlantStatus(data);

        } catch (e) {
            return "update";
        }
    }

    // ------------ LAB OPERATION STATUS ------------ //
    const labFieldsForStatus = [
        "cod",
        "bod",
        "th",
        "temperature",
        "tss",
        "ph",
        "velocity",
        "cumulativeFlow",
        "flowMeterReadingAm",
        "flowMeterReadingPm"
    ];

    function calcLabStatus(lab) {
        if (!lab || typeof lab !== "object") return "update";

        const total = labFieldsForStatus.length;
        let filled = 0;

        labFieldsForStatus.forEach(f => {
            const v = lab[f];
            if (v !== null && v !== undefined && v !== "") filled++;
        });

        if (filled === 0) return "update";
        if (filled < total) return "pending";
        return "view";
    }

    async function getLabStatus(plantID, date) {
        try {
            const res = await fetch(`/api/laboperations/plant/${plantID}?date=${date}`);
            const text = await res.text();

            if (!text || !text.trim() || text.trim() === "null") return "update";

            const data = JSON.parse(text);
            return calcLabStatus(data);

        } catch (e) {
            return "update";
        }
    }

    // ------------ ATTENDANCE STATUS (placeholder) ------------ //
    function getAttendanceStatus() {
        return "update"; // always 'update' for now; button disabled
    }

    // ----------------------- FETCH PLANTS ----------------------- //
    async function fetchPlants() {
        plantTableBody.innerHTML = `<tr><td colspan="8" class="no-data">Refreshing...</td></tr>`;

        try {
            const res = await fetch("/api/plants");
            allPlants = await res.json();
            originalPlants = [...allPlants];
            applyFilter(true);
        } catch {
            plantTableBody.innerHTML = `<tr><td colspan="8" class="no-data">Error loading plants</td></tr>`;
        }
    }

    // ----------------------- RENDER EACH ROW ----------------------- //
    async function makeRow(p, date) {
        const plantOpStatus = await getPlantStatus(p.plantID, date);
        const labOpStatus   = await getLabStatus(p.plantID, date);
        const empOpStatus   = getAttendanceStatus();

        return `
        <tr>
            <td>${p.serialNo}</td>
            <td>${p.plantID}</td>
            <td>${p.plantName}</td>
            <td>${p.kld}</td>
            <td>${p.zones}</td>

            <td>
                <button class="btn-status ${plantOpStatus}"
                    onclick="openPlantOperation(${p.plantID}, '${date}', '${plantOpStatus}')">
                    ${plantOpStatus}
                </button>
            </td>

            <td>
                <button class="btn-status ${labOpStatus}"
                    onclick="openLabOperation(${p.plantID}, '${date}', '${labOpStatus}')">
                    ${labOpStatus}
                </button>
            </td>

            <td>
                <button class="btn-status ${empOpStatus}" disabled>
                    coming soon
                </button>
            </td>
        </tr>`;
    }

    // ----------------------- RENDER TABLE ----------------------- //
    async function renderTable(date) {
        plantTableBody.innerHTML = "";

        for (let i = 0; i < allPlants.length; i++) {
            let p = allPlants[i];
            p.serialNo = i + 1;
            const rowHtml = await makeRow(p, date);
            plantTableBody.insertAdjacentHTML("beforeend", rowHtml);
        }
    }

    // ----------------------- FILTER ----------------------- //
    function applyFilter(skipUrlUpdate = false) {
        if (filterType === "id" && filterValue) {
            allPlants = originalPlants.filter(p => p.plantID == filterValue);
        } else if (filterType === "zone" && filterValue) {
            allPlants = originalPlants.filter(p => p.zones == filterValue);
        } else {
            allPlants = [...originalPlants];
        }

        if (!allPlants.length) {
            plantTableBody.innerHTML = `<tr><td colspan="8" class="no-data">No Data Found</td></tr>`;
            return;
        }

        if (!skipUrlUpdate) updateURL();

        renderTable(reportDateInput.value);
    }

    function updateURL() {
        let url = `index.html?date=${reportDateInput.value}`;
        if (filterType && filterValue)
            url += `&filter=${filterType}&value=${filterValue}`;
        history.replaceState({}, "", url);
    }

    // ----------------------- SEARCH ----------------------- //
    document.getElementById("searchIdBtn").onclick = () => {
        filterType = "id";
        filterValue = document.getElementById("plantIDInput").value.trim();
        applyFilter();
    };

    document.getElementById("searchZoneBtn").onclick = () => {
        filterType = "zone";
        filterValue = document.getElementById("zoneInput").value.trim();
        applyFilter();
    };

    document.getElementById("plantIDInput").addEventListener("keypress", e => {
        if (e.key === "Enter") document.getElementById("searchIdBtn").click();
    });

    document.getElementById("zoneInput").addEventListener("keypress", e => {
        if (e.key === "Enter") document.getElementById("searchZoneBtn").click();
    });

    // ----------------------- RESET ----------------------- //
    document.getElementById("resetBtn").onclick = () => {
        document.getElementById("plantIDInput").value = "";
        document.getElementById("zoneInput").value = "";
        filterType = null;
        filterValue = null;
        applyFilter();
    };

    // ----------------------- DATE CHANGE ----------------------- //
    reportDateInput.addEventListener("change", () => {
        updateURL();
        renderTable(reportDateInput.value);
    });

    function redirectHome() {
        updateURL();
        window.location.href = location.href;
    }

    // ----------------------- SSE AUTO REFRESH ----------------------- //
    function startSSE() {
        const evt = new EventSource("/api/events/updates");
        evt.onmessage = () => fetchPlants();
        evt.onerror = () => setTimeout(startSSE, 2000);
    }

    startSSE();
    fetchPlants();
</script>

</body>
</html>
