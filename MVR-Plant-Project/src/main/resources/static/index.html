<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="https://mvrtech.org/MVR_Company_Logo%20copy.png">

    <title>MVR TECHNOLOGY - Plant Management Dashboard</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            margin:0; padding:0;
            background:#f5f7fa;
            color:#222;
        }

        header {
            position: sticky;
            top: 0;
            z-index: 999;
        }

        header {
            display:flex;
            justify-content:space-between;
            align-items:center;
            background: linear-gradient(90deg,#0f172a,#0ea5e9);
            padding:14px 20px;
            color:#fff;
            gap:12px;
        }

        .logo-left {
            display:flex;
            align-items:center;
            gap:12px;
            cursor:pointer;
        }

<!--        .logo-left img { height:48px; width:auto; display:block; }-->
<!--        .logo-left .brand { font-size:20px; font-weight:700; letter-spacing:0.6px; }-->

       /* ‚≠ê Refined Logo + Brand Design */
.logo-left img {
    height:28px;            /* smaller logo */
    width:auto;
    display:block;
}

.logo-left .brand {
    font-family: "Times New Roman", Times, serif !important;
    font-size:25px;         /* bigger text */
    font-weight:700;
    letter-spacing:1px;
    color:#ffffff;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.25); /* smooth professional shadow */
}


        .date-picker { display:flex; align-items:center; gap:8px; }
        .date-picker label { font-weight:600; color:#fff; }
        .date-picker input[type="date"]{
            padding:6px 10px;
            border-radius:6px;
            border:1px solid #ddd;
            background:#fff;
            color:#000;
            font-size:15px;
            cursor:pointer;
        }

        .dashboard-title {
            text-align:center;
            margin:18px auto 6px;
            max-width:1100px;
            font-size:26px;
            color:#0f172a;
            font-weight:700;
        }

        .container {
            max-width:1100px;
            margin:8px auto 40px;
            padding:0 16px;
        }

        .search-section {
            display:flex;
            gap:12px;
            flex-wrap:wrap;
            margin-bottom:18px;
            align-items:center;
        }

        .search-box { flex:1; min-width:180px; display:flex; }

        .search-box input {
            flex:1;
            padding:10px;
            border:1px solid #ccc;
            border-radius:6px 0 0 6px;
            font-size:15px;
        }

        .search-box button {
            padding:10px 16px;
            border:none;
            background:#0369a1;
            color:white;
            font-size:15px;
            border-radius:0 6px 6px 0;
            cursor:pointer;
        }

        .addBtn {
            padding:10px 16px;
            background:#059669;
            color:white;
            border:none;
            border-radius:6px;
            font-size:15px;
            cursor:pointer;
        }

        /* ‚≠ê TABLE FIXED SPACING */
        table {
            width:100%;
            border-collapse:collapse;
            background:white;
            border-radius:8px;
            overflow:hidden;
            box-shadow:0 4px 12px rgba(2,6,23,0.06);
            table-layout: fixed;
        }

        thead {
            display:table;
            width:100%;
            table-layout:fixed;
        }

        tbody {
            display:block;
            max-height: calc(100vh - 260px);
            overflow-y:auto;
            width:100%;
        }

        tbody tr {
            display:table;
            width:100%;
            table-layout:fixed;
        }

        th, td {
            padding:14px 12px;   /* ‚≠ê More spacing */
            text-align:center;
            border-bottom:1px solid #f1f5f9;
            white-space: nowrap;
        }

        /* ‚≠ê Column width balancing */
        th:nth-child(1), td:nth-child(1) { width: 8%; }
        th:nth-child(2), td:nth-child(2) { width: 12%; }
        th:nth-child(3), td:nth-child(3) { width: 22%; }
        th:nth-child(4), td:nth-child(4) { width: 12%; }
        th:nth-child(5), td:nth-child(5) { width: 10%; }
        th:nth-child(6), td:nth-child(6) { width: 22%; }
        th:nth-child(7), td:nth-child(7) { width: 14%; }

        th {
            background:#0369a1;
            color:white;
            font-weight:600;
            text-transform:uppercase;
            font-size:13px;
        }

        tr:nth-child(even){ background:#fbfdff; }
        tr:hover { background:#f0f9ff; }

        /* ‚≠ê Increased progress bar width */
        .progress-bar {
            width:170px;    /* little bigger */
            height:14px;
            background:#e6eef8;
            border-radius:8px;
            overflow:hidden;
            margin:auto;
        }

        .progress-fill { height:100%; width:0; transition:width .25s ease-in-out; }
        .progress-red{ background:#ef4444; }
        .progress-yellow{ background:#f59e0b; }
        .progress-green{ background:#10b981; }

        .btn-update {
            padding: 8px 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            min-width: 100px; /* ‚≠ê Gives breathing room */
            text-align: center;
        }

        .btn-update.update { background:#ef4444; color:white; }
        .btn-update.pending { background:#f59e0b; color:#111; }
        .btn-update.view { background:#10b981; color:white; }

        .no-data { text-align:center; padding:18px; color:#6b7280; }

        @media (max-width:900px){
            header { flex-direction:column; align-items:flex-start; gap:10px; padding:12px; }
            .dashboard-title { font-size:20px; }
            th, td{ padding:10px 8px; font-size:14px; }
            .date-picker label{ display:none; }
        }

 /* üì± Mobile Fix: Only data should scroll */
@media (max-width: 600px) {

    /* Remove full table scrolling */
    table {
        width: 100%;
        display: table;
        table-layout: fixed;
    }

    thead {
        display: table;
        width: 100%;
        table-layout: fixed;
    }

    /* üëâ Only tbody scrolls horizontally */
    tbody {
        display: block;
        overflow-x: auto;
        overflow-y: auto;
        max-height: calc(100vh - 260px);
        white-space: nowrap;
    }

    /* keep rows fixed width so scrolling works */
    tbody tr {
        display: table;
        width: 100%;
        table-layout: fixed;
    }

    th, td {
        padding: 8px 6px;
        font-size: 12px;
        white-space: nowrap;
    }

    /* search section should never scroll sideways */
    body, html {
        overflow-x: hidden !important;
    }

    /* Progress + buttons stacking fix */
    td:nth-child(6), td:nth-child(7) {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
        white-space: nowrap;
    }

    .progress-bar {
        width: 90px;
        height: 10px;
    }

    .btn-update {
        min-width: 80px;
        padding: 6px 6px;
        font-size: 12px;
    }
}

        /* üì± Fix search section buttons overlap */
@media (max-width: 600px) {

    /* Stack search items vertically */
    .search-section {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
    }

    .search-box {
        width: 100%;
        min-width: 100%;
    }

    .search-box input {
        font-size: 14px;
        padding: 8px;
    }

    .search-box button {
        font-size: 14px;
        padding: 8px 12px;
        white-space: nowrap;
    }

    /* Reset button full width on mobile */
    #resetBtn {
        width: 100%;
        padding: 10px;
        font-size: 14px;
    }
}
        /* ‚≠ê Apply Times New Roman to the brand title & dashboard title */
.brand,
.dashboard-title {
    font-family: "Times New Roman", Times, serif !important;
    letter-spacing: 0.5px;
}


    </style>
</head>
<body>

<header>
    <div class="logo-left" onclick="redirectHome()">
        <img src="https://mvrtech.org/MVR_Company_Logo%20copy.png" alt="MVR Logo" />
        <div class="brand">MVR TECHNOLOGY</div>
    </div>

    <div class="date-picker">
        <label for="reportDate">Date:</label>
        <input type="date" id="reportDate" />
    </div>
</header>

<div class="dashboard-title">Plant Management Dashboard</div>

<div class="container">
    <div class="search-section">
        <div class="search-box">
            <input type="number" id="plantIDInput" placeholder="Search by Plant ID" min="1" />
            <button id="searchIdBtn">Search</button>
        </div>

        <div class="search-box">
            <input type="number" id="zoneInput" placeholder="Search by Zone" min="1" />
            <button id="searchZoneBtn">Search</button>
        </div>

        <button class="addBtn" id="resetBtn" style="background:#6b7280;">Reset</button>
<!--        <button class="addBtn" onclick="location.href='create-plant.html'">Add New Plant</button>-->
    </div>

    <table>
        <thead>
        <tr>
            <th>S.No</th>
            <th>Plant ID</th>
            <th>Name</th>
            <th>KLD</th>
            <th>Zone</th>
            <th>Progress</th>
            <th>Action</th>
        </tr>
        </thead>

        <tbody id="plantTableBody">
        <tr><td colspan="7" class="no-data">Loading...</td></tr>
        </tbody>
    </table>
</div>

<script>

    const plantTableBody = document.getElementById('plantTableBody');
    const reportDateInput = document.getElementById('reportDate');
    const searchIdBtn = document.getElementById('searchIdBtn');
    const searchZoneBtn = document.getElementById('searchZoneBtn');

    let allPlants = [];
    let cachedOps = {};
    let visiblePlants = [];
    let lastFilterType = null;
    let lastFilterValue = null;

    const fields = [
        "sludgeTankLevel","sludgeProcessed","sludgeReceived","biocharProduced","plantRunningHrs",
        "solarReadingAm","solarReadingPm","powerReadingAm","powerReadingPm",
        "noOfTrips","vehicleReadingAm","vehicleReadingPm","dgUsed","dgRunHrs"
    ];

    const today = new Date().toISOString().split('T')[0];
    reportDateInput.value = today;
    reportDateInput.max = today;

    function applyInitialUrlParams() {
        const url = new URLSearchParams(window.location.search);
        const urlDate = url.get("date");
        const filter = url.get("filter");
        const value = url.get("value");

        if (urlDate) reportDateInput.value = urlDate;
        if (filter && value) {
            lastFilterType = filter;
            lastFilterValue = value;
            if (filter === 'id') {
                document.getElementById('plantIDInput').value = value;
            } else if (filter === 'zone') {
                document.getElementById('zoneInput').value = value;
            }
        }
    }

    function redirectHome() {
        let url = `index.html?date=${encodeURIComponent(reportDateInput.value)}`;
        if (lastFilterType && lastFilterValue) {
            url += `&filter=${encodeURIComponent(lastFilterType)}&value=${encodeURIComponent(lastFilterValue)}`;
        }
        window.location.href = url;
    }

    async function fetchPlants() {
<!--        plantTableBody.innerHTML = `<tr><td colspan="6" class="no-data">Loading plants...</td></tr>`;-->

        plantTableBody.innerHTML = `
        <tr><td colspan="7" class="no-data">
        <div style="color:#0369a1; font-size:16px; font-weight:600;">
        Refreshing...
        </div>
        </td></tr>`;


        try {
            const res = await fetch('/api/plants');
            if (!res.ok) throw new Error('Failed to fetch plants');
            allPlants = await res.json();
            applyInitialUrlParams();

            if (lastFilterType === 'id' && lastFilterValue) {
                const filtered = allPlants.filter(p => String(p.plantID) === String(lastFilterValue));
                renderFiltered(filtered, reportDateInput.value, true);
            } else if (lastFilterType === 'zone' && lastFilterValue) {
                const filtered = allPlants.filter(p => String(p.zones) === String(lastFilterValue));
                renderFiltered(filtered, reportDateInput.value, true);
            } else {
                renderTable(reportDateInput.value);
            }
        } catch (e) {
            plantTableBody.innerHTML = `<tr><td colspan="6" class="no-data">Error loading plants</td></tr>`;
            console.error(e);
        }
    }

    async function fetchOp(plantID, date) {
        const key = `${plantID}_${date}`;
        if (cachedOps[key]) return cachedOps[key];

        try {
            const res = await fetch(`/api/operations/plant/${plantID}?date=${date}`);
            const text = await res.text();
            if (!text || !text.trim()) {
                cachedOps[key] = { progress: 0, status: 'update', op: null };
                return cachedOps[key];
            }
            const op = JSON.parse(text);

            let filled = 0;
            fields.forEach(f => {
                if (f === 'dgRunHrs') {
                    if (op['dgUsed'] === false) filled++;
                    else if (op[f] !== null && op[f] !== undefined && op[f] !== '') filled++;
                } else {
                    if (op[f] !== null && op[f] !== undefined && op[f] !== '') filled++;
                }
            });

            const progress = Math.round((filled / fields.length) * 100);
            const status = progress === 100 ? 'view' : progress > 0 ? 'pending' : 'update';

            cachedOps[key] = { progress, status, op };
            return cachedOps[key];
        } catch (e) {
            console.error('fetchOp error', e);
            cachedOps[key] = { progress: 0, status: 'update', op: null };
            return cachedOps[key];
        }
    }

    function makeRowHtml(p, opData) {
        const clr = opData.progress === 100 ? 'progress-green' : opData.progress > 0 ? 'progress-yellow' : 'progress-red';
        const statusLabel = opData.status.charAt(0).toUpperCase() + opData.status.slice(1);
        const dateVal = reportDateInput.value;

        const filterPart = lastFilterType && lastFilterValue ? `&filter=${encodeURIComponent(lastFilterType)}&value=${encodeURIComponent(lastFilterValue)}` : '';
        const actionUrl = opData.status === 'view'
            ? `view-operation.html?plantID=${p.plantID}&date=${dateVal}${filterPart}`
            : `update-operation.html?plantID=${p.plantID}&date=${dateVal}${filterPart}`;

        return `<tr data-plant="${p.plantID}">
            <td>${p.serialNo}</td>
            <td>${p.plantID}</td>
            <td>${p.plantName}</td>
            <td>${p.kld}</td>
            <td>${p.zones}</td>
            <td>
                <div class="progress-bar">
                    <div class="progress-fill ${clr}" style="width:${opData.progress}%"></div>
                </div>
                <small>${opData.progress}%</small>
            </td>
            <td>
                <button class="btn-update ${opData.status}" onclick="window.location.href='${actionUrl}'">${statusLabel}</button>
            </td>
        </tr>`;
    }

    async function renderTable(date) {
        if (!allPlants.length) {
            plantTableBody.innerHTML = `<tr><td colspan="6" class="no-data">No plants found</td></tr>`;
            return;
        }

        visiblePlants = allPlants.slice();
        visiblePlants.forEach((p, i) => p.serialNo = i + 1);

        const placeholders = visiblePlants.map(p => `
            <tr data-plant="${p.plantID}">
                <td>${p.serialNo}</td>
                <td>${p.plantID}</td>
                <td>${p.plantName}</td>
                <td>${p.kld}</td>
                <td>${p.zones}</td>
                <td><div class="progress-bar"><div class="progress-fill" style="width:0%"></div></div><small>0%</small></td>
                <td><button class="btn-update pending">...</button></td>
            </tr>`).join('');
        plantTableBody.innerHTML = placeholders;

        visiblePlants.forEach(async (p) => {
            const opData = await fetchOp(p.plantID, date);
            const row = plantTableBody.querySelector(`tr[data-plant="${p.plantID}"]`);
            if (row) row.outerHTML = makeRowHtml(p, opData);
        });
    }

    async function renderFiltered(filtered, date, initial=false) {
        if (!filtered.length) {
            plantTableBody.innerHTML = `<tr><td colspan="6" class="no-data">No plants found</td></tr>`;
            return;
        }

        visiblePlants = filtered.map((p,i) => { p.serialNo = i+1; return p; });

        const placeholders = visiblePlants.map(p => `
            <tr data-plant="${p.plantID}">
                <td>${p.serialNo}</td>
                <td>${p.plantID}</td>
                <td>${p.plantName}</td>
                <td>${p.kld}</td>
                <td>${p.zones}</td>
                <td><div class="progress-bar"><div class="progress-fill" style="width:0%"></div></div><small>0%</small></td>
                <td><button class="btn-update pending">...</button></td>
            </tr>`).join('');
        plantTableBody.innerHTML = placeholders;

        visiblePlants.forEach(async (p) => {
            const opData = await fetchOp(p.plantID, date);
            const row = plantTableBody.querySelector(`tr[data-plant="${p.plantID}"]`);
            if (row) row.outerHTML = makeRowHtml(p, opData);
        });

        if (!initial) {
            const url = new URL(window.location);
            url.searchParams.set('date', date);
            if (lastFilterType && lastFilterValue) {
                url.searchParams.set('filter', lastFilterType);
                url.searchParams.set('value', lastFilterValue);
            } else {
                url.searchParams.delete('filter');
                url.searchParams.delete('value');
            }
            history.replaceState({}, '', url.toString());
        }
    }

    function searchByID() {
        const id = document.getElementById('plantIDInput').value.trim();
        lastFilterType = id ? 'id' : null;
        lastFilterValue = id || null;
        const date = reportDateInput.value;
        const filtered = id ? allPlants.filter(p => String(p.plantID) === String(id)) : allPlants;
        renderFiltered(filtered, date);
    }

    function searchByZone() {
        const zone = document.getElementById('zoneInput').value.trim();
        lastFilterType = zone ? 'zone' : null;
        lastFilterValue = zone || null;
        const date = reportDateInput.value;
        const filtered = zone ? allPlants.filter(p => String(p.zones) === String(zone)) : allPlants;
        renderFiltered(filtered, date);
    }

    reportDateInput.addEventListener('change', () => {
        const d = reportDateInput.value;
        const url = new URL(window.location);
        url.searchParams.set('date', d);
        if (lastFilterType && lastFilterValue) {
            url.searchParams.set('filter', lastFilterType);
            url.searchParams.set('value', lastFilterValue);
        } else {
            url.searchParams.delete('filter');
            url.searchParams.delete('value');
        }
        history.replaceState({}, '', url.toString());

        Object.keys(cachedOps).forEach(k => {
            if (!k.endsWith(`_${d}`)) delete cachedOps[k];
        });

        if (lastFilterType === 'id' && lastFilterValue) {
            const filtered = allPlants.filter(p => String(p.plantID) === String(lastFilterValue));
            renderFiltered(filtered, d);
        } else if (lastFilterType === 'zone' && lastFilterValue) {
            const filtered = allPlants.filter(p => String(p.zones) === String(lastFilterValue));
            renderFiltered(filtered, d);
        } else {
            renderTable(d);
        }
    });

    searchIdBtn.addEventListener('click', searchByID);
    searchZoneBtn.addEventListener('click', searchByZone);

    fetchPlants();

    document.getElementById('resetBtn').addEventListener('click', () => {
        document.getElementById('plantIDInput').value = "";
        document.getElementById('zoneInput').value = "";

        lastFilterType = null;
        lastFilterValue = null;

        const url = new URL(window.location);
        url.searchParams.set('date', reportDateInput.value);
        url.searchParams.delete('filter');
        url.searchParams.delete('value');
        history.replaceState({}, '', url.toString());

        renderTable(reportDateInput.value);
    });

    // ENTER ‚Üí Search by Plant ID
document.getElementById("plantIDInput")
        .addEventListener("keypress", function(e) {
            if (e.key === "Enter") searchByID();
        });

// ENTER ‚Üí Search by Zone
document.getElementById("zoneInput")
        .addEventListener("keypress", function(e) {
            if (e.key === "Enter") searchByZone();
        });


    // ---------------------------------------------------------
//    LIVE AUTO REFRESH USING SSE
// ---------------------------------------------------------

function startSSE() {
    const evtSource = new EventSource("/api/events/updates");

    evtSource.onmessage = async function(event) {
    console.log("üîÑ Update Received from Server");

    cachedOps = {};   // üî• IMPORTANT: Remove stale progress

    showToast("Updated Automatically");
    await fetchPlants();   // reload entire table smoothly
};


    evtSource.onerror = function(err) {
        console.log("SSE connection lost. Reconnecting...");
        setTimeout(startSSE, 2000); // auto-reconnect
    };
}

startSSE();


// ---------------------------------------------------------
//    Toast Message (Smooth Notification)
// ---------------------------------------------------------
function showToast(msg) {
    const t = document.createElement("div");
    t.innerText = msg;
    t.style.position = "fixed";
    t.style.bottom = "20px";
    t.style.right = "20px";
    t.style.padding = "12px 20px";
    t.style.background = "#059669";
    t.style.color = "white";
    t.style.borderRadius = "6px";
    t.style.boxShadow = "0 4px 14px rgba(0,0,0,0.2)";
    t.style.zIndex = "9999";
    t.style.fontSize = "15px";
    t.style.opacity = "0";
    t.style.transition = "opacity .4s ease";

    document.body.appendChild(t);
    setTimeout(() => t.style.opacity = "1", 50);
    setTimeout(() => {
        t.style.opacity = "0";
        setTimeout(() => t.remove(), 400);
    }, 1800);
}


</script>
</body>
</html>
