<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="icon" href="https://mvrtech.org/MVR_Company_Logo%20copy.png">

    <title>MVR TECHNOLOGY - Plant Management Dashboard</title>

    <style>
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            margin:0;
            padding:0;
            background:#f5f7fa;
            color:#222;
        }

        header {
            position: sticky;
            top: 0;
            z-index: 999;
            display:flex;
            justify-content:space-between;
            align-items:center;
            background: linear-gradient(90deg,#0f172a,#0ea5e9);
            padding:14px 20px;
            color:#fff;
        }

        .logo-left {
            display:flex;
            align-items:center;
            gap:12px;
            cursor:pointer;
        }
        .logo-left img { height:28px; }

        .brand {
            font-family:"Times New Roman", serif;
            font-size:25px;
            font-weight:700;
        }

        .date-picker { display:flex; align-items:center; gap:8px; }
        .date-picker label { font-weight:600; color:#fff; }
        .date-picker input[type="date"]{
            padding:6px 10px;
            border-radius:6px;
            border:1px solid:#ddd;
            background:#fff;
            color:#000;
            font-size:15px;
            cursor:pointer;
        }

        .dashboard-title {
            text-align:center;
            margin:18px auto 6px;
            font-size:26px;
            color:#0f172a;
            font-weight:700;
            font-family:"Times New Roman", serif;
        }

        .container {
            max-width:1250px;
            margin:10px auto 40px;
            padding:0 16px;
        }

        .search-section {
            display:flex;
            gap:12px;
            flex-wrap:wrap;
            margin-bottom:18px;
            align-items:center;
        }

        .search-box { flex:1; min-width:200px; display:flex; }
        .search-box input {
            flex:1;
            padding:10px;
            border:1px solid:#ccc;
            border-radius:6px 0 0 6px;
            font-size:15px;
        }
        .search-box button {
            padding:10px 16px;
            border:none;
            background:#0369a1;
            color:white;
            font-size:15px;
            border-radius:0 6px 6px 0;
            cursor:pointer;
        }

        .addBtn {
            padding:10px 16px;
            background:#059669;
            color:white;
            border:none;
            border-radius:6px;
            font-size:15px;
            cursor:pointer;
        }

        table {
            width:100%;
            border-collapse:collapse;
            background:white;
            border-radius:8px;
            overflow:hidden;
            box-shadow:0 4px 12px rgba(2,6,23,0.06);
            table-layout: fixed;
        }

        thead {
            display:table;
            width:100%;
            table-layout:fixed;
        }

        tbody {
            display:block;
            max-height: calc(100vh - 260px);
            overflow-y:auto;
            width:100%;
        }

        tbody tr {
            display:table;
            width:100%;
            table-layout:fixed;
        }

        th, td {
            padding:14px 12px;
            text-align:center;
            border-bottom:1px solid #f1f5f9;
            white-space: nowrap;
            font-size:15px;
        }

        th:nth-child(1), td:nth-child(1) { width: 6%; }
        th:nth-child(2), td:nth-child(2) { width: 10%; }
        th:nth-child(3), td:nth-child(3) { width: 24%; }
        th:nth-child(4), td:nth-child(4) { width: 10%; }
        th:nth-child(5), td:nth-child(5) { width: 10%; }
        th:nth-child(6), td:nth-child(6) { width: 13%; }
        th:nth-child(7), td:nth-child(7) { width: 13%; }
        th:nth-child(8), td:nth-child(8) { width: 14%; }

        th {
            background:#0369a1;
            color:white;
            font-weight:600;
            text-transform:uppercase;
            font-size:13px;
        }

        tr:nth-child(even){ background:#fbfdff; }
        tr:hover { background:#f0f9ff; }

        .btn-status {
            padding: 10px 16px;
            border:none;
            border-radius:6px;
            font-weight:600;
            cursor:pointer;
            width:130px;
            font-size:14px;
            text-transform: capitalize;
        }

        .update { background:#ef4444; color:white; }
        .pending { background:#f59e0b; color:white; }
        .view { background:#10b981; color:white; }

        .greenName { color:#10b981; font-weight:bold; }
        .yellowName { color:#f59e0b; font-weight:bold; }

        .no-data {
            text-align:center;
            padding:18px;
            color:#6b7280;
            font-size:16px;
        }

    </style>
</head>

<body>

<header>
    <div class="logo-left" onclick="redirectHome()">
        <img src="https://mvrtech.org/MVR_Company_Logo%20copy.png">
        <div class="brand">MVR TECHNOLOGY</div>
    </div>

    <div class="date-picker">
        <label for="reportDate">Date:</label>
        <input type="date" id="reportDate"/>
    </div>
</header>

<div class="dashboard-title">Plant Management Dashboard</div>

<div class="container">

    <div class="search-section">
        <div class="search-box">
            <input type="number" id="plantIDInput" placeholder="Search by Plant ID" min="1"/>
            <button id="searchIdBtn">Search</button>
        </div>

        <div class="search-box">
            <input type="number" id="zoneInput" placeholder="Search by Zone" min="1"/>
            <button id="searchZoneBtn">Search</button>
        </div>

        <button class="addBtn" id="resetBtn" style="background:#6b7280;">Reset</button>
        <button class="addBtn" onclick="window.location.href='create-plant.html'" style="background:#16a34a;">
            Add Plant
        </button>
        <button class="addBtn"
                onclick="window.location.href='report.html?date=' + document.getElementById('reportDate').value"
                style="background:#2563eb;">
            Generate Report
        </button>
        <button class="addBtn"
                onclick="window.location.href='create-dgandmotor.html'"
                style="background:#2563eb;">
            Add DG & Motor
        </button>

    </div>

    <table>
        <thead>
        <tr>
            <th>S.No</th>
            <th>Plant ID</th>
            <th>Plant Name</th>
            <th>KLD</th>
            <th>Zone</th>
            <th>Plant Operation</th>
            <th>Lab Operation</th>
            <th>Attendance</th>
        </tr>
        </thead>

        <tbody id="plantTableBody">
        <tr>
            <td colspan="8" class="no-data">Loading...</td>
        </tr>
        </tbody>
    </table>

</div>

<script>

    let sseConnection = null;

    let isRendering = false;   // ðŸš€ prevents overlapping renders
    let latestRenderToken = 0; // ðŸš€ prevents duplicates during async refresh

    const plantTableBody = document.getElementById("plantTableBody");
    const reportDateInput = document.getElementById("reportDate");

    const today = new Date().toISOString().split("T")[0];
    reportDateInput.max = today;

    const urlParams = new URLSearchParams(window.location.search);
    const urlDate = urlParams.get("date");
    reportDateInput.value = (urlDate && urlDate <= today) ? urlDate : today;

    let allPlants = [];
    let originalPlants = [];

    let filterType = null;
    let filterValue = null;


    document.addEventListener("visibilitychange", () => {
    if (document.hidden && sseConnection) {
        sseConnection.close();
        sseConnection = null;
    } else if (!document.hidden) {
        startSSE();
    }
});


    /* ----------------------------------------------------
       FIX 1: prevent duplicate renders by locking state
    ---------------------------------------------------- */
    async function safeRender(date) {
        if (isRendering) return;              // ðŸš« stop overlapping render
        isRendering = true;

        const token = ++latestRenderToken;    // unique cycle ID

        plantTableBody.innerHTML = `<tr>
            <td colspan="8" class="no-data">Loading...</td></tr>`;

        const rows = [];

        for (let i = 0; i < allPlants.length; i++) {
            if (token !== latestRenderToken) return; // ðŸš€ stop outdated render

            const p = allPlants[i];
            p.serialNo = i + 1;

            const rowHTML = await makeRow(p, date);
            rows.push(rowHTML);
        }

        if (token === latestRenderToken) {
            plantTableBody.innerHTML = rows.join("");
        }

        isRendering = false;
    }


    /* ----------------------------------------------------
       REST OF YOUR ORIGINAL LOGIC BELOW (unchanged)
    ---------------------------------------------------- */

    (function restoreFilterState() {
        const fType = urlParams.get("filter");
        const fVal = urlParams.get("value");
        if (fType && fVal) {
            filterType = fType;
            filterValue = fVal;
            localStorage.setItem("plantFilterType", filterType);
            localStorage.setItem("plantFilterValue", filterValue);
            if (filterType === "id") document.getElementById("plantIDInput").value = filterValue;
            if (filterType === "zone") document.getElementById("zoneInput").value = filterValue;
        } else {
            const lsType = localStorage.getItem("plantFilterType");
            const lsVal = localStorage.getItem("plantFilterValue");
            if (lsType && lsVal) {
                filterType = lsType;
                filterValue = lsVal;
                if (filterType === "id") document.getElementById("plantIDInput").value = filterValue;
                if (filterType === "zone") document.getElementById("zoneInput").value = filterValue;
            }
        }
    })();

    /* ---------------------------- PLANT INFO STATUS ---------------------------- */
    function getPlantInfoStatus(p) {
        let missing = false;

        const requiredFields = [
            "plantID","plantName","stateCode","district",
            "kld","wardNo","pinCode","zones",
            "solarPlantCapacity",
            "constructionStartedDate","civilWorkCompletedDate","machinaryAssembleDate",
            "codAndBodSenserDate","ipPhoneDate","cameraConfigurationDate",
            "noOfVehicle","noOfEmployees"
        ];

        requiredFields.forEach(f => {
            if (p[f] === null || p[f] === undefined || p[f] === "") missing = true;
        });

        const booleanGroups = [
            ["mnit","mnitDateOfCompletion"],
            ["permanentPower","permanentPowerDateOfCompletion"],
            ["solar","solarDateOfCompletion"],
            ["internet","internetDateOfCompletion"],
            ["tabs","tabsReceivedDate"],
            ["gps","gpsDate"]
        ];

        booleanGroups.forEach(([flag, dateField]) => {
            const flagVal = p[flag];
            const dateVal = p[dateField];
            if (flagVal && !dateVal) missing = true;
        });

        return missing ? "yellowName" : "greenName";
    }

    /* ---------------------------- NAVIGATION FUNCTIONS ---------------------------- */

    function openPlantOperation(id, date, status) {
        if (status === "view")
            window.location.href = `view-operation.html?plantID=${id}&date=${date}`;
        else
            window.location.href = `update-operation.html?plantID=${id}&date=${date}`;
    }

    function openLabOperation(id, date, status) {
        if (status === "view")
            window.location.href = `view-lab.html?plantID=${id}&date=${date}`;
        else
            window.location.href = `update-lab.html?plantID=${id}&date=${date}`;
    }

    function openAttendance(id, date, status) {
        if (status === "view")
            window.location.href = `attendance-employees.html?plantID=${id}&date=${date}`;
        else
            window.location.href = `update-attendance.html?plantID=${id}&date=${date}`;
    }

    /* ---------------------------- STATUS CHECK FUNCTIONS ---------------------------- */

    /* (UNCHANGED except improved error handling) */

    async function getPlantStatus(plantID, date) {
        try {
            const resOp = await fetch(`/api/operations/plant/${plantID}?date=${date}`);
            const textOp = await resOp.text();
            let plantOp = (!textOp || textOp.trim() === "null") ? {} : JSON.parse(textOp);

            const resVeh = await fetch(`/api/vehicle-operations/plant/${plantID}/vehicles`);
            const vehicles = resVeh.ok ? await resVeh.json() : [];

            const vehicleOps = await Promise.all(vehicles.map(async v => {
                try {
                    const r = await fetch(`/api/vehicle-operations/${v.vehicleID}?date=${date}`);
                    const t = await r.text();
                    const vo = (!t || t.trim() === "null") ? {} : JSON.parse(t);
                    return {
                           am: vo.vehicleReadingAm,
                           pm: vo.vehicleReadingPm,
                           fuel: vo.vehicleFuelLevel,
                           lastFuelFilled: vo.lastFuelFilled,
                           lastFuelFilledDate: vo.lastFuelFilledDate,
                           trips: vo.noOfTrips,
                           sludge: vo.sludgeCollect
                    };

                } catch {
                    return { am: null, pm: null, fuel: null };
                }
            }));

            const plantSolar = originalPlants.find(p => p.plantID === plantID)?.solar === true;
            return calcPlantStatus(plantOp, vehicleOps, plantSolar);

        }
        catch
        {
            return "update";
        }
    }
function calcPlantStatus(op, vehicleOps, plantSolar) {

    if (!op || typeof op !== "object") return "update";

    let total = 0;
    let filled = 0;

    /* ------------------ ALWAYS count these plant fields ------------------ */
    const alwaysPlant = [
    "sludgeTankLevelAm",
    "sludgeTankLevelPm",
    "sludgeProcessed",
    "biocharProduced",
    "plantRunningHrs",
    "dgReadingAm",
    "dgReadingPm",
    "dgDiesalPercentageAm",
    "dgDiesalPercentagePm",
    "polymerUsage",
    "polymerStock",
    "pillets",
    "pilletsStock"
];


    alwaysPlant.forEach(f => {
        total++;
        if (op[f] !== null && op[f] !== undefined && op[f] !== "") filled++;
    });

    /* ------------------ Solar logic (FROM PLANT MASTER) ------------------ */

        /* Import readings ALWAYS counted */
        ["powerReadingAmImport", "powerReadingPmImport"].forEach(f => {
            total++;
            if (op[f] !== null && op[f] !== undefined) filled++;
        });

        /* Export readings ONLY if solar = true */
        if (plantSolar) {
            ["powerReadingAmExport", "powerReadingPmExport"].forEach(f => {
                total++;
                if (op[f] !== null && op[f] !== undefined) filled++;
            });
        }

        /* ------------------ Power Bill logic ------------------ */

        /* Checkbox ALWAYS counted */
        total++;
        if (op.powerBill === true || op.powerBill === false) filled++;

        /* Bill fields ONLY if power bill = YES */
        if (op.powerBill === true) {
            ["lastBillDate", "TotalNoOfUnits", "totalBillAmount"].forEach(f => {
                total++;
                if (op[f] !== null && op[f] !== undefined) filled++;
            });
        }


    /* ------------------ Private Vehicle ------------------ */
    if (op.privateVehicle === true)
    {
    total += 3;
    if (op.noOfTripsPrivateVehicle != null) filled++;
    if (op.sludgeCollectPrivateVehicle != null) filled++;
    if (op.sludgeCollectPrivateVehicleKgs != null) filled++;
    }

    // if false â†’ do not count

    /* ------------------ Vehicle Operation Fields ------------------ */
    if (Array.isArray(vehicleOps)) {
        vehicleOps.forEach(v => {
            // always counted fields
            const base = [
                v.am, v.pm, v.fuel, v.trips, v.sludge
            ];

            total += 5;
            base.forEach(x => {
                if (x !== null && x !== undefined) filled++;
            });

            // last fuel logic
            if (v.lastFuelFilled === true) {
                total += 2; // checkbox + date
                filled++;   // checkbox is filled

                if (v.lastFuelFilledDate != null) filled++;
            }
        });
    }

    /* ------------------ Final status logic ------------------ */
    if (filled === 0) return "update";
    if (filled < total) return "pending";
    return "view";
}


    async function getLabStatus(plantID, date) {
        try {
            const res = await fetch(`/api/laboperations/plant/${plantID}?date=${date}`);
            const txt = await res.text();
            if (!txt.trim() || txt.trim() === "null") return "update";
            const lab = JSON.parse(txt);

            const fields = [
                "cod","bod","th","temperature","tss","ph","velocity",
                "cumulativeFlow","flowMeterReadingAm","flowMeterReadingPm"
            ];

            let filled = fields.filter(f => lab[f] !== null && lab[f] !== "").length;

            if (filled === 0) return "update";
            if (filled < fields.length) return "pending";
            return "view";

        } catch {
            return "update";
        }
    }

    async function getAttendanceStatus(plantID, date) {
        try {
            const resEmp = await fetch(`/api/plantemployees/plant/${plantID}`);
            const employees = await resEmp.json();
            if (!employees.length) return "update";

            let filled = 0;
            const total = employees.length * 2;

            for (const emp of employees) {
                try {
                    const r = await fetch(`/api/employee-operations/${emp.employeeId}/date/${date}`);
                    if (!r.ok) continue;
                    const data = await r.json();
                    if (data.attendanceAm !== null) filled++;
                    if (data.attendancePm !== null) filled++;
                } catch {}
            }

            if (filled === 0) return "update";
            if (filled < total) return "pending";
            return "view";

        }
        catch
        {
            return "update";
        }
    }

    /* ---------------------------- RENDERING ---------------------------- */

    async function makeRow(p, date) {
    const plantOpStatus = await getPlantStatus(p.plantID, date);
    const labOpStatus   = await getLabStatus(p.plantID, date);
    const empOpStatus   = await getAttendanceStatus(p.plantID, date);

    const color = getPlantInfoStatus(p);

    return `
        <tr data-plant="${p.plantID}">
            <td>${p.serialNo}</td>
            <td>${p.plantID}</td>
            <td class="${color}">${p.plantName}</td>
            <td>${p.kld}</td>
            <td>${p.zones}</td>

            <td><button class="btn-status ${plantOpStatus} plant-op-btn"
                onclick="openPlantOperation(${p.plantID}, '${date}', '${plantOpStatus}')">
                ${plantOpStatus}</button></td>

            <td>
                <button class="btn-status ${labOpStatus} lab-op-btn"
                    onclick="openLabOperation(${p.plantID}, '${date}', '${labOpStatus}')"
                    ${p.codAndBodSenserDate == null ? "disabled style='background:#9ca3af; cursor:not-allowed'" : ""}>
                    ${labOpStatus}
                </button>
            </td>

            <td><button class="btn-status ${empOpStatus} att-op-btn"
                onclick="openAttendance(${p.plantID}, '${date}', '${empOpStatus}')">
                ${empOpStatus}</button></td>
        </tr>
    `;
}

/* ------------------ PARTIAL ROW UPDATE HELPERS ------------------ */

async function updatePlantOpCell(plantId) {
    const date = reportDateInput.value;
    const btn = document.querySelector(
        `tr[data-plant='${plantId}'] .plant-op-btn`
    );
    if (!btn) return;

    const status = await getPlantStatus(plantId, date);
    btn.className = `btn-status ${status} plant-op-btn`;
    btn.textContent = status;
}

async function updateLabOpCell(plantId) {
    const date = reportDateInput.value;
    const btn = document.querySelector(
        `tr[data-plant='${plantId}'] .lab-op-btn`
    );
    if (!btn) return;

    const status = await getLabStatus(plantId, date);
    btn.className = `btn-status ${status} lab-op-btn`;
    btn.textContent = status;
}

async function updateAttendanceCell(plantId) {
    const date = reportDateInput.value;
    const btn = document.querySelector(
        `tr[data-plant='${plantId}'] .att-op-btn`
    );
    if (!btn) return;

    const status = await getAttendanceStatus(plantId, date);
    btn.className = `btn-status ${status} att-op-btn`;
    btn.textContent = status;
}



    async function renderTable(date) {
        await safeRender(date);  // ðŸš€ USE SAFE RENDER
    }

    /* ---------------------------- FILTER + URL ---------------------------- */

    function updateURL() {
        let url = `index.html?date=${reportDateInput.value}`;
        if (filterType && filterValue)
            url += `&filter=${filterType}&value=${filterValue}`;
        history.replaceState({}, "", url);

        if (filterType && filterValue) {
            localStorage.setItem("plantFilterType", filterType);
            localStorage.setItem("plantFilterValue", filterValue);
        } else {
            localStorage.removeItem("plantFilterType");
            localStorage.removeItem("plantFilterValue");
        }
    }

    function applyFilter(skipUrlUpdate = false) {
        if (filterType === "id" && filterValue)
            allPlants = originalPlants.filter(p => String(p.plantID) === String(filterValue));
        else if (filterType === "zone" && filterValue)
            allPlants = originalPlants.filter(p => String(p.zones) === String(filterValue));
        else
            allPlants = [...originalPlants];

        if (!allPlants.length) {
            plantTableBody.innerHTML = `<tr><td colspan="8" class="no-data">No Data Found</td></tr>`;
            return;
        }

        if (!skipUrlUpdate) updateURL();

        renderTable(reportDateInput.value);
    }

    /* ---------------------------- FETCH PLANTS ---------------------------- */

    async function fetchPlants() {
        plantTableBody.innerHTML = `<tr><td colspan="8" class="no-data">Refreshing...</td></tr>`;
        try {
            const res = await fetch("/api/plants");
            originalPlants = await res.json();
            applyFilter(true);
        } catch (err) {
            console.error("fetchPlants err", err);
            plantTableBody.innerHTML = `<tr><td colspan="8" class="no-data">Error loading plants</td></tr>`;
        }
    }

    /* ---------------------------- SEARCH + RESET ---------------------------- */

    document.getElementById("searchIdBtn").onclick = () => {
        const val = document.getElementById("plantIDInput").value.trim();
        if (!val) return alert("Enter a Plant ID to search");
        filterType = "id";
        filterValue = val;
        applyFilter();
    };

    document.getElementById("searchZoneBtn").onclick = () => {
        const val = document.getElementById("zoneInput").value.trim();
        if (!val) return alert("Enter a Zone to search");
        filterType = "zone";
        filterValue = val;
        applyFilter();
    };

    document.getElementById("resetBtn").onclick = () => {
        document.getElementById("plantIDInput").value = "";
        document.getElementById("zoneInput").value = "";
        filterType = null;
        filterValue = null;
        updateURL();
        applyFilter();
    };

    /* ---------------------------- ENTER KEY ---------------------------- */

    document.getElementById("plantIDInput").addEventListener("keypress", e => {
        if (e.key === "Enter") document.getElementById("searchIdBtn").click();
    });

    document.getElementById("zoneInput").addEventListener("keypress", e => {
        if (e.key === "Enter") document.getElementById("searchZoneBtn").click();
    });

    /* ---------------------------- DATE CHANGE ---------------------------- */

    reportDateInput.addEventListener("change", () => {
        updateURL();
        renderTable(reportDateInput.value);
    });

    /* ---------------------------- SSE ---------------------------- */

    function startSSE() {
    try {
        if (sseConnection) return; // ðŸš« prevent duplicate connections
        sseConnection = new EventSource("/api/events/updates");
        const evt = sseConnection;


        evt.addEventListener("DATA_UPDATE", async (e) => {
        let data;
        try {
            data = JSON.parse(e.data);
        } catch {
            return; // ignore bad event
        }


        const row = document.querySelector(
            `tr[data-plant='${data.plantId}']`
        );
        if (!row) return;

        if (data.entity === "PLANT_OP") {
            await updatePlantOpCell(data.plantId);
        }

        if (data.entity === "LAB") {
            await updateLabOpCell(data.plantId);
        }

        if (data.entity === "EMPLOYEE" || data.entity === "EMP_OP") {
            await updateAttendanceCell(data.plantId);
        }

        if (data.entity === "PLANT") {
            fetchPlants();
        }
    });


        evt.onerror = () => {
            sseConnection.close();
            sseConnection = null;
            setTimeout(startSSE, 2000);
        };

    } catch (e) {
        console.warn("SSE failed:", e);
    }
}


    startSSE();
    fetchPlants();

</script>
</body>
</html>
