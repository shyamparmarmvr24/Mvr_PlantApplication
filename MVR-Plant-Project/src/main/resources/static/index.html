<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="https://mvrtech.org/MVR_Company_Logo%20copy.png">

    <title>MVR TECHNOLOGY - Plant Management Dashboard</title>

    <style>
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            margin:0; padding:0;
            background:#f5f7fa;
            color:#222;
        }

        header {
            position: sticky;
            top: 0;
            z-index: 999;
            display:flex;
            justify-content:space-between;
            align-items:center;
            background: linear-gradient(90deg,#0f172a,#0ea5e9);
            padding:14px 20px;
            color:#fff;
            gap:12px;
        }

        .logo-left {
            display:flex;
            align-items:center;
            gap:12px;
            cursor:pointer;
        }

        .logo-left img {
            height:28px;
            width:auto;
            display:block;
        }

        .logo-left .brand {
            font-family: "Times New Roman", Times, serif !important;
            font-size:25px;
            font-weight:700;
            letter-spacing:1px;
            color:#ffffff;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.25);
        }

        .date-picker { display:flex; align-items:center; gap:8px; }
        .date-picker label { font-weight:600; color:#fff; }
        .date-picker input[type="date"]{
            padding:6px 10px;
            border-radius:6px;
            border:1px solid #ddd;
            background:#fff;
            color:#000;
            font-size:15px;
            cursor:pointer;
        }

        .dashboard-title {
            text-align:center;
            margin:18px auto 6px;
            max-width:1100px;
            font-size:26px;
            color:#0f172a;
            font-weight:700;
            font-family: "Times New Roman", Times, serif !important;
        }

        .container {
            max-width:1100px;
            margin:8px auto 40px;
            padding:0 16px;
        }

        .search-section {
            display:flex;
            gap:12px;
            flex-wrap:wrap;
            margin-bottom:18px;
            align-items:center;
        }

        .search-box { flex:1; min-width:180px; display:flex; }

        .search-box input {
            flex:1;
            padding:10px;
            border:1px solid #ccc;
            border-radius:6px 0 0 6px;
            font-size:15px;
        }

        .search-box button {
            padding:10px 16px;
            border:none;
            background:#0369a1;
            color:white;
            font-size:15px;
            border-radius:0 6px 6px 0;
            cursor:pointer;
        }

        .addBtn {
            padding:10px 16px;
            background:#059669;
            color:white;
            border:none;
            border-radius:6px;
            font-size:15px;
            cursor:pointer;
        }

        table {
            width:100%;
            border-collapse:collapse;
            background:white;
            border-radius:8px;
            overflow:hidden;
            box-shadow:0 4px 12px rgba(2,6,23,0.06);
            table-layout: fixed;
        }

        thead {
            display:table;
            width:100%;
            table-layout:fixed;
        }

        tbody {
            display:block;
            max-height: calc(100vh - 260px);
            overflow-y:auto;
            width:100%;
        }

        tbody tr {
            display:table;
            width:100%;
            table-layout:fixed;
        }

        th, td {
            padding:14px 12px;
            text-align:center;
            border-bottom:1px solid #f1f5f9;
            white-space: nowrap;
        }

        th:nth-child(1), td:nth-child(1) { width: 8%; }
        th:nth-child(2), td:nth-child(2) { width: 12%; }
        th:nth-child(3), td:nth-child(3) { width: 22%; }
        th:nth-child(4), td:nth-child(4) { width: 12%; }
        th:nth-child(5), td:nth-child(5) { width: 10%; }
        th:nth-child(6), td:nth-child(6) { width: 22%; }
        th:nth-child(7), td:nth-child(7) { width: 14%; }

        th {
            background:#0369a1;
            color:white;
            font-weight:600;
            text-transform:uppercase;
            font-size:13px;
        }

        tr:nth-child(even){ background:#fbfdff; }
        tr:hover { background:#f0f9ff; }

        .progress-bar {
            width:170px;
            height:14px;
            background:#e6eef8;
            border-radius:8px;
            overflow:hidden;
            margin:auto;
        }

        .progress-fill { height:100%; width:0; transition:width .25s ease-in-out; }
        .progress-red{ background:#ef4444; }
        .progress-yellow{ background:#f59e0b; }
        .progress-green{ background:#10b981; }

        .btn-update {
            padding: 8px 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            min-width: 100px;
            text-align: center;
        }

        .btn-update.update { background:#ef4444; color:white; }
        .btn-update.pending { background:#f59e0b; color:#111; }
        .btn-update.view { background:#10b981; color:white; }

        .no-data { text-align:center; padding:18px; color:#6b7280; }

    </style>
</head>

<body>

<header>
    <div class="logo-left" onclick="redirectHome()">
        <img src="https://mvrtech.org/MVR_Company_Logo%20copy.png" alt="MVR Logo" />
        <div class="brand">MVR TECHNOLOGY</div>
    </div>

    <div class="date-picker">
        <label for="reportDate">Date:</label>
        <input type="date" id="reportDate" />
    </div>
</header>

<div class="dashboard-title">Plant Management Dashboard</div>

<div class="container">

    <div class="search-section">
        <div class="search-box">
            <input type="number" id="plantIDInput" placeholder="Search by Plant ID" min="1" />
            <button id="searchIdBtn">Search</button>
        </div>

        <div class="search-box">
            <input type="number" id="zoneInput" placeholder="Search by Zone" min="1" />
            <button id="searchZoneBtn">Search</button>
        </div>

        <button class="addBtn" id="resetBtn" style="background:#6b7280;">Reset</button>
    </div>

    <table>
        <thead>
        <tr>
            <th>S.No</th>
            <th>Plant ID</th>
            <th>Name</th>
            <th>KLD</th>
            <th>Zone</th>
            <th>Progress</th>
            <th>Action</th>
        </tr>
        </thead>

        <tbody id="plantTableBody">
        <tr><td colspan="7" class="no-data">Loading...</td></tr>
        </tbody>
    </table>

</div>

<script>

    // ----- PROGRESS FIELD LIST ------
    const backendFields = [
        "sludgeTankLevelAm","sludgeTankLevelPm","sludgeReceived","noOfTrips","sludgeProcessed",
        "biocharProduced","plantRunningHrs","solarIntegration",

        "powerReadingAmImport","powerReadingAmExport","powerReadingPmImport","powerReadingPmExport",
        "powerReadingAm","powerReadingPm",

        "powerConsumed",

        "dgReadingAm","dgReadingPm","dgDiesalPercentageAm","dgDiesalPercentagePm","dgRunHours",

        "vehicleReadingAm","vehicleReadingPm","vehicleFuelLevel",

        "polymerUsage","pillets","flowMeterReadingAm","flowMeterReadingPm","cod","bod","tn","temperature","tss","ph"
    ];

    function calculateProgress(op) {
        const total = op.solarIntegration === true ? 31 : 29;
        let filled = 0;

        backendFields.forEach(f => {
            if (op.solarIntegration === true &&
                (f === "powerReadingAm" || f === "powerReadingPm")) return;

            if (op.solarIntegration === false &&
                (f === "powerReadingAmImport" || f === "powerReadingAmExport" ||
                 f === "powerReadingPmImport" || f === "powerReadingPmExport")) return;

            if (op[f] !== null && op[f] !== undefined && op[f] !== "") filled++;
        });

        return Math.min(100, Math.round((filled / total) * 100));
    }

    // ---------------- PAGE VARIABLES ---------------- //
   const plantTableBody = document.getElementById("plantTableBody");
const reportDateInput = document.getElementById("reportDate");

// ---------------- DATE LIMIT (Correct implementation) ---------------- //
const today = new Date().toISOString().split("T")[0];
reportDateInput.max = today;

const urlDate = new URLSearchParams(window.location.search).get("date");
reportDateInput.value = (urlDate && urlDate <= today) ? urlDate : today;

let allPlants = [];
    let originalPlants = [];   // keeps copy for reset
    let cachedOps = {};

    let filterType = null;
    let filterValue = null;

<!--    const today = new Date().toISOString().split("T")[0];-->
<!--    reportDateInput.value = today;-->

    // ---------------- FETCH PLANTS ---------------- //
    async function fetchPlants() {
        plantTableBody.innerHTML = `<tr><td colspan="7" class="no-data">Refreshing...</td></tr>`;

        try {
            const res = await fetch("/api/plants");
            allPlants = await res.json();
            originalPlants = [...allPlants];

            // Apply existing filter again after refresh
            applyFilter(true);
        } catch (e) {
            plantTableBody.innerHTML =
                `<tr><td colspan="7" class="no-data">Error loading plants</td></tr>`;
        }
    }

    // ---------------- FETCH OP ---------------- //
    async function fetchOp(plantID, date) {
        const key = plantID + "_" + date;

        if (cachedOps[key]) return cachedOps[key];

        try {
            const res = await fetch(`/api/operations/plant/${plantID}?date=${date}`);
            const text = await res.text();

            if (!text || !text.trim()) {
                cachedOps[key] = { progress: 0, status: "update", op: {} };
                return cachedOps[key];
            }

            const op = JSON.parse(text);
            const progress = calculateProgress(op);

            const status = progress === 100 ? "view"
                        : progress > 0 ? "pending"
                        : "update";

            cachedOps[key] = { progress, status, op };
            return cachedOps[key];

        } catch {
            cachedOps[key] = { progress: 0, status: "update", op: {} };
            return cachedOps[key];
        }
    }

    // ---------------- RENDER ROW ---------------- //
    function makeRowHtml(p, opData) {
        const color = opData.progress === 100 ? "progress-green"
                    : opData.progress > 0 ? "progress-yellow"
                    : "progress-red";

        const btnLabel = opData.status[0].toUpperCase() + opData.status.slice(1);

        const urlFilter = filterType ? `&filter=${filterType}&value=${filterValue}` : "";
        const date = reportDateInput.value;

        const page =
            opData.status === "view"
                ? "view-operation.html"
                : "update-operation.html";

        return `
        <tr data-plant="${p.plantID}">
            <td>${p.serialNo}</td>
            <td>${p.plantID}</td>
            <td>${p.plantName}</td>
            <td>${p.kld}</td>
            <td>${p.zones}</td>

            <td>
                <div class="progress-bar">
                    <div class="progress-fill ${color}" style="width:${opData.progress}%"></div>
                </div>
                <small>${opData.progress}%</small>
            </td>

            <td>
                <button class="btn-update ${opData.status}"
                    onclick="window.location.href='${page}?plantID=${p.plantID}&date=${date}${urlFilter}'">
                    ${btnLabel}
                </button>
            </td>
        </tr>`;
    }

    // ---------------- RENDER TABLE ---------------- //
    async function renderTable(date) {

        if (!allPlants.length) return;

        plantTableBody.innerHTML = "";

        allPlants.forEach((p, index) => {
            p.serialNo = index + 1;

            plantTableBody.insertAdjacentHTML("beforeend", `
                <tr data-plant="${p.plantID}">
                    <td>${p.serialNo}</td>
                    <td>${p.plantID}</td>
                    <td>${p.plantName}</td>
                    <td>${p.kld}</td>
                    <td>${p.zones}</td>
                    <td><div class="progress-bar"><div class="progress-fill" style="width:0%"></div></div><small>0%</small></td>
                    <td><button class="btn-update pending">...</button></td>
                </tr>
            `);
        });

        allPlants.forEach(async p => {
            const opData = await fetchOp(p.plantID, date);
            const row = plantTableBody.querySelector(`tr[data-plant="${p.plantID}"]`);
            if (row) row.outerHTML = makeRowHtml(p, opData);
        });
    }

    // ---------------- APPLY FILTER ---------------- //
    function applyFilter(skipUrlUpdate = false) {
    if (filterType === "id" && filterValue) {
        allPlants = originalPlants.filter(p => p.plantID == filterValue);

        if (allPlants.length === 0) {
            plantTableBody.innerHTML =
                `<tr><td colspan="7" class="no-data">Plant Not Found</td></tr>`;
            return;
        }
    }

    else if (filterType === "zone" && filterValue) {
        allPlants = originalPlants.filter(p => p.zones == filterValue);

        if (allPlants.length === 0) {
            plantTableBody.innerHTML =
                `<tr><td colspan="7" class="no-data">Plants Not Found</td></tr>`;
            return;
        }
    }

    else {
        allPlants = [...originalPlants];
    }

    if (!skipUrlUpdate) updateURL();
    renderTable(reportDateInput.value);
}


    function updateURL() {
        let url = `index.html?date=${reportDateInput.value}`;
        if (filterType && filterValue) url += `&filter=${filterType}&value=${filterValue}`;
        history.replaceState({}, "", url);
    }

    // ---------------- SEARCH EVENTS ---------------- //
    document.getElementById("searchIdBtn").onclick = () => {
        filterType = "id";
        filterValue = document.getElementById("plantIDInput").value.trim();
        applyFilter();
    };

    document.getElementById("searchZoneBtn").onclick = () => {
        filterType = "zone";
        filterValue = document.getElementById("zoneInput").value.trim();
        applyFilter();
    };

    // ENTER key search
    document.getElementById("plantIDInput").addEventListener("keypress", e => {
        if (e.key === "Enter") document.getElementById("searchIdBtn").click();
    });

    document.getElementById("zoneInput").addEventListener("keypress", e => {
        if (e.key === "Enter") document.getElementById("searchZoneBtn").click();
    });

    // ---------------- RESET ---------------- //
    document.getElementById("resetBtn").onclick = () => {
        document.getElementById("plantIDInput").value = "";
        document.getElementById("zoneInput").value = "";
        filterType = null;
        filterValue = null;
        cachedOps = {};
        applyFilter();
    };

    // ---------------- DATE CHANGE ---------------- //
    reportDateInput.addEventListener("change", () => {
        cachedOps = {};
        updateURL();
        renderTable(reportDateInput.value);
    });

    // ---------------- REDIRECT HOME (retain filters) ---------------- //
    function redirectHome() {
        updateURL();
        window.location.href = location.href;
    }

    // ---------------- SSE AUTO REFRESH ---------------- //
    function startSSE() {
        const evt = new EventSource("/api/events/updates");

        evt.onmessage = () => {
            cachedOps = {};
            fetchPlants();
        };

        evt.onerror = () => setTimeout(startSSE, 2000);
    }

    startSSE();
    fetchPlants();

</script>
</body>
</html>
