<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <link rel="icon" href="mvrlogo.png">
    <title>Update Plant Operation</title>
    <style>
        :root{
          --blue:#0369a1;
          --muted:#6b7280;
          --bg:#f5f7fa;
          --card:#fff;
          --green:#059669;
          --yellow:#d97706;
          --red:#dc2626;
          --input-border:#d1d5db;
          --back-gray:#94a3b8;
        }
        html,body{height:100%;margin:0;font-family: "Segoe UI",sans-serif;background:var(--bg);}
        .wrap{display:flex;justify-content:center;padding:18px;}
        .card{width:100%;max-width:980px;background:var(--card);border-radius:12px;padding:22px;box-shadow:0 10px 30px rgba(2,6,23,0.06);}
        h1{margin:0;text-align:center;color:var(--blue);font-size:20px}
        .top-info{ text-align:center;margin:8px 0 18px;font-weight:700;color:#374151}
        table{width:100%;border-collapse:collapse;margin-top:8px}
        table th, table td{padding:10px;border:1px solid #eef3f7;vertical-align:middle}
        table th{background:var(--blue);color:white;text-align:left;width:320px;font-size:14px}
        .input{width:100%;padding:8px;border-radius:6px;border:1px solid var(--input-border);box-sizing:border-box;font-size:14px}
        textarea.input{min-height:84px;resize:vertical}
        .row{display:flex;gap:12px;align-items:center}
        .col{flex:1}
        .inline-pair{display:grid;grid-template-columns:1fr 1fr;gap:8px;align-items:center}
        .vehicle-title{margin-top:18px;font-weight:700;color:#0f172a}
        .buttons{text-align:center;margin-top:18px;display:flex;gap:12px;align-items:center;justify-content:center}
        .btn{padding:10px 18px;border-radius:8px;border:none;color:white;cursor:pointer;font-weight:700;margin:0 6px;min-width:120px}
        .btn-back{background:var(--back-gray);border-radius:10px}
        .btn-submit{background:var(--green);border-radius:10px}
        .status-pill{display:inline-block;padding:6px 10px;border-radius:999px;color:white;font-weight:700;font-size:13px}
        .status-red{background:var(--red)}
        .status-yellow{background:var(--yellow)}
        .status-green{background:var(--green)}
        .muted-note{color:var(--muted);font-size:13px;margin-top:6px}
        .vehicle-block{margin-top:10px;border-radius:8px;padding:10px;border:1px solid #eef3f7;background:#fbfdff}
        .small{font-size:13px;color:#374151}
        label.switch{display:inline-flex;align-items:center;gap:8px;cursor:pointer}
        .two-inline{display:flex;gap:8px}
        .field-inline {display:flex;gap:8px;align-items:center}
        .label-inline {width:170px; font-weight:700}
        @media (max-width:900px){
          .inline-pair{grid-template-columns:1fr}
          table th{width:200px}
        }

        .section-header td{
          background: #0f172a;   /* Navy dark */
          color: #ffffff;
          font-weight: 700;
          font-size: 15px;
          padding: 12px 10px;
        }
        /* gap AFTER each section header */
        .section-header + tr td,
        .section-header + tr th {
          padding-top: 18px;
        }

        /* optional extra spacing BEFORE next section header */
        tr.section-header {
          border-top: 14px solid #f5f7fa;  /* background gap */
        }

        .section-header td {
          border-radius: 6px;
        }
.input-warning {
  color: #dc2626;      /* red */
  font-size: 12px;
  margin-top: 4px;
  display: none;       /* hidden by default */
}

  .trip-delete {
  position: absolute;
  top: 6px;
  right: 8px;
  cursor: pointer;
  font-size: 18px;
  color: #dc2626;
  font-weight: bold;
}
.trip-delete:hover {
  transform: scale(1.1);
}


    </style>
</head>
<body>
<div class="wrap">
    <div class="card">
        <h1>Update Plant Operation</h1>
        <div id="info" class="top-info">Loading...</div>

        <table aria-describedby="plant-fields">
            <thead>
            <tr>
                <th>Field</th>
                <th>Value</th>
            </tr>
            </thead>
            <tbody id="fieldsBody"></tbody>
        </table>

        <table style="width:100%;border-collapse:collapse;margin-top:18px">
            <tr class="section-header">
                <td colspan="2">Vehicle Operations</td>
            </tr>
        </table>

        <div id="vehicleSection" style="margin-top:8px"></div>

        <table style="width:100%;border-collapse:collapse;margin-top:18px">
            <tr class="section-header">
                <td colspan="2">Private Vehicles</td>
            </tr>

            <tr>
                <th>Private Vehicles Present?</th>
                <td>
                    <label class="switch">
                        <input id="privateToggle" type="checkbox">
                        <span class="small">Yes</span>
                    </label>
                </td>
            </tr>

            <tr>
                <th>No. of Trips</th>
                <td>
                    <input
                            id="privateTrips"
                            class="input"
                            type="number"
                            min="0"
                            max="10"
                            placeholder="Enter No Of Trips Private"/>
                    <div id="privateTripsWarning" class="input-warning">
                        Maximum 10 trips allowed
                    </div>

                </td>
            </tr>

            <tr>
                <th>Sludge Collected</th>
                <td>
                    <div class="two-inline">
                        <input id="privateSludge" class="input" placeholder="Sludge (Ltrs)" readonly/>
                        <input id="privateSludgeKgs" class="input" placeholder="Sludge (Kgs)" readonly/>
                    </div>
                </td>
            </tr>

            <!--            <tr>-->
            <!--                <td colspan="2" class="muted-note">-->
            <!--                    Note: <code>sludgeReceived</code> and <code>totalNoOfTrips</code> are computed server-side; not-->
            <!--                    editable here.-->
            <!--                </td>-->
            <!--            </tr>-->
        </table>

        <!-- üîΩ PRIVATE VEHICLE DYNAMIC FORMS -->
        <div id="privateVehicleForms" style="margin-top:16px"></div>


        <div class="buttons" style="margin-top:18px">
            <button id="submitBtn" class="btn btn-submit">Submit</button>
            <button id="backBtn" class="btn btn-back">Back</button>
        </div>

        <div style="text-align:center; margin-top:10px;">
            <span id="statusPill" class="status-pill status-red">No data (0%)</span>
        </div>
    </div>
</div>

<script>



    (function(){
      /* ================== CONFIG ================== */
      const plantFieldDefs = [
        { id: "sludgeTankLevelAm", label: "Sludge Tank Level Morning (Ltrs)", placeholder: "Enter Ltrs" },
        { id: "sludgeProcessed", label: "Sludge Processed (Ltrs)", placeholder: "Enter Ltrs" },
        { id: "sludgeTankLevelPm", label: "Sludge Tank Level Evening (Ltrs)", placeholder: "Enter Ltrs" },
        { id: "biocharProduced", label: "Biochar Produced (Kgs)", placeholder: "Enter Kgs" },
        { id: "plantRunningHrs", label: "Plant Running Hrs (Hrs)", placeholder: "Enter Hrs" },

        // Import (always)
        { id: "powerReadingAmImport", label: "Power Import - Morning (Kwh)", placeholder: "Enter Morning Kwh" },
        { id: "powerReadingPmImport", label: "Power Import - Evening (Kwh)", placeholder: "Enter Evening Kwh" },

        // Power Bill (grouped)
        { id: "powerBill", label: "Power Bill Generated?", type: "checkbox" },
        { id: "lastBillDate", label: "Last Bill Date", type: "date", billField: true },
        { id: "TotalNoOfUnits", label: "Total No. of Units", placeholder: "Enter units", billField: true },
        { id: "totalBillAmount", label: "Total Bill Amount", placeholder: "Enter amount", billField: true },

        // ‚ùå REMOVE THESE TWO COMPLETELY
        { id: "powerReadingAmExport", label: "Solar Power Export - Morning (Kwh)", placeholder: "Enter Morning Kwh", solarExport: true },
        { id: "powerReadingPmExport", label: "Solar Power Export - Evening (Kwh)", placeholder: "Enter Evening Kwh", solarExport: true },

        { id: "dgReadingAm", label: "DG RunHours Morning (Hrs)", placeholder: "Enter Hrs" },
        { id: "dgReadingPm", label: "DG RunHours Evening (Hrs)", placeholder: "Enter Hrs" },
        { id: "dgDiesalPercentageAm", label: "DG Diesel % Morning", placeholder: "%" },
        { id: "dgDiesalPercentagePm", label: "DG Diesel % Evening", placeholder: "%" },

        { id: "polymerUsage", label: "Polymer Usage (Grms)", placeholder: "Enter Grms" },
        { id: "polymerStock", label: "Polymer Stock (Kgs)", placeholder: "Enter Kgs" },
        { id: "pillets", label: "Pillets Usage (Kgs)", placeholder: "Enter Kgs" },
        { id: "pilletsStock", label: "Pillets Stock (Kgs)", placeholder: "Enter Kgs" },

        { id: "remarks", label: "Remarks", type: "textarea", placeholder: "Enter remarks" } // free-text, not counted
      ];

      let sseConnection = null;
      let isDirty = false;
      let isSaving = false;


      const endpoints = {
        plantGet: (plantId, date) => `/api/operations/plant/${plantId}?date=${encodeURIComponent(date)}`,
        plantPut: (plantId, date) => `/api/operations/${plantId}?date=${encodeURIComponent(date)}`,
        vehiclesByPlant: (plantId) => `/api/vehicle-operations/plant/${plantId}/vehicles`,
        vehicleOpGet: (vehicleId, date) => `/api/vehicle-operations/${vehicleId}?date=${encodeURIComponent(date)}`,
        vehicleOpPut: (plantId, vehicleId, date) => `/api/vehicle-operations/${plantId}/${vehicleId}?date=${encodeURIComponent(date)}`
      };

      /* ================== DOM ================== */
      const params = new URLSearchParams(window.location.search);
      const plantID = params.get("plantID");
      const date = params.get("date");

      const infoEl = document.getElementById("info");
      const fieldsBody = document.getElementById("fieldsBody");
      const vehicleSection = document.getElementById("vehicleSection");
      const submitBtn = document.getElementById("submitBtn");
      const backBtn = document.getElementById("backBtn");
      const statusPill = document.getElementById("statusPill");
      const privateToggle = document.getElementById("privateToggle");
      const privateTripsEl = document.getElementById("privateTrips");
      const privateSludgeEl = document.getElementById("privateSludge");
      const privateSludgeKgsEl = document.getElementById("privateSludgeKgs");
      privateSludgeEl.disabled = true;
      privateSludgeKgsEl.disabled = true;



      /* ================== STATE ================== */
      let currentOp = {};
      let vehicles = [];
      let vehicleOps = {};
      let plantSolar = false;   // ‚úÖ plant master solar flag
      let existingPrivateVehicles = [];
      let plantName = "";
      const savedTripCountByVehicle = {};
      let savedPrivateVehicleCount = 0;

      /* ================== HELPERS ================== */
      function escapeHtml(s){ return String(s ?? ""); }

      function createInput(id, placeholder, value, opts = {}) {
        const input = document.createElement('input');
        input.className = "input";
        input.id = id;
        input.placeholder = placeholder || "";
        input.value = value == null ? "" : String(value);
        if(opts.type) input.type = opts.type;
        if(opts.disabled) input.disabled = true;
        return input;
      }
      function createTextarea(id, placeholder, value){
        const ta = document.createElement('textarea');
        ta.className = 'input';
        ta.id = id;
        ta.placeholder = placeholder || "";
        ta.value = value == null ? "" : String(value);
        return ta;
      }

      function numericValid(val){
        if(val === null || val === undefined || String(val).trim() === "") return true;
        return /^\d+(\.\d+)?$/.test(String(val).trim());
      }

      function dateFilled(el){
        return el && String(el.value).trim() !== "";
      }

      function setStatusBadge(percent){
        const p = Math.round(percent);
        statusPill.textContent = p === 0 ? "No data (0%)" : (p === 100 ? "Complete (100%)" : `Partial (${p}%)`);
        statusPill.className = "status-pill " + (p === 0 ? "status-red" : (p === 100 ? "status-green" : "status-yellow"));
        if(p === 0) submitBtn.style.background = "var(--red)";
        else if(p === 100) submitBtn.style.background = "var(--green)";
        else submitBtn.style.background = "var(--yellow)";
      }

      /* ========== COMPLETENESS RULES (as confirmed) ========== */
      function computeCompleteness(){
        let filled = 0, total = 0;

        const alwaysPlant = [
          "sludgeTankLevelAm",
          "sludgeTankLevelPm",
          "sludgeProcessed",
          "biocharProduced",
          "plantRunningHrs",
          "dgReadingAm",
          "dgReadingPm",
          "dgDiesalPercentageAm",
          "dgDiesalPercentagePm",
          "polymerUsage",
          "polymerStock",
          "pillets",
          "pilletsStock"
        ];
        alwaysPlant.forEach(id=>{
          total++;
          const el = document.getElementById(id);
          if(el && String(el.value).trim() !== "") filled++;
        });

        /* ================= POWER READINGS ================= */

        // Import readings are ALWAYS counted
        ["powerReadingAmImport", "powerReadingPmImport"].forEach(id => {
          total++;
          const el = document.getElementById(id);
          if (el && String(el.value).trim() !== "") filled++;
        });

        // Export readings ONLY when solar = true
       if (plantSolar) {
          ["powerReadingAmExport", "powerReadingPmExport"].forEach(id => {
            total++;
            if (document.getElementById(id)?.value) filled++;
          });
        }


        /* ================= POWER BILL ================= */

        const billChk = document.getElementById("powerBill");

        // powerBill Boolean is ALWAYS counted
        total++;
        if (billChk && billChk.checked !== null) {
          filled++; // checkbox itself is answered (true or false)
        }

        // Extra bill fields ONLY when powerBill = true
        if (billChk && billChk.checked) {
          ["lastBillDate", "TotalNoOfUnits", "totalBillAmount"].forEach(id => {
            total++;
            const el = document.getElementById(id);
            if (el && String(el.value).trim() !== "") filled++;
          });
        }

        if (privateToggle.checked) {
          total += 3;

          const pvTrips = Number(privateTripsEl.value || 0);

          // trips field
          filled++; // checkbox answered by user

          if (pvTrips === 0) {
            // sludge not required when 0 trips
            filled += 2;
          } else {
            if (String(privateSludgeEl.value).trim() !== "") filled++;
            if (String(privateSludgeKgsEl.value).trim() !== "") filled++;
          }
        }


        if (privateToggle.checked && Number(privateTripsEl.value) > 0) {
          const pvCount = Math.max(
          Number(privateTripsEl.value || 0),
          savedPrivateVehicleCount,
          document.querySelectorAll("#privateVehicleForms .vehicle-block").length
        );

        for (let i = 0; i < pvCount; i++) {
            total += 2;
            if (document.getElementById(`pv_ltrs_${i}`)?.value) filled++;
            if (document.getElementById(`pv_kgs_${i}`)?.value) filled++;
          }
        }

        /* ================= WATER DETAILS ================= */

        const waterUsedChk = document.getElementById("waterUsed");

        if (waterUsedChk) {
          // checkbox itself counts as answered
          total++;
          filled++;

          if (waterUsedChk.checked) {
            ["waterFilledDate", "waterLtrs", "totalWaterAmount"].forEach(id => {
              total++;
              const el = document.getElementById(id);
              if (el && String(el.value).trim() !== "") filled++;
            });
          }
        }


        vehicles.forEach(v=>{
          const vid = String(v.vehicleID);
          const am = document.getElementById(`am_${vid}`);
          const pm = document.getElementById(`pm_${vid}`);
          const fuel = document.getElementById(`fuel_${vid}`);
          const lastFuel = document.getElementById(`lastFuel_${vid}`);
          const lastFuelDate = document.getElementById(`lastFuelDate_${vid}`);
          const trips = document.getElementById(`trips_${vid}`);
          const sludge = document.getElementById(`sludge_${vid}`);
          const sludgeKgs = document.getElementById(`sludgeKgs_${vid}`);

            total += 6;
            if(am && String(am.value).trim() !== "") filled++;
            if(pm && String(pm.value).trim() !== "") filled++;
            if(fuel && String(fuel.value).trim() !== "") filled++;

            const tripCount = Number(trips?.value || 0);
            // ---- TRIPS FIELD ----
            if (tripCount === 0) {
              // trips explicitly 0 ‚Üí auto satisfied
              filled++;
            } else if (tripCount > 0) {
              // user must answer trips
              filled++;
            }

            // ---- SLUDGE FIELDS ----
            if (tripCount === 0) {
              // sludge not required when no trips
              filled += 2;
            } else {
              // sludge required only when trips > 0
              if (sludge && String(sludge.value).trim() !== "") filled++;
              if (sludgeKgs && String(sludgeKgs.value).trim() !== "") filled++;
            }



          if(lastFuel && lastFuel.checked)
            {
              total += 4; // checkbox + date + filledLiters + currentOdo

              // checkbox counts
              filled++;

              // date
              if(lastFuelDate && String(lastFuelDate.value).trim() !== "") filled++;

              // filled liters
              const filledEl = document.getElementById(`filledLiters_${vid}`);
              if(filledEl && String(filledEl.value).trim() !== "") filled++;

              // ‚úÖ current odometer
              const odoEl = document.getElementById(`currentOdo_${vid}`);
              if(odoEl && String(odoEl.value).trim() !== "") filled++;
            }

        });

        const pct = total === 0 ? 0 : Math.round((filled / total) * 100);
        return pct;
      }

      /* ================== RENDER PLANT FIELDS ================== */
     function renderPlantFields(){
  fieldsBody.innerHTML = "";

  /* ================= 1Ô∏è‚É£ SLUDGE REPORT ================= */
  fieldsBody.innerHTML += `
    <tr class="section-header"><td colspan="2">Sludge Report</td></tr>

    <tr>
      <th>Sludge Tank Level (Ltrs)</th>
      <td>
        <div class="two-inline">
          ${createInput("sludgeTankLevelAm","Enter Morning Tank Level",currentOp.sludgeTankLevelAm).outerHTML}
          ${createInput("sludgeTankLevelPm","Enter Evening Tank Level",currentOp.sludgeTankLevelPm).outerHTML}
        </div>
      </td>
    </tr>

    <tr>
      <th>Sludge Processed (Ltrs)</th>
      <td>${createInput("sludgeProcessed","Enter Sludge Process Ltrs",currentOp.sludgeProcessed).outerHTML}</td>
    </tr>

    <tr>
      <th>Plant Running Hrs (Hrs)</th>
      <td>${createInput("plantRunningHrs","Enter Plant Running Hrs (Hrs)",currentOp.plantRunningHrs).outerHTML}</td>
    </tr>

    <tr>
      <th>Biochar Produced (Kgs)</th>
      <td>${createInput("biocharProduced","Enter Biochar Produced (Kgs)",currentOp.biocharProduced).outerHTML}</td>
    </tr>
  `;

  /* ================= 2Ô∏è‚É£ POWER & SOLAR REPORT ================= */
  fieldsBody.innerHTML += `
    <tr class="section-header"><td colspan="2">Power & Solar Report</td></tr>

    <tr>
      <th>Power Import (Kwh)</th>
      <td>
        <div class="two-inline">
          ${createInput("powerReadingAmImport","Enter Power Import Morning",currentOp.powerReadingAmImport).outerHTML}
          ${createInput("powerReadingPmImport","Enter Power Import Evening",currentOp.powerReadingPmImport).outerHTML}
        </div>
      </td>
    </tr>
  `;

  /* üîÜ Solar Export ‚Äî ONLY if plant has solar */
  if (plantSolar) {
    fieldsBody.innerHTML += `
      <tr>
        <th>Solar Power Export (Kwh)</th>
        <td>
          <div class="two-inline">
            ${createInput("powerReadingAmExport","Enter Solar Power Morning",currentOp.powerReadingAmExport).outerHTML}
            ${createInput("powerReadingPmExport","Enter Solar Power Evening",currentOp.powerReadingPmExport).outerHTML}
          </div>
        </td>
      </tr>
    `;
  }

  fieldsBody.innerHTML += `
    <tr>
      <th>Power Bill Generated?</th>
      <td><input type="checkbox" id="powerBill" ${currentOp.powerBill ? "checked" : ""}></td>
    </tr>

    <tr>
      <th>Last Bill Date</th>
      <td><input type="date"
       class="input"
       id="lastBillDate"
       value="${currentOp.lastBillDate || ""}"
       max="${new Date().toISOString().split('T')[0]}">
</td>
    </tr>

    <tr>
      <th>Power Bill Details</th>
      <td>
        <div class="two-inline">
          ${createInput("TotalNoOfUnits","Enter Total Units",currentOp.TotalNoOfUnits).outerHTML}
          ${createInput("totalBillAmount","Enter Total Amount Paid",currentOp.totalBillAmount).outerHTML}
        </div>
      </td>
    </tr>
  `;

  togglePowerBillFields(!!currentOp.powerBill);

  /* ================= 3Ô∏è‚É£ DG REPORT ================= */
  fieldsBody.innerHTML += `
    <tr class="section-header"><td colspan="2">DG Report</td></tr>

    <tr>
      <th>DG RunHours (Hrs)</th>
      <td>
        <div class="two-inline">
          ${createInput("dgReadingAm","DG RunHours Morning (Hrs)",currentOp.dgReadingAm).outerHTML}
          ${createInput("dgReadingPm","DG RunHours Evening (Hrs)",currentOp.dgReadingPm).outerHTML}
        </div>
      </td>
    </tr>

    <tr>
      <th>DG Diesel %</th>
      <td>
        <div class="two-inline">
          ${createInput("dgDiesalPercentageAm","DG Diesel % Morning",currentOp.dgDiesalPercentageAm).outerHTML}
          ${createInput("dgDiesalPercentagePm","DG Diesel % Evening",currentOp.dgDiesalPercentagePm).outerHTML}
        </div>
      </td>
    </tr>
  `;

    /* ================= 3Ô∏è‚É£ WATER DETAILS ================= */
  fieldsBody.innerHTML += `
    <tr class="section-header"><td colspan="2">Water Tanker Details</td></tr>

    <tr>
      <th>Water Tanker Used?</th>
      <td>
        <label class="switch">
          <input type="checkbox" id="waterUsed" ${currentOp.waterUsed ? "checked" : ""}>
          <span class="small">Yes</span>
        </label>
      </td>
    </tr>

    <tr>
      <th>Water Tanker Filled Date</th>
      <td>
        <input
          type="date"
          class="input"
          id="waterFilledDate"
          value="${currentOp.waterFilledDate || ""}"
          max="${new Date().toISOString().split('T')[0]}">
      </td>
    </tr>

    <tr>
      <th>Water Tanker Ltrs & Amount</th>
      <td>
        <div class="two-inline">
          <input id="waterLtrs" class="input" placeholder="Enter Volume in Ltrs"
                 value="${currentOp.waterLtrs ?? ""}">
          <input id="totalWaterAmount" class="input" placeholder="Enter Total Amount"
                 value="${currentOp.totalWaterAmount ?? ""}">
        </div>
      </td>
    </tr>
  `;


  /* ================= 4Ô∏è‚É£ POLYMER & PILLETS REPORT ================= */
  fieldsBody.innerHTML += `
    <tr class="section-header"><td colspan="2">Polymer & Pillets Report</td></tr>

    <tr>
      <th>Polymer</th>
      <td>
        <div class="two-inline">
          ${createInput("polymerUsage","Polymer Usage (Grms)",currentOp.polymerUsage).outerHTML}
          ${createInput("polymerStock","Polymer Stock (Kgs)",currentOp.polymerStock).outerHTML}
        </div>
      </td>
    </tr>

    <tr>
      <th>Pillets</th>
      <td>
        <div class="two-inline">
          ${createInput("pillets","Pillets Usage (Kgs)",currentOp.pillets).outerHTML}
          ${createInput("pilletsStock","Pillets Stock (Kgs)",currentOp.pilletsStock).outerHTML}
        </div>
      </td>
    </tr>

    <tr>
      <th>Remarks</th>
      <td>${createTextarea("remarks","Enter remarks",currentOp.remarks).outerHTML}</td>
    </tr>
  `;

   const powerBillChk = document.getElementById("powerBill");
    if (powerBillChk) {
      powerBillChk.addEventListener("change", async () => {
          togglePowerBillFields(powerBillChk.checked);

          if (!powerBillChk.checked) {
            await loadLatestPowerBillTillDate();
          }

          setStatusBadge(computeCompleteness());
        });

    }

      const waterUsedChk = document.getElementById("waterUsed");
      const waterDateEl = document.getElementById("waterFilledDate");
      const waterLtrsEl = document.getElementById("waterLtrs");
      const waterAmtEl = document.getElementById("totalWaterAmount");

      function toggleWaterFields(enabled) {
        [waterDateEl, waterLtrsEl, waterAmtEl].forEach(el => {
          if (!el) return;
          el.disabled = !enabled;
          if (!enabled) el.value = "";
        });
      }

      if (waterUsedChk) {
        toggleWaterFields(!!waterUsedChk.checked);

        waterUsedChk.addEventListener("change", async () => {
          toggleWaterFields(waterUsedChk.checked);

          if (!waterUsedChk.checked) {
            await loadLatestWaterTillDate();
          }

          setStatusBadge(computeCompleteness());
        });

  }


}

function renderPrivateVehicleForms(count, existing = []) {
  const container = document.getElementById("privateVehicleForms");
  container.innerHTML = "";

  for (let i = 0; i < count; i++) {
    const pv = existing[i] || existingPrivateVehicles[i] || {};

    const block = document.createElement("div");
    block.className = "vehicle-block";
    block.style.position = "relative";

    block.innerHTML = `
      <span class="trip-delete" title="Delete Vehicle">‚úñ</span>

      <div class="vehicle-title">Private Vehicle ${i + 1}</div>

      <input type="hidden" id="pv_id_${i}" value="${pv.privateVehicleID || ""}">

      <div class="two-inline">
        <input id="pv_number_${i}" class="input" placeholder="Vehicle Number"
               value="${pv.privateVehNumber || ""}">
        <input id="pv_driver_no_${i}" class="input" placeholder="Driver Number"
               value="${pv.driverNumber || ""}">
      </div>

      <div class="two-inline" style="margin-top:6px">
        <input id="pv_driver_name_${i}" class="input" placeholder="Driver Name"
               value="${pv.driverName || ""}">
      </div>

      <div class="two-inline" style="margin-top:6px">
        <input id="pv_ltrs_${i}" class="input" placeholder="Sludge Ltrs"
               value="${pv.receivedSludgeLtrs || ""}">
        <input id="pv_kgs_${i}" class="input" placeholder="Sludge Kgs"
               value="${pv.receivedSludgeKgs || ""}">
      </div>
    `;

    container.appendChild(block);

    // üî• DELETE HANDLER
    block.querySelector(".trip-delete").addEventListener("click", () => {
      deletePrivateVehicle(i);
    });

    block.querySelectorAll("input").forEach(inp => {
      inp.addEventListener("input", updatePrivateSludgeTotals);
    });
  }

  attachEnterNav();
}


function renderTripForms(vehicleId, count, existingTrips = []) {
  const container = document.getElementById(`tripForms_${vehicleId}`);
  if (!container) return;

  container.innerHTML = "";

  for (let i = 0; i < count; i++) {
    const trip = existingTrips[i] || {};

    const row = document.createElement("div");
    row.className = "vehicle-block";
    row.style.marginTop = "8px";
    row.style.position = "relative";

    row.innerHTML = `
      <span class="trip-delete" title="Delete Trip">‚úñ</span>

      <div class="vehicle-title">Trip ${i + 1}</div>

      <input type="hidden" id="trip_id_${vehicleId}_${i}" value="${trip.vehicleTripId || ""}">

      <div class="two-inline">
        <input id="trip_ltrs_${vehicleId}_${i}" class="input" placeholder="Sludge (Ltrs)"
               value="${trip.sludgeCollectLtrs ?? ""}">
        <input id="trip_kgs_${vehicleId}_${i}" class="input" placeholder="Sludge (Kgs)"
               value="${trip.sludgeCollectKgs ?? ""}">
        <input id="trip_time_${vehicleId}_${i}" type="time" class="input"
               value="${trip.tripTime ?? ""}">
      </div>
    `;

    container.appendChild(row);

    row.querySelector(".trip-delete").addEventListener("click", () => {
      deleteTrip(vehicleId, i);
    });

    row.querySelectorAll("input").forEach(inp => {
      inp.addEventListener("input", () => {
        updateVehicleTripSludgeTotals(vehicleId);
        setStatusBadge(computeCompleteness());
      });
    });
  }

  attachEnterNav();
}

async function loadTripDetails(vehicleId, vehicleOpId) {
  try {
    const r = await fetch(`/api/vehicle-trip-details/operation/${vehicleOpId}`);
    if (!r.ok) return;

    const trips = await r.json();
    if (!Array.isArray(trips)) return;

    // üîê store DB count
    savedTripCountByVehicle[vehicleId] = trips.length;

    const tripsInput = document.getElementById(`trips_${vehicleId}`);
    tripsInput.value = trips.length;

    renderTripForms(vehicleId, trips.length, trips);
    updateVehicleTripSludgeTotals(vehicleId);
  } catch (e) {
    console.warn("Failed to load trips", e);
  }
}

function countTripsWithData(vehicleId) {
  const rows = document.querySelectorAll(`#tripForms_${vehicleId} .vehicle-block`);
  let count = 0;

  rows.forEach((_, i) => {
    const ltrs = document.getElementById(`trip_ltrs_${vehicleId}_${i}`)?.value;
    const kgs  = document.getElementById(`trip_kgs_${vehicleId}_${i}`)?.value;
    const time = document.getElementById(`trip_time_${vehicleId}_${i}`)?.value;

    if (
      (ltrs && ltrs.trim() !== "") ||
      (kgs && kgs.trim() !== "") ||
      (time && time.trim() !== "")
    ) {
      count++;
    }
  });

  return count;
}


      /* ================== VEHICLES ================== */
      async function loadVehiclesAndOps(){
        vehicleSection.innerHTML = "Loading vehicles...";
        vehicles = [];
        vehicleOps = {};
        try {
          const r = await fetch(endpoints.vehiclesByPlant(plantID));
          if(!r.ok){
            vehicleSection.innerHTML = `<div style="color:var(--muted);padding:8px">No vehicles found</div>`;
            setStatusBadge(computeCompleteness());
            return;
          }
          const list = await r.json();
          const map = new Map();
          (Array.isArray(list) ? list : []).forEach(v=>{
            if(v && v.vehicleID != null){
              const key = String(v.vehicleID);
              if(!map.has(key)) map.set(key, v);
            }
          });
          vehicles = Array.from(map.values());
          vehicleSection.innerHTML = "";

          for(const v of vehicles){
            const vid = String(v.vehicleID);
            const block = document.createElement('div');
            block.className = 'vehicle-block';
            block.setAttribute('data-vehicleid', vid);
            block.innerHTML = `
              <div class="vehicle-title">${escapeHtml(v.vehicleNumber || 'Unknown')} - <span class="small">${escapeHtml(v.vehicleModelName || '')}</span></div>
              <div style="margin-top:8px">
                <table style="width:100%;border-collapse:collapse">
                  <tr>
                      <th>Odometer Reading (Km)</th>
                      <td>
                        <div class="two-inline">
                          <input id="am_${vid}" class="input" placeholder="Morning Km">
                          <input id="pm_${vid}" class="input" placeholder="Evening Km">
                        </div>
                      </td>
                  </tr>

                  <tr>
                    <th>Vehicle Fuel Level (0-6)</th>
                    <td><input id="fuel_${vid}" class="input" placeholder="Enter (0-6)"></td>
                  </tr>
                  <tr>
                    <th>Last Fuel Filled?</th>
                    <td style="display:flex; gap:8px; align-items:center;">
                      <label><input type="checkbox" id="lastFuel_${vid}"> Yes</label>
                      <input id="lastFuelDate_${vid}"
                       type="date"
                       class="input"
                       style="max-width:160px"
                       max="${new Date().toISOString().split('T')[0]}"
                       disabled>

                      <input id="filledLiters_${vid}" class="input" placeholder="Filled Liters" style="max-width:140px" disabled>

                      <!-- ‚úÖ NEW FIELD -->
                      <input id="currentOdo_${vid}"
                             class="input"
                             placeholder="Current Odometer Reading"
                             style="max-width:200px"
                             disabled>
                    </td>
                  </tr>

                  <tr>
                      <th>No. of Trips</th>
                      <td>
                        <input
                              id="trips_${vid}"
                              class="input"
                              type="number"
                              min="0"
                              max="10"
                              placeholder="Enter No Of Trips">
                              <div id="tripsWarning_${vid}" class="input-warning">
                              Maximum 10 trips allowed
                              </div>
                        <div id="tripForms_${vid}" style="margin-top:10px"></div>
                      </td>
                  </tr>

                  <tr>
                      <th>Sludge Collect</th>
                      <td>
                        <div class="two-inline">
                          <input id="sludge_${vid}" class="input" placeholder="Enter Ltrs" readonly disabled>
                          <input id="sludgeKgs_${vid}" class="input" placeholder="Enter Kgs" readonly disabled>
                        </div>
                      </td>
                  </tr>

                </table>
              </div>
            `;
        vehicleSection.appendChild(block);

const tripsInput = document.getElementById(`trips_${vid}`);
const warningEl = document.getElementById(`tripsWarning_${vid}`);

tripsInput.addEventListener("input", () => {
  let inputCount = Number(tripsInput.value || 0);

  if (inputCount > 10) {
    inputCount = 10;
    warningEl.style.display = "block";
  } else {
    warningEl.style.display = "none";
  }

  if (inputCount < 0) inputCount = 0;

  // üîê count trips that already have data
  const filledCount = countTripsWithData(vid);

  // üö´ DO NOT ALLOW LESS THAN FILLED TRIPS
  if (inputCount < filledCount) {
    inputCount = filledCount;
  }

  tripsInput.value = inputCount;

  // üîÅ KEEP ONLY FILLED TRIPS + REQUIRED EMPTY ONES
  const existingTrips = [];
  const rows = document.querySelectorAll(`#tripForms_${vid} .vehicle-block`);

  rows.forEach((_, i) => {
    const trip = {
      vehicleTripId: document.getElementById(`trip_id_${vid}_${i}`)?.value || null,
      sludgeCollectLtrs: document.getElementById(`trip_ltrs_${vid}_${i}`)?.value || "",
      sludgeCollectKgs: document.getElementById(`trip_kgs_${vid}_${i}`)?.value || "",
      tripTime: document.getElementById(`trip_time_${vid}_${i}`)?.value || ""
    };

    // keep only trips with data
    if (
      trip.sludgeCollectLtrs ||
      trip.sludgeCollectKgs ||
      trip.tripTime
    ) {
      existingTrips.push(trip);
    }
  });

  renderTripForms(vid, inputCount, existingTrips);

  updateVehicleTripSludgeTotals(vid);
  setStatusBadge(computeCompleteness());
});




            // attach lastFuel handler safely
            (function(localVid){
                const chk = document.getElementById(`lastFuel_${localVid}`);
                const dateEl = document.getElementById(`lastFuelDate_${localVid}`);
                const filledEl = document.getElementById(`filledLiters_${localVid}`);
                const odoEl = document.getElementById(`currentOdo_${localVid}`); // ‚úÖ NEW

                if(!chk) return;
                chk.addEventListener('change', async () => {
                  if (chk.checked) {
                    dateEl.disabled = false;
                    filledEl.disabled = false;
                    odoEl.disabled = false;
                  } else {
                    dateEl.disabled = true;
                    filledEl.disabled = true;
                    odoEl.disabled = true;

                    dateEl.value = "";
                    filledEl.value = "";
                    odoEl.value = "";

                    await loadLatestFuelTillDate(localVid);
                  }

                  setStatusBadge(computeCompleteness());
                });

            })(vid);
          }

          // fetch existing vehicle ops and populate (fixed: declare vid early)
          await Promise.all(vehicles.map(async v=>{
            try{
              const rr = await fetch(endpoints.vehicleOpGet(v.vehicleID, date));
              if(!rr.ok) return;
              const txt = await rr.text();
              if(!txt.trim()) return;

              const op = JSON.parse(txt);
              const vid = String(v.vehicleID);   // MUST be first
              vehicleOps[vid] = op;

              // LOAD EXISTING TRIPS
                if (op.vehicleOpID) {
                  loadTripDetails(vid, op.vehicleOpID);
                }


              const am = document.getElementById(`am_${vid}`);
              const pm = document.getElementById(`pm_${vid}`);
              const fuel = document.getElementById(`fuel_${vid}`);
              const lastFuel = document.getElementById(`lastFuel_${vid}`);
              const lastFuelDate = document.getElementById(`lastFuelDate_${vid}`);
              const filledLitersEl = document.getElementById(`filledLiters_${vid}`);
              const odoEl = document.getElementById(`currentOdo_${vid}`);
              const trips = document.getElementById(`trips_${vid}`);
              const sludge = document.getElementById(`sludge_${vid}`);
              const sludgeKgs = document.getElementById(`sludgeKgs_${vid}`);

              if(am) am.value = op.vehicleReadingAm ?? "";
              if(pm) pm.value = op.vehicleReadingPm ?? "";
              if(fuel) fuel.value = op.vehicleFuelLevel ?? "";
              if(sludge) sludge.value = op.sludgeCollect ?? "";
              if(sludgeKgs) sludgeKgs.value = op.sludgeCollectKgs ?? "";

              if(lastFuel){
                  lastFuel.checked = !!op.lastFuelFilled;
              }

              // enable/disable dependent fields based on checkbox
              if(lastFuel && lastFuel.checked){
              if(lastFuelDate){ lastFuelDate.disabled = false; lastFuelDate.value = op.lastFuelFilledDate ?? ""; }
              if(filledLitersEl){ filledLitersEl.disabled = false; filledLitersEl.value = (op.filledLiters == null ? "" : String(op.filledLiters)); }
              if(odoEl){ odoEl.disabled = false; odoEl.value = op.currentOdometerReading ?? ""; }
            } else {
              if(lastFuelDate){ lastFuelDate.disabled = true; lastFuelDate.value = ""; }
              if(filledLitersEl){ filledLitersEl.disabled = true; filledLitersEl.value = ""; }
              if(odoEl){ odoEl.disabled = true; odoEl.value = ""; }
            }

            if (!lastFuel.checked) {
              await loadLatestFuelTillDate(vid);
            }

            }catch(e){
              // ignore per-vehicle error
              console.warn("vehicle populate error", e);
            }
          }));

        } catch(e){
          vehicleSection.innerHTML = `<div style="color:var(--muted);padding:8px">Error loading vehicles</div>`;
        }

        attachEnterNav();
        setStatusBadge(computeCompleteness());
        isDirty = false;
      }
              function togglePowerBillFields(enabled) {
          ["lastBillDate", "TotalNoOfUnits", "totalBillAmount"].forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            el.disabled = !enabled;
            if (!enabled) el.value = "";
          });
        }


      /* ================== LOAD PLANT ================== */
      async function loadPrivateVehicles() {
      try {
        const r = await fetch(`/api/private-vehicles/privateveh/${plantID}?date=${date}`);
        if (!r.ok) return;

        existingPrivateVehicles = await r.json();
        savedPrivateVehicleCount = existingPrivateVehicles.length;

        if (privateToggle.checked) {
          privateTripsEl.value = savedPrivateVehicleCount;
          renderPrivateVehicleForms(savedPrivateVehicleCount);
        }
        isDirty = false;
      } catch (e) {
        console.warn("Failed to load private vehicles", e);
      }
    }


      async function loadPlantOperation(){
        try{
          const r = await fetch(endpoints.plantGet(plantID, date));
          if(!r.ok){
            currentOp = {};
          } else {
            const txt = await r.text();
            currentOp = txt && txt.trim() ? JSON.parse(txt) : {};
          }
        } catch(e){
          currentOp = {};
        }

        renderPlantFields();
        togglePowerBillFields(!!currentOp.powerBill);

        // private aggregates in plant
        if(currentOp.noOfTripsPrivateVehicle != null || currentOp.sludgeCollectPrivateVehicle != null||currentOp.sludgeCollectPrivateVehicleKgs != null)
        {
          privateToggle.checked = !!currentOp.noOfTripsPrivateVehicle || !!currentOp.sludgeCollectPrivateVehicle || !!currentOp.sludgeCollectPrivateVehicleKgs;
          if(privateToggle.checked){
            privateTripsEl.value = currentOp.noOfTripsPrivateVehicle ?? "";
            privateSludgeEl.value = currentOp.sludgeCollectPrivateVehicle ?? "";
            privateSludgeKgsEl.value = currentOp.sludgeCollectPrivateVehicleKgs ?? "";
            privateTripsEl.disabled = false;

          } else {
            privateTripsEl.value = "";
            privateSludgeEl.value = "";
            privateSludgeKgsEl.value = "";

            privateTripsEl.disabled = true;
          }
        }
        else {
          privateToggle.checked = false;

          privateTripsEl.value = "";
          privateSludgeEl.value = "";
          privateSludgeKgsEl.value = "";

          privateTripsEl.disabled = true;
        }

        // populate other plant values into inputs (if existed)
        plantFieldDefs.forEach(f=>{
          if(f.type === "radio" || f.type === "textarea") return;
          const el = document.getElementById(f.id);
          if(el && currentOp[f.id] != null) el.value = currentOp[f.id];
        });
        const remarksEl = document.getElementById("remarks");
        if(remarksEl && currentOp.remarks != null) remarksEl.value = currentOp.remarks;

        setStatusBadge(computeCompleteness());
        isDirty = false;

        if (!currentOp.waterUsed) {
        await loadLatestWaterTillDate();
        }

        if (!currentOp.powerBill) {
          await loadLatestPowerBillTillDate();
        }

      }

      /* ================== SAVE / SUBMIT ================== */
      async function onSubmit(){

       isSaving = true;

        if (sseConnection) {
          sseConnection.close();
          sseConnection = null;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = "Submitting...";


        // validate plant numeric fields (remark excluded)
        for(const f of plantFieldDefs){
          if (f.type === "radio" || f.type === "checkbox" || f.type === "date" || f.id === "remarks") continue;
          const el = document.getElementById(f.id);
          if(!el || el.disabled) continue;
          if(!numericValid(el.value)){
            alert(`Invalid numeric value for "${f.label}". Use digits and '.' for decimals ‚Äî do not use ',' or ':'`);
            el.focus();
            submitBtn.disabled = false;
            submitBtn.textContent = "Submit";
            return;
          }

        }

        // validate private aggregates if enabled
        if(privateToggle.checked){
          if(
            !numericValid(privateTripsEl.value) ||
            !numericValid(privateSludgeEl.value) ||
            !numericValid(privateSludgeKgsEl.value)
          ){
            alert("Invalid number in private aggregate fields. Use digits and '.' only.");
            submitBtn.disabled = false;
            submitBtn.textContent = "Submit";
            return;
          }
        }

        // validate vehicle numeric fields (note: filledLiters and date are optional)
        for(const v of vehicles){
          const vid = String(v.vehicleID);
          const am = document.getElementById(`am_${vid}`);
          const pm = document.getElementById(`pm_${vid}`);
          const fuel = document.getElementById(`fuel_${vid}`);
          const trips = document.getElementById(`trips_${vid}`);
          const sludge = document.getElementById(`sludge_${vid}`);
          const sludgeKgs = document.getElementById(`sludgeKgs_${vid}`);
          const odo = document.getElementById(`currentOdo_${vid}`);

          for(const el of [am, pm, fuel, trips, sludge, sludgeKgs, odo]){
              if(!el) continue;
              if(!numericValid(el.value)){
                alert("Invalid number in vehicle fields. Use digits and '.' only (no commas or colons).");
                el.focus();
                submitBtn.disabled = false;
                submitBtn.textContent = "Submit";
                return;
              }
            }

          // lastFuelFilledDate and filledLiters are optional by your instruction ‚Üí no validation here
        }

        // Build plant payload
        const plantPayload = {};

        plantFieldDefs.forEach(f=>{
          if (f.type === "radio" || f.type === "checkbox") return;
          const el = document.getElementById(f.id);
          if(!el || el.disabled){
            plantPayload[f.id] = null;
            return;
          }
          if(f.id === "remarks"){
            plantPayload.remarks = el.value.trim() === "" ? null : el.value;
            return;
          }
          plantPayload[f.id] = el.value.trim() === "" ? null : Number(el.value.trim());
        });

        //  ADD SOLAR EXPORT VALUES (CORRECT PLACE)
        if (plantSolar) {
          const amExpEl = document.getElementById("powerReadingAmExport");
          const pmExpEl = document.getElementById("powerReadingPmExport");

          plantPayload.powerReadingAmExport =
            amExpEl && amExpEl.value.trim() !== ""
              ? Number(amExpEl.value.trim())
              : null;

          plantPayload.powerReadingPmExport =
            pmExpEl && pmExpEl.value.trim() !== ""
              ? Number(pmExpEl.value.trim())
              : null;
        }


        plantPayload.operationDate = date;

        /* ================= WATER DETAILS PAYLOAD ================= */

const waterUsed = document.getElementById("waterUsed")?.checked;

plantPayload.waterUsed = !!waterUsed;

if (waterUsed) {
  plantPayload.waterFilledDate =
    document.getElementById("waterFilledDate").value || null;

  plantPayload.waterLtrs =
    document.getElementById("waterLtrs").value.trim() === ""
      ? null
      : Number(document.getElementById("waterLtrs").value);

  plantPayload.totalWaterAmount =
    document.getElementById("totalWaterAmount").value.trim() === ""
      ? null
      : Number(document.getElementById("totalWaterAmount").value);
} else {
  plantPayload.waterFilledDate = null;
  plantPayload.waterLtrs = null;
  plantPayload.totalWaterAmount = null;
}

        const billChecked = document.getElementById("powerBill")?.checked;

plantPayload.powerBill = !!billChecked;

if (billChecked) {
  plantPayload.lastBillDate = document.getElementById("lastBillDate").value || null;
  plantPayload.TotalNoOfUnits = Number(document.getElementById("TotalNoOfUnits").value || 0);
  plantPayload.totalBillAmount = Number(document.getElementById("totalBillAmount").value || 0);
} else {
  plantPayload.lastBillDate = null;
  plantPayload.TotalNoOfUnits = null;
  plantPayload.totalBillAmount = null;
}


        if(privateToggle.checked){
          plantPayload.privateVehicle = true;
          plantPayload.noOfTripsPrivateVehicle = privateTripsEl.value.trim() === "" ? null : Number(privateTripsEl.value.trim());
          plantPayload.sludgeCollectPrivateVehicle = privateSludgeEl.value.trim() === "" ? null : Number(privateSludgeEl.value.trim());
          plantPayload.sludgeCollectPrivateVehicleKgs =privateSludgeKgsEl.value.trim() === "" ? null : Number(privateSludgeKgsEl.value.trim());

        } else {
          plantPayload.privateVehicle = false;
          plantPayload.noOfTripsPrivateVehicle = 0;
          plantPayload.sludgeCollectPrivateVehicle = 0;
          plantPayload.sludgeCollectPrivateVehicleKgs = 0;
        }

        if (!plantSolar) {
          plantPayload.powerReadingAmExport = null;
          plantPayload.powerReadingPmExport = null;
        }

        // send plant PUT
        try{
          const resp = await fetch(endpoints.plantPut(plantID, date), {
            method: "PUT",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify(plantPayload)
          });
          if(!resp.ok){
            const txt = await resp.text();
            alert("Error saving plant operation:\n" + txt);
            submitBtn.disabled = false;
            submitBtn.textContent = "Submit";
            return;
          }
        } catch(e){
          alert("Network error saving plant operation.");
          submitBtn.disabled = false;
          submitBtn.textContent = "Submit";
          return;
        }

        // send vehicle PUTs one-by-one
        try{
          for(const v of vehicles){
            const vid = String(v.vehicleID);
            const lastFuel = document.getElementById(`lastFuel_${vid}`);
            const lastFuelDate = document.getElementById(`lastFuelDate_${vid}`);
            const filledLitersEl = document.getElementById(`filledLiters_${vid}`);
            const odoEl = document.getElementById(`currentOdo_${vid}`);

            const filledLitersVal = (lastFuel && lastFuel.checked && filledLitersEl && String(filledLitersEl.value).trim() !== "")
                ? Number(filledLitersEl.value.trim())
                : null;

                const odoVal =
                  lastFuel && lastFuel.checked && document.getElementById(`currentOdo_${vid}`)?.value.trim() !== ""
                    ? Number(document.getElementById(`currentOdo_${vid}`).value.trim())
                    : null;


            const payload = {
              operationDate: date,
              vehicleReadingAm: (document.getElementById(`am_${vid}`).value.trim() === "" ? null : Number(document.getElementById(`am_${vid}`).value.trim())),
              vehicleReadingPm: (document.getElementById(`pm_${vid}`).value.trim() === "" ? null : Number(document.getElementById(`pm_${vid}`).value.trim())),
              vehicleFuelLevel: (document.getElementById(`fuel_${vid}`).value.trim() === "" ? null : Number(document.getElementById(`fuel_${vid}`).value.trim())),
              lastFuelFilled: !!(lastFuel && lastFuel.checked),
              lastFuelFilledDate: (lastFuel && lastFuel.checked && lastFuelDate && String(lastFuelDate.value).trim() !== "") ? lastFuelDate.value : null,
              filledLiters: filledLitersVal,
              currentOdometerReading: odoVal,
              noOfTrips: (document.getElementById(`trips_${vid}`).value.trim() === "" ? null : Number(document.getElementById(`trips_${vid}`).value.trim())),
              sludgeCollect: (document.getElementById(`sludge_${vid}`).value.trim() === "" ? null : Number(document.getElementById(`sludge_${vid}`).value.trim())),
              sludgeCollectKgs: (document.getElementById(`sludgeKgs_${vid}`).value.trim() === ""? null: Number(document.getElementById(`sludgeKgs_${vid}`).value.trim()))
            };

            const vr = await fetch(endpoints.vehicleOpPut(plantID, v.vehicleID, date), {
              method: "PUT",
              headers: {"Content-Type":"application/json"},
              body: JSON.stringify(payload)
            });

            if (!vr.ok) {
              const t = await vr.text();
              alert(`Error saving vehicle ${v.vehicleNumber}:\n${t}`);
              submitBtn.disabled = false;
              submitBtn.textContent = "Submit";
              return;
            }

            // VERY IMPORTANT ‚Äî SAVE RETURNED OP
            const savedOp = await vr.json();
            vehicleOps[vid] = savedOp;

          }
        } catch(e){
          alert("Network error saving vehicle operations.");
          submitBtn.disabled = false;
          submitBtn.textContent = "Submit";
          return;
        }

        // ================== SAVE VEHICLE TRIP DETAILS ==================
        for (const v of vehicles) {
          const vid = String(v.vehicleID);

          const tripsCount = Math.max(
          Number(document.getElementById(`trips_${vid}`)?.value || 0),
          savedTripCountByVehicle[vid] || 0,
          document.querySelectorAll(`#tripForms_${vid} .vehicle-block`).length
        );


  if (tripsCount <= 0) continue;

  const vehicleOpId = vehicleOps[vid]?.vehicleOpID;
  if (!vehicleOpId) {
    console.warn("Missing vehicleOpID for vehicle", vid);
    continue;
  }

  for (let i = 0; i < tripsCount; i++) {
    const ltrsEl = document.getElementById(`trip_ltrs_${vid}_${i}`);
    const kgsEl  = document.getElementById(`trip_kgs_${vid}_${i}`);
    const timeEl = document.getElementById(`trip_time_${vid}_${i}`);

    const tripId =
      document.getElementById(`trip_id_${vid}_${i}`)?.value || null;

    const payload = {
      vehicleTripId: tripId,   // CREATE or UPDATE handled by backend
      sludgeCollectLtrs:
        ltrsEl && ltrsEl.value.trim() !== ""
          ? Number(ltrsEl.value)
          : null,
      sludgeCollectKgs:
        kgsEl && kgsEl.value.trim() !== ""
          ? Number(kgsEl.value)
          : null,
      tripTime:
        timeEl && timeEl.value
          ? timeEl.value
          : null
    };

    const resp = await fetch(
      `/api/vehicle-trip-details/operation/${vehicleOpId}`,
      {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      }
    );

    if (resp.ok) {
      const savedTrip = await resp.json();

      // store ID after first insert
      if (!tripId && savedTrip.vehicleTripId) {
        document.getElementById(`trip_id_${vid}_${i}`).value =
          savedTrip.vehicleTripId;
      }
    }
    savedTripCountByVehicle[vid] = tripsCount;
  }
}

        // SAVE / UPDATE PRIVATE VEHICLES
    if (privateToggle.checked && Number(privateTripsEl.value) > 0) {
      const pvCount = Math.max(
  Number(privateTripsEl.value || 0),
  savedPrivateVehicleCount,
  document.querySelectorAll("#privateVehicleForms .vehicle-block").length
);


    for (let i = 0; i < pvCount; i++) {

    const id = document.getElementById(`pv_id_${i}`).value;

    const payload = {
      privateVehNumber: document.getElementById(`pv_number_${i}`).value || null,
      driverNumber: document.getElementById(`pv_driver_no_${i}`).value
          ? Number(document.getElementById(`pv_driver_no_${i}`).value)
          : null,
      driverName: document.getElementById(`pv_driver_name_${i}`).value || null,
      receivedSludgeLtrs: document.getElementById(`pv_ltrs_${i}`).value
          ? Number(document.getElementById(`pv_ltrs_${i}`).value)
          : null,
      receivedSludgeKgs: document.getElementById(`pv_kgs_${i}`).value
          ? Number(document.getElementById(`pv_kgs_${i}`).value)
          : null,
      operationDate: date
    };


    if (id) {
      await fetch(`/api/private-vehicles/update/${plantID}/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
    } else {
      await fetch(`/api/private-vehicles/create/${plantID}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
    }
  }
}


        alert("‚úî Operation updated successfully!");

        if (sseConnection) {
          sseConnection.close();
          sseConnection = null;
        }

        window.location.href = `index.html?date=${encodeURIComponent(date)}`;
      }

      /* ================== UTILITIES & EVENTS ================== */
      function bindStatusWatcher(){
        function tick(){ setTimeout(()=> setStatusBadge(computeCompleteness()), 0); }
        document.addEventListener('input', () => {
          isDirty = true;
          tick();
        });
        document.addEventListener('change', () => {
          isDirty = true;
          tick();
        });
      }

      function markDirty() {
          isDirty = true;
        }


      function attachEnterNav(){
        const all = Array.from(document.querySelectorAll("input:not([type=radio]), textarea")).filter(el => el.offsetParent !== null);
        all.forEach(el => {
          el.removeEventListener('keydown', enterHandler);
          el.addEventListener('keydown', enterHandler);
        });
        function enterHandler(e){
          if(e.key === "Enter"){
            e.preventDefault();
            const visible = Array.from(document.querySelectorAll("input:not([type=radio]), textarea")).filter(el => el.offsetParent !== null);
            const idx = visible.indexOf(e.target);
            const next = visible[idx+1];
            if(next) next.focus();
          }
        }
      }
      async function loadPlantMaster() {
          try {
            const r = await fetch(`/api/plants/${plantID}`);
            if (r.ok) {
              const plant = await r.json();
              plantSolar = !!plant.solar;
              plantName = plant.plantName || plant.name || "";
            }
          } catch (e) {
            plantSolar = false;
            plantName = "";
          }
          infoEl.innerHTML = `
              Date: <strong style="color:#f97316">${escapeHtml(date)}</strong>
              &nbsp; | &nbsp;
              Plant ID: <strong style="color:#059669">${escapeHtml(plantID)}</strong>
              ${plantName ? `&nbsp; | &nbsp; Plant: <strong style="color:#2563eb">${escapeHtml(plantName)}</strong>` : ""}
            `;
        }

      // events
      submitBtn.addEventListener('click', onSubmit);
      backBtn.addEventListener('click', ()=> window.location.href = `index.html?date=${encodeURIComponent(date)}`);

      privateToggle.addEventListener('change', ()=>{
          const yes = privateToggle.checked;
          privateTripsEl.disabled = !yes;
          document.getElementById("privateTripsWarning").style.display = "none";

          if(!yes){
            privateTripsEl.value = "";
            privateSludgeEl.value = "";
            privateSludgeKgsEl.value = "";
            document.getElementById("privateVehicleForms").innerHTML = "";
          }

          setStatusBadge(computeCompleteness());
        });


   const privateWarning = document.getElementById("privateTripsWarning");

   privateTripsEl.addEventListener("input", () => {
  let inputCount = Number(privateTripsEl.value || 0);

  if (inputCount > 10) {
    inputCount = 10;
    privateWarning.style.display = "block";
  } else {
    privateWarning.style.display = "none";
  }

  if (inputCount < savedPrivateVehicleCount) {
    inputCount = savedPrivateVehicleCount;
  }

  privateTripsEl.value = inputCount;

  const existing = [];
  const rows = document.querySelectorAll("#privateVehicleForms .vehicle-block");

  rows.forEach((_, i) => {
    existing.push({
      privateVehicleID: document.getElementById(`pv_id_${i}`)?.value || null,
      privateVehNumber: document.getElementById(`pv_number_${i}`)?.value || "",
      driverNumber: document.getElementById(`pv_driver_no_${i}`)?.value || "",
      driverName: document.getElementById(`pv_driver_name_${i}`)?.value || "",
      receivedSludgeLtrs: document.getElementById(`pv_ltrs_${i}`)?.value || "",
      receivedSludgeKgs: document.getElementById(`pv_kgs_${i}`)?.value || ""
    });
  });

  renderPrivateVehicleForms(inputCount, existing);
  updatePrivateSludgeTotals();
  setStatusBadge(computeCompleteness());
});

function startSSE() {
  try {
    if (sseConnection) return;

    sseConnection = new EventSource("/api/events/updates");

    sseConnection.addEventListener("DATA_UPDATE", async (e) => {

  // üö´ ignore SSE while saving
  if (isDirty || isSaving) return;

  let data;
  try {
    data = JSON.parse(e.data);
  } catch {
    return;
  }

  if (
    (data.entity === "PLANT_OP" ||
     data.entity === "VEHICLE_OP" ||
     data.entity === "PRIVATE_VEHICLE") &&
    String(data.plantId) === String(plantID)
  ) {
    // üîÑ always reload latest data silently
    await loadPlantOperation();
    await loadVehiclesAndOps();
    await loadPrivateVehicles();

  }
});


    sseConnection.onerror = () => {
      sseConnection.close();
      sseConnection = null;
      setTimeout(startSSE, 2000);
    };

  } catch (err) {
    console.warn("SSE failed", err);
  }
}

document.addEventListener("visibilitychange", () => {
  if (document.hidden && sseConnection) {
    sseConnection.close();
    sseConnection = null;
  } else if (!document.hidden) {
    startSSE();
  }
});



      // initial load
     (async function init(){
      await loadPlantMaster();
      await loadPlantOperation();
      await loadVehiclesAndOps();
      await loadPrivateVehicles();   //ADD THIS LINE
      attachEnterNav();
      bindStatusWatcher();
      setStatusBadge(computeCompleteness());
      document.getElementById("privateTripsWarning").style.display = "none";

      startSSE();   // ‚úÖ ADD THIS LINE
    })();

    function updatePrivateSludgeTotals() {
  let totalLtrs = 0;
  let totalKgs = 0;

 const count = Math.max(
  Number(privateTripsEl.value || 0),
  savedPrivateVehicleCount,
  document.querySelectorAll("#privateVehicleForms .vehicle-block").length
);



  for (let i = 0; i < count; i++) {
    const ltrsEl = document.getElementById(`pv_ltrs_${i}`);
    const kgsEl  = document.getElementById(`pv_kgs_${i}`);

    if (ltrsEl && ltrsEl.value && !isNaN(ltrsEl.value)) {
      totalLtrs += Number(ltrsEl.value);
    }
    if (kgsEl && kgsEl.value && !isNaN(kgsEl.value)) {
      totalKgs += Number(kgsEl.value);
    }
  }

  // write totals to readonly fields
  privateSludgeEl.value =totalLtrs === 0 ? "0" : totalLtrs;

  privateSludgeKgsEl.value =totalKgs === 0 ? "0" : totalKgs;

}

async function deletePrivateVehicle(index) {
  const idEl = document.getElementById(`pv_id_${index}`);
  if (!idEl) return;

  const privateVehicleId = idEl.value;

  // üî• DELETE FROM DB
  if (privateVehicleId) {
    const ok = confirm("Delete this private vehicle?");
    if (!ok) return;

    const resp = await fetch(`/api/private-vehicles/${privateVehicleId}`, {
      method: "DELETE"
    });

    if (!resp.ok) {
      alert("Private vehicle delete failed");
      return;
    }
  }

  // üîÅ READ REMAINING VEHICLES FROM DOM
  const oldCount = document.querySelectorAll(
    "#privateVehicleForms .vehicle-block"
  ).length;

  const remaining = [];
  for (let i = 0; i < oldCount; i++) {
    if (i === index) continue;

    remaining.push({
      privateVehicleID: document.getElementById(`pv_id_${i}`)?.value || null,
      privateVehNumber: document.getElementById(`pv_number_${i}`)?.value || "",
      driverNumber: document.getElementById(`pv_driver_no_${i}`)?.value || "",
      driverName: document.getElementById(`pv_driver_name_${i}`)?.value || "",
      receivedSludgeLtrs: document.getElementById(`pv_ltrs_${i}`)?.value || "",
      receivedSludgeKgs: document.getElementById(`pv_kgs_${i}`)?.value || ""
    });
  }

  // üîí UPDATE COUNTS
  savedPrivateVehicleCount = remaining.length;
  existingPrivateVehicles = remaining;
  privateTripsEl.value = remaining.length;

  // üî• REBUILD UI
  renderPrivateVehicleForms(remaining.length, remaining);

  updatePrivateSludgeTotals();
  setStatusBadge(computeCompleteness());
}


async function deleteTrip(vehicleId, index) {
  const tripIdEl = document.getElementById(`trip_id_${vehicleId}_${index}`);
  if (!tripIdEl) return;

  const tripId = tripIdEl.value;

  // üî• DELETE FROM DB
  if (tripId) {
    const ok = confirm("Delete this trip?");
    if (!ok) return;

    const resp = await fetch(`/api/vehicle-trip-details/${tripId}`, {
      method: "DELETE"
    });

    if (!resp.ok) {
      alert("Trip delete failed in DB");
      return;
    }
  }

  // üîÅ READ REMAINING TRIPS FROM DOM (IMPORTANT)
  const tripsInput = document.getElementById(`trips_${vehicleId}`);
  const oldCount = document.querySelectorAll(
  `#tripForms_${vehicleId} .vehicle-block`
  ).length;


  const remainingTrips = [];
  for (let i = 0; i < oldCount; i++) {
    if (i === index) continue;

    remainingTrips.push({
      vehicleTripId: document.getElementById(`trip_id_${vehicleId}_${i}`)?.value || null,
      sludgeCollectLtrs: document.getElementById(`trip_ltrs_${vehicleId}_${i}`)?.value || "",
      sludgeCollectKgs: document.getElementById(`trip_kgs_${vehicleId}_${i}`)?.value || "",
      tripTime: document.getElementById(`trip_time_${vehicleId}_${i}`)?.value || ""
    });
  }

  // üîÑ UPDATE INPUT COUNT
  tripsInput.value = remainingTrips.length;

  // üî• REBUILD UI
  renderTripForms(vehicleId, remainingTrips.length, remainingTrips);

  // ‚úÖ NOW update saved count (CORRECT PLACE)
  savedTripCountByVehicle[vehicleId] = remainingTrips.length;

  updateVehicleTripSludgeTotals(vehicleId);
  setStatusBadge(computeCompleteness());
}

async function loadLatestWaterTillDate() {
  try {
    const r = await fetch(
      `/api/operations/plant/${plantID}/latest-water?date=${encodeURIComponent(date)}`
    );
    if (!r.ok) return;

    const op = await r.json();
    if (!op) return;

    // fill UI ONLY if user has not checked waterUsed
    if (!document.getElementById("waterUsed").checked) {
      document.getElementById("waterFilledDate").value = op.waterFilledDate || "";
      document.getElementById("waterLtrs").value = op.waterLtrs ?? "";
      document.getElementById("totalWaterAmount").value = op.totalWaterAmount ?? "";
    }
  } catch (e) {
    console.warn("Failed to load latest water", e);
  }
}

async function loadLatestPowerBillTillDate() {
  try {
    const r = await fetch(
      `/api/operations/plant/${plantID}/latest-power-bill?date=${encodeURIComponent(date)}`
    );
    if (!r.ok) return;

    const op = await r.json();
    if (!op) return;

    const billChk = document.getElementById("powerBill");
    if (billChk.checked) return;

    document.getElementById("lastBillDate").value = op.lastBillDate || "";
    document.getElementById("TotalNoOfUnits").value = op.totalNoOfUnits ?? "";
    document.getElementById("totalBillAmount").value = op.totalBillAmount ?? "";
  } catch (e) {
    console.warn("Failed to load latest power bill", e);
  }
}


async function loadLatestFuelTillDate(vehicleId) {
  try {
    const r = await fetch(
      `/api/vehicle-operations/${vehicleId}/latest-fuel?date=${encodeURIComponent(date)}`
    );
    if (!r.ok) return;

    const op = await r.json();
    if (!op) return;

    const vid = String(vehicleId);

    // only auto-fill when checkbox is OFF
    if (!document.getElementById(`lastFuel_${vid}`).checked) {
      document.getElementById(`lastFuelDate_${vid}`).value =
        op.lastFuelFilledDate || "";

      document.getElementById(`filledLiters_${vid}`).value =
        op.filledLiters ?? "";

      document.getElementById(`currentOdo_${vid}`).value =
        op.currentOdometerReading ?? "";
    }
  } catch (e) {
    console.warn("Failed to load latest fuel", e);
  }
}





function updateVehicleTripSludgeTotals(vehicleId) {
  let totalLtrs = 0;
  let totalKgs = 0;

  const tripsCount = Math.max(
  Number(document.getElementById(`trips_${vehicleId}`)?.value || 0),
  savedTripCountByVehicle[vehicleId] || 0,
  document.querySelectorAll(`#tripForms_${vehicleId} .vehicle-block`).length
);



  for (let i = 0; i < tripsCount; i++) {
    const ltrsEl = document.getElementById(`trip_ltrs_${vehicleId}_${i}`);
    const kgsEl  = document.getElementById(`trip_kgs_${vehicleId}_${i}`);

    if (ltrsEl && ltrsEl.value && !isNaN(ltrsEl.value)) {
      totalLtrs += Number(ltrsEl.value);
    }
    if (kgsEl && kgsEl.value && !isNaN(kgsEl.value)) {
      totalKgs += Number(kgsEl.value);
    }
  }

  // write totals into vehicle operation fields
  const sludgeEl = document.getElementById(`sludge_${vehicleId}`);
  const sludgeKgsEl = document.getElementById(`sludgeKgs_${vehicleId}`);

  if (sludgeEl) sludgeEl.value = totalLtrs === 0 ? "0" : totalLtrs;
  if (sludgeKgsEl) sludgeKgsEl.value = totalKgs === 0 ? "0" : totalKgs;
}

    })();

</script>
</body>
</html>