<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="https://mvrtech.org/MVR_Company_Logo%20copy.png">
    <title>Update Plant Operation</title>

    <style>
        body {
            font-family:'Segoe UI',sans-serif;
            background:#f5f7fa;
            margin:0; padding:0;
            display:flex;
            justify-content:center;
        }
        .card {
            background:white;
            padding:28px;
            border-radius:12px;
            box-shadow:0 10px 25px rgba(0,0,0,0.08);
            max-width:900px;
            width:100%;
            margin:20px;
        }
        h2 { text-align:center; color:#0369a1; margin-bottom:8px; }
        .top-info { text-align:center; font-weight:700; margin-bottom:14px; }

        table {
            width:100%;
            border-collapse:collapse;
            margin-top:8px;
        }
        table th, table td {
            border:1px solid #e6eef6;
            padding:12px;
        }
        table th {
            background:#0369a1;
            color:white;
            text-align:left;
            width:260px;
            font-size:15px;
        }

        .input-box, textarea {
            width:100%;
            padding:8px 10px;
            border-radius:6px;
            border:1px solid #ccc;
            box-sizing:border-box;
            font-size:15px;
        }

        textarea {
            min-height:90px;
            resize:vertical;
        }

        input:disabled, textarea:disabled {
            background:#eef1f5;
            color:#6b7280;
        }

        .vehicle-title {
            margin-top:18px;
            font-size:17px;
            font-weight:700;
            color:#0f172a;
        }

        .buttons { text-align:center; margin-top:18px; }
        .btn {
            padding:10px 18px;
            margin:0 8px;
            border:none;
            border-radius:6px;
            font-size:15px;
            cursor:pointer;
        }
        .btn-save { background:#059669; color:white; }
        .btn-back { background:#94a3b8; color:white; }
    </style>
</head>

<body>

<div class="card">

    <h2>Update Operation</h2>

    <div class="top-info" id="infoBox"></div>

    <table>
        <thead>
        <tr><th>Field</th><th>Value</th></tr>
        </thead>
        <tbody id="fieldsBody"></tbody>
    </table>

    <!-- Vehicle operations input section (dynamic blocks per vehicle) -->
    <h2 style="margin-top:22px;">Vehicle Operations</h2>
    <div id="vehicleSection"></div>

    <div class="buttons">
        <button class="btn btn-save" id="saveBtn">Save</button>
        <button class="btn btn-back" id="backBtn">Back</button>
    </div>
</div>

<script>

    const params = new URLSearchParams(window.location.search);
    const plantID = params.get("plantID");
    const date = params.get("date");

    document.getElementById("infoBox").innerHTML =
        `Date: <span style="color:#f97316">${date}</span>
         &nbsp; | &nbsp;
         Plant ID: <span style="color:#059669">${plantID}</span>`;

    document.getElementById("backBtn").onclick = () =>
        window.location.href = `index.html?date=${encodeURIComponent(date)}`;

    //--------------------------------------------------------
    // EXACT FIELD ORDER AS BACKEND (ALL INCLUDED)
    // vehicleReadingAm/vehicleReadingPm/vehicleFuelLevel removed from this list
    //--------------------------------------------------------
    const fields = [
        {id:"sludgeTankLevelAm", label:"Sludge Tank Level AM"},
        {id:"sludgeTankLevelPm", label:"Sludge Tank Level PM"},
        {id:"sludgeReceived", label:"Sludge Received"},
        {id:"noOfTrips", label:"No Of Trips"},
        {id:"sludgeProcessed", label:"Sludge Processed"},
        {id:"biocharProduced", label:"Biochar Produced"},
        {id:"plantRunningHrs", label:"Plant Running Hours"},

        {id:"solarIntegration", label:"Solar Integration", type:"radio"},

        // Solar YES
        {id:"powerReadingAmImport", label:"Power Reading AM Import"},
        {id:"powerReadingAmExport", label:"Power Reading AM Export"},
        {id:"powerReadingPmImport", label:"Power Reading PM Import"},
        {id:"powerReadingPmExport", label:"Power Reading PM Export"},

        // Solar NO
        {id:"powerReadingAm", label:"Power Reading AM"},
        {id:"powerReadingPm", label:"Power Reading PM"},

        {id:"dgReadingAm", label:"DG Reading AM"},
        {id:"dgReadingPm", label:"DG Reading PM"},
        {id:"dgDiesalPercentageAm", label:"DG Diesel % AM"},
        {id:"dgDiesalPercentagePm", label:"DG Diesel % PM"},

        // vehicle fields are handled separately below

        {id:"polymerUsage", label:"Polymer Usage"},
        {id:"pillets", label:"Pellets"},

        {id:"remarks", label:"Remarks", type:"textarea"}
    ];

    let currentOp = {};
    const fieldsBody = document.getElementById("fieldsBody");

    //--------------------------------------------------------
    // LOAD EXISTING OPERATION (PLANT)
    //--------------------------------------------------------
    async function loadOperation() {
        const res = await fetch(`/api/operations/plant/${plantID}?date=${date}`);
        const text = await res.text();
        currentOp = text && text.trim() ? JSON.parse(text) : {};

        renderFields();
    }

    //--------------------------------------------------------
    // RENDER INPUT FIELDS (PLANT)
    //--------------------------------------------------------
    function renderFields() {

        fieldsBody.innerHTML = "";

        fields.forEach(f => {

            const tr = document.createElement("tr");
            const labelTd = document.createElement("td");
            labelTd.textContent = f.label;

            const valueTd = document.createElement("td");

            // RADIO BUTTONS (solar Integration)
            if (f.type === "radio") {

                valueTd.innerHTML = `
                    <label><input type="radio" name="solarIntegration" value="true"> Yes</label>
                    &nbsp;&nbsp;
                    <label><input type="radio" name="solarIntegration" value="false"> No</label>
                `;

                const yes = valueTd.querySelector('input[value="true"]');
                const no = valueTd.querySelector('input[value="false"]');

                if (currentOp.solarIntegration === true) yes.checked = true;
                else if (currentOp.solarIntegration === false) no.checked = true;

                yes.addEventListener("change", applySolarLogic);
                no.addEventListener("change", applySolarLogic);
            }

            else if (f.type === "textarea") {
                const ta = document.createElement("textarea");
                ta.id = f.id;
                ta.value = currentOp[f.id] ?? "";
                valueTd.appendChild(ta);
            }

            else {
                const input = document.createElement("input");
                input.className = "input-box";
                input.id = f.id;
                input.value = currentOp[f.id] ?? "";
                valueTd.appendChild(input);
            }

            tr.appendChild(labelTd);
            tr.appendChild(valueTd);
            fieldsBody.appendChild(tr);
        });

        disableAllPowerFields();
        applySolarLogic();
        enableEnterNavigation(); // bind enter navigation for plant fields
    }

    //--------------------------------------------------------
    // DISABLE ALL POWER-FIELDS INITIALLY
    //--------------------------------------------------------
    function disableAllPowerFields() {
        [
            "powerReadingAmImport","powerReadingAmExport",
            "powerReadingPmImport","powerReadingPmExport",
            "powerReadingAm","powerReadingPm"
        ].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.disabled = true;
        });
    }

    //--------------------------------------------------------
    // SOLAR LOGIC
    //--------------------------------------------------------
    function applySolarLogic() {

        const yes = document.querySelector('input[name="solarIntegration"][value="true"]');
        const no  = document.querySelector('input[name="solarIntegration"][value="false"]');

        const importExport = [
            "powerReadingAmImport","powerReadingAmExport",
            "powerReadingPmImport","powerReadingPmExport"
        ];

        const ampm = ["powerReadingAm","powerReadingPm"];

        if (yes && yes.checked) {
            importExport.forEach(id => { const el = document.getElementById(id); if(el) el.disabled = false; });
            ampm.forEach(id => { const el = document.getElementById(id); if(el) el.disabled = true; });
        }

        if (no && no.checked) {
            ampm.forEach(id => { const el = document.getElementById(id); if(el) el.disabled = false; });
            importExport.forEach(id => { const el = document.getElementById(id); if(el) el.disabled = true; });
        }
    }

    //------------------------------------------------------------
    // LOAD VEHICLE INPUT BLOCKS (dynamic per vehicle)
    //------------------------------------------------------------
    async function loadVehicleInputs() {

        const container = document.getElementById("vehicleSection");
        container.innerHTML = "";

        try {
            const vehRes = await fetch(`/api/vehicle-operations/plant/${plantID}/vehicles`);
            if (!vehRes.ok) {
                container.innerHTML = `<div style="color:#6b7280; padding:10px;">No vehicles found</div>`;
                return;
            }
            const vehicles = await vehRes.json();

            for (const v of vehicles) {

                let op = {};
                try {
                    const opRes = await fetch(`/api/vehicle-operations/${v.vehicleID}?date=${date}`);
                    const txt = await opRes.text();
                    if (txt.trim()) op = JSON.parse(txt);
                } catch (e) {
                    op = {};
                }

                container.innerHTML += `
                    <div class="vehicle-title">${v.vehicleNumber} - ${v.vehicleModelName}</div>

                    <table>
                        <tr>
                            <th>Vehicle Reading AM</th>
                            <td><input id="am_${v.vehicleID}" class="input-box" value="${op.vehicleReadingAm ?? ""}"></td>
                        </tr>
                        <tr>
                            <th>Vehicle Reading PM</th>
                            <td><input id="pm_${v.vehicleID}" class="input-box" value="${op.vehicleReadingPm ?? ""}"></td>
                        </tr>
                        <tr>
                            <th>Vehicle Fuel Level</th>
                            <td><input id="fuel_${v.vehicleID}" class="input-box" value="${op.vehicleFuelLevel ?? ""}"></td>
                        </tr>
                    </table>
                `;
            }
        } catch (e) {
            container.innerHTML = `<div style="color:#6b7280; padding:10px;">Error loading vehicles</div>`;
        }

        // re-bind enter-key navigation to include vehicle inputs too
        enableEnterNavigation();
    }

    //------------------------------------------------------------
    // SAVE OPERATION (plant + all vehicles)
    //------------------------------------------------------------
    document.getElementById("saveBtn").onclick = async () => {

    // -------------------------------
    // 1️⃣ FRONTEND VALIDATION (fix for , and :)
    // -------------------------------
    function invalidNumber(val) {
        if (val === null || val === "") return false; // empty allowed
        // Allow only: digits, optional decimal .
        return !/^\d+(\.\d+)?$/.test(val);
    }

    // Validate PLANT fields
    for (const f of fields) {
        if (f.type === "radio" || f.type === "textarea") continue;
        const el = document.getElementById(f.id);
        if (!el || el.disabled) continue;
        const v = el.value.trim();
        if (invalidNumber(v)) {
            alert(`Invalid value in: ${f.label}\nUse only numbers (0-9) and dot (.)`);
            el.focus();
            return; // ❌ STOP SUBMIT
        }
    }

    // Validate VEHICLE fields
    const vehInputs = document.querySelectorAll("#vehicleSection input");
    for (const input of vehInputs) {
        const v = input.value.trim();
        if (invalidNumber(v)) {
            alert("Invalid value in Vehicle fields. Use only numbers and dot (.)");
            input.focus();
            return; // ❌ STOP SUBMIT
        }
    }

    // -------------------------------
    // 2️⃣ COLLECT PLANT DATA
    // -------------------------------
    const data = {};

    fields.forEach(f => {
        if (f.type === "radio") {
            const sel = document.querySelector('input[name="solarIntegration"]:checked');
            data[f.id] = sel ? sel.value === "true" : null;
        }
        else if (f.type === "textarea") {
            data[f.id] = document.getElementById(f.id).value || null;
        }
        else {
            const el = document.getElementById(f.id);
            if (!el || el.disabled) data[f.id] = null;
            else data[f.id] = el.value === "" ? null : el.value;
        }
    });

    data.operationDate = date;

    // -------------------------------
    // 3️⃣ SEND PLANT OPERATION SAVE
    // -------------------------------
    let plantRes;
    try {
        plantRes = await fetch(`/api/operations/${plantID}?date=${encodeURIComponent(date)}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        });
    } catch (e) {
        alert("Network error while saving plant operation.");
        return;
    }

    if (!plantRes.ok) {
        const errText = await plantRes.text();
        alert("❌ ERROR saving plant operation:\n" + errText);
        return; // ❌ STOP – DO NOT REDIRECT
    }

    // -------------------------------
    // 4️⃣ SAVE VEHICLE OPERATIONS
    // -------------------------------
    try {
        const vehRes = await fetch(`/api/vehicle-operations/plant/${plantID}/vehicles`);
        if (vehRes.ok) {
            const vehicles = await vehRes.json();

            for (const v of vehicles) {
                const payload = {
                    operationDate: date,
                    vehicleReadingAm: document.getElementById(`am_${v.vehicleID}`).value || null,
                    vehicleReadingPm: document.getElementById(`pm_${v.vehicleID}`).value || null,
                    vehicleFuelLevel: document.getElementById(`fuel_${v.vehicleID}`).value || null
                };

                const vr = await fetch(`/api/vehicle-operations/${plantID}/${v.vehicleID}?date=${encodeURIComponent(date)}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                if (!vr.ok) {
                    const t = await vr.text();
                    alert(`❌ ERROR saving vehicle ${v.vehicleNumber}:\n${t}`);
                    return; // ❌ STOP – DO NOT REDIRECT
                }
            }
        }
    } catch (e) {
        alert("❌ Vehicle save failed. No changes were saved for vehicles.");
        return;
    }

    // -------------------------------
    // 5️⃣ SUCCESS
    // -------------------------------
    alert("✔ Operation updated successfully!");
    window.location.href = `index.html?date=${encodeURIComponent(date)}`;
};


    //--------------------------------------------------------
    // ENTER KEY NAVIGATION (across plant + vehicle inputs)
    //--------------------------------------------------------
    function enableEnterNavigation() {
        // select only inputs and textareas visible on page
        const all = Array.from(document.querySelectorAll("input:not([type=radio]), textarea")).filter(el => el.offsetParent !== null);
        all.forEach((el, index) => {
            el.removeEventListener("keydown", enterNavHandler);
            el.addEventListener("keydown", enterNavHandler);
        });

        function enterNavHandler(e) {
            if (e.key === "Enter") {
                e.preventDefault();
                const visible = Array.from(document.querySelectorAll("input:not([type=radio]), textarea")).filter(el => el.offsetParent !== null);
                const idx = visible.indexOf(e.target);
                const next = visible[idx + 1];
                if (next) next.focus();
            }
        }
    }

    // initial load
    loadOperation().then(loadVehicleInputs);

</script>
</body>
</html>
