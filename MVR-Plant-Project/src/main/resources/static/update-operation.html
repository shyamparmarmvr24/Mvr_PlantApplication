<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="https://mvrtech.org/MVR_Company_Logo%20copy.png">
    <title>Update Plant Operation</title>

    <style>
        body {
            font-family:'Segoe UI',sans-serif;
            background:#f5f7fa;
            margin:0; padding:0;
            display:flex;
            justify-content:center;
        }
        .card {
            background:white;
            padding:28px;
            border-radius:12px;
            box-shadow:0 10px 25px rgba(0,0,0,0.08);
            max-width:900px;
            width:100%;
            margin:20px;
        }
        h2 { text-align:center; color:#0369a1; margin-bottom:8px; }
        .top-info { text-align:center; font-weight:700; margin-bottom:14px; }

        table {
            width:100%;
            border-collapse:collapse;
            margin-top:8px;
        }
        table th, table td {
            border:1px solid #e6eef6;
            padding:12px;
        }
        table th {
            background:#0369a1;
            color:white;
            text-align:left;
            width:260px;
            font-size:15px;
        }

        .input-box, textarea {
            width:100%;
            padding:8px 10px;
            border-radius:6px;
            border:1px solid #ccc;
            box-sizing:border-box;
            font-size:15px;
        }

        textarea {
            min-height:90px;
            resize:vertical;
        }

        input:disabled, textarea:disabled {
            background:#eef1f5;
            color:#6b7280;
        }

        .buttons { text-align:center; margin-top:18px; }
        .btn {
            padding:10px 18px;
            margin:0 8px;
            border:none;
            border-radius:6px;
            font-size:15px;
            cursor:pointer;
        }
        .btn-save { background:#059669; color:white; }
        .btn-back { background:#94a3b8; color:white; }
    </style>
</head>

<body>

<div class="card">

    <h2>Update Operation</h2>

    <div class="top-info" id="infoBox"></div>

    <table>
        <thead>
        <tr><th>Field</th><th>Value</th></tr>
        </thead>
        <tbody id="fieldsBody"></tbody>
    </table>

    <div class="buttons">
        <button class="btn btn-save" id="saveBtn">Save</button>
        <button class="btn btn-back" id="backBtn">Back</button>
    </div>
</div>

<script>

    const params = new URLSearchParams(window.location.search);
    const plantID = params.get("plantID");
    const date = params.get("date");

    document.getElementById("infoBox").innerHTML =
        `Date: <span style="color:#f97316">${date}</span>
         &nbsp; | &nbsp;
         Plant ID: <span style="color:#059669">${plantID}</span>`;

    document.getElementById("backBtn").onclick = () =>
        window.location.href = `index.html?date=${encodeURIComponent(date)}`;

    //--------------------------------------------------------
    // EXACT FIELD ORDER AS BACKEND (ALL INCLUDED)
    //--------------------------------------------------------
    const fields = [
        {id:"sludgeTankLevelAm", label:"Sludge Tank Level AM"},
        {id:"sludgeTankLevelPm", label:"Sludge Tank Level PM"},
        {id:"sludgeReceived", label:"Sludge Received"},
        {id:"noOfTrips", label:"No Of Trips"},
        {id:"sludgeProcessed", label:"Sludge Processed"},
        {id:"biocharProduced", label:"Biochar Produced"},
        {id:"plantRunningHrs", label:"Plant Running Hours"},

        {id:"solarIntegration", label:"Solar Integration", type:"radio"},

        // Solar YES
        {id:"powerReadingAmImport", label:"Power Reading AM Import"},
        {id:"powerReadingAmExport", label:"Power Reading AM Export"},
        {id:"powerReadingPmImport", label:"Power Reading PM Import"},
        {id:"powerReadingPmExport", label:"Power Reading PM Export"},

        // Solar NO
        {id:"powerReadingAm", label:"Power Reading AM"},
        {id:"powerReadingPm", label:"Power Reading PM"},

        {id:"dgReadingAm", label:"DG Reading AM"},
        {id:"dgReadingPm", label:"DG Reading PM"},
        {id:"dgDiesalPercentageAm", label:"DG Diesel % AM"},
        {id:"dgDiesalPercentagePm", label:"DG Diesel % PM"},

        {id:"vehicleReadingAm", label:"Vehicle Reading AM"},
        {id:"vehicleReadingPm", label:"Vehicle Reading PM"},
        {id:"vehicleFuelLevel", label:"Vehicle Fuel Level"},

        {id:"polymerUsage", label:"Polymer Usage"},
        {id:"pillets", label:"Pellets"},

        {id:"remarks", label:"Remarks", type:"textarea"}
    ];

    let currentOp = {};
    const fieldsBody = document.getElementById("fieldsBody");

    //--------------------------------------------------------
    // LOAD EXISTING OPERATION
    //--------------------------------------------------------
    async function loadOperation() {
        const res = await fetch(`/api/operations/plant/${plantID}?date=${date}`);
        const text = await res.text();
        currentOp = text ? JSON.parse(text) : {};

        renderFields();
    }

    //--------------------------------------------------------
    // RENDER INPUT FIELDS
    //--------------------------------------------------------
    function renderFields() {

        fieldsBody.innerHTML = "";

        fields.forEach(f => {

            const tr = document.createElement("tr");
            const labelTd = document.createElement("td");
            labelTd.textContent = f.label;

            const valueTd = document.createElement("td");

            // RADIO BUTTONS (solar Integration)
            if (f.type === "radio") {

                valueTd.innerHTML = `
                    <label><input type="radio" name="solarIntegration" value="true"> Yes</label>
                    &nbsp;&nbsp;
                    <label><input type="radio" name="solarIntegration" value="false"> No</label>
                `;

                const yes = valueTd.querySelector('input[value="true"]');
                const no = valueTd.querySelector('input[value="false"]');

                if (currentOp.solarIntegration === true) yes.checked = true;
                else if (currentOp.solarIntegration === false) no.checked = true;

                yes.addEventListener("change", applySolarLogic);
                no.addEventListener("change", applySolarLogic);
            }

            else if (f.type === "textarea") {
                const ta = document.createElement("textarea");
                ta.id = f.id;
                ta.value = currentOp[f.id] ?? "";
                valueTd.appendChild(ta);
            }

            else {
                const input = document.createElement("input");
                input.className = "input-box";
                input.id = f.id;
                input.value = currentOp[f.id] ?? "";
                valueTd.appendChild(input);
            }

            tr.appendChild(labelTd);
            tr.appendChild(valueTd);
            fieldsBody.appendChild(tr);
        });

        disableAllPowerFields();
        applySolarLogic();
        enableEnterNavigation();
    }

    //--------------------------------------------------------
    // DISABLE ALL POWER-FIELDS INITIALLY
    //--------------------------------------------------------
    function disableAllPowerFields() {
        [
            "powerReadingAmImport","powerReadingAmExport",
            "powerReadingPmImport","powerReadingPmExport",
            "powerReadingAm","powerReadingPm"
        ].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.disabled = true;
        });
    }

    //--------------------------------------------------------
    // SOLAR LOGIC
    //--------------------------------------------------------
    function applySolarLogic() {

        const yes = document.querySelector('input[name="solarIntegration"][value="true"]');
        const no  = document.querySelector('input[name="solarIntegration"][value="false"]');

        const importExport = [
            "powerReadingAmImport","powerReadingAmExport",
            "powerReadingPmImport","powerReadingPmExport"
        ];

        const ampm = ["powerReadingAm","powerReadingPm"];

        if (yes && yes.checked) {
            importExport.forEach(id => document.getElementById(id).disabled = false);
            ampm.forEach(id => document.getElementById(id).disabled = true);
        }

        if (no && no.checked) {
            ampm.forEach(id => document.getElementById(id).disabled = false);
            importExport.forEach(id => document.getElementById(id).disabled = true);
        }
    }

    //--------------------------------------------------------
    // SAVE OPERATION
    //--------------------------------------------------------
    document.getElementById("saveBtn").onclick = async () => {

        const data = {};

        fields.forEach(f => {

            if (f.type === "radio") {
                const sel = document.querySelector('input[name="solarIntegration"]:checked');
                data[f.id] = sel ? sel.value === "true" : null;
            }
            else if (f.type === "textarea") {
                data[f.id] = document.getElementById(f.id).value || null;
            }
            else {
                const el = document.getElementById(f.id);
                data[f.id] = el.disabled ? null :
                             (el.value === "" ? null : el.value);
            }
        });

        await fetch(`/api/operations/${plantID}?date=${date}`, {
            method:"PUT",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify(data)
        });

        alert("Plant Operation Updated Successfully!");
        window.location.href = `index.html?date=${encodeURIComponent(date)}`;
    };

    //--------------------------------------------------------
    // ENTER KEY NAVIGATION
    //--------------------------------------------------------
    function enableEnterNavigation() {
        const all = Array.from(document.querySelectorAll("input, textarea"));
        all.forEach((el, index) => {
            el.addEventListener("keydown", e => {
                if (e.key === "Enter") {
                    e.preventDefault();
                    const next = all[index + 1];
                    if (next) next.focus();
                }
            });
        });
    }

    loadOperation();

</script>
</body>
</html>
