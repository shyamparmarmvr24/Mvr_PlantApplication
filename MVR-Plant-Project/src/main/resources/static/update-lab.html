<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="https://mvrtech.org/MVR_Company_Logo%20copy.png">
    <title>Update Laboratory Operation</title>

    <style>
        body {
            font-family:'Segoe UI',sans-serif;
            background:#f5f7fa;
            margin:0; padding:0;
            display:flex;
            justify-content:center;
        }
        .card {
            background:white;
            padding:28px;
            border-radius:12px;
            box-shadow:0 10px 25px rgba(0,0,0,0.08);
            max-width:900px;
            width:100%;
            margin:20px;
        }
        h2 { text-align:center; color:#0369a1; margin-bottom:8px; }
        .top-info { text-align:center; font-weight:700; margin-bottom:14px; }

        table {
            width:100%;
            border-collapse:collapse;
            margin-top:8px;
        }
        table th, table td {
            border:1px solid #e6eef6;
            padding:12px;
        }
        table th {
            background:#0369a1;
            color:white;
            text-align:left;
            width:260px;
            font-size:15px;
        }

        .input-box {
            width:100%;
            padding:8px 10px;
            border-radius:6px;
            border:1px solid #ccc;
            font-size:15px;
        }

        .buttons { text-align:center; margin-top:18px; }
        .btn {
            padding:10px 18px;
            margin:0 8px;
            border:none;
            border-radius:6px;
            font-size:15px;
            cursor:pointer;
        }
        .btn-save { background:#059669; color:white; }
        .btn-back { background:#94a3b8; color:white; }
    </style>
</head>

<body>

<div class="card">

    <h2>Update Laboratory Operation</h2>

    <div class="top-info" id="infoBox"></div>

    <table>
        <thead>
        <tr><th>Field</th><th>Value</th></tr>
        </thead>
        <tbody id="fieldsBody"></tbody>
    </table>

    <div class="buttons">
        <button class="btn btn-save" id="saveBtn">Save</button>
        <button class="btn btn-back" id="backBtn">Back</button>
    </div>

</div>

<script>

    // -------------------------------------------
    // URL PARAMETERS
    // -------------------------------------------
    const params = new URLSearchParams(window.location.search);
    const plantID = params.get("plantID");
    const date = params.get("date");

    document.getElementById("infoBox").innerHTML =
        `Date: <span style="color:#f97316">${date}</span>
         &nbsp; | &nbsp;
         Plant ID: <span style="color:#059669">${plantID}</span>`;

    document.getElementById("backBtn").onclick = () => {
        window.location.href = `index.html?date=${encodeURIComponent(date)}`;
    };

    // -------------------------------------------
    // LAB FIELDS
    // -------------------------------------------
    const fields = [
        {id:"cod", label:"COD"},
        {id:"bod", label:"BOD"},
        {id:"th", label:"TH"},
        {id:"temperature", label:"Temperature"},
        {id:"tss", label:"TSS"},
        {id:"ph", label:"PH"},
        {id:"velocity", label:"Velocity"},
        {id:"cumulativeFlow", label:"Cumulative Flow"},
        {id:"flowMeterReadingAm", label:"Flow Meter Reading AM"},
        {id:"flowMeterReadingPm", label:"Flow Meter Reading PM"}
    ];

    let currentLab = {};
    const fieldsBody = document.getElementById("fieldsBody");

    // -------------------------------------------
    // LOAD EXISTING LAB DATA
    // -------------------------------------------
    async function loadOperation() {
        const res = await fetch(`/api/laboperations/plant/${plantID}?date=${date}`);
        const text = await res.text();
        currentLab = text && text.trim() ? JSON.parse(text) : {};
        renderFields();
    }

    // -------------------------------------------
    // RENDER INPUT FIELDS + ENTER NAVIGATION
    // -------------------------------------------
    function renderFields() {
        fieldsBody.innerHTML = "";

        fields.forEach((field, index) => {
            const tr = document.createElement("tr");

            const labelTd = document.createElement("td");
            labelTd.textContent = field.label;

            const valTd = document.createElement("td");

            const input = document.createElement("input");
            input.className = "input-box";
            input.id = field.id;
            input.value = currentLab[field.id] ?? "";

            // Enter key navigation
            input.addEventListener("keydown", e => {
                if (e.key === "Enter") {
                    e.preventDefault();
                    const next = fields[index + 1];
                    if (next) document.getElementById(next.id).focus();
                    else document.getElementById("saveBtn").click();
                }
            });

            valTd.appendChild(input);
            tr.appendChild(labelTd);
            tr.appendChild(valTd);
            fieldsBody.appendChild(tr);
        });

        document.getElementById(fields[0].id).focus();
    }

    // -------------------------------------------
    // SAVE LAB DATA (with FIXED VALIDATION)
    // -------------------------------------------
    document.getElementById("saveBtn").onclick = async () => {

        // Validate number fields (comma/colon fix)
        function invalidNumber(val) {
            if (val === "" || val === null) return false;
            return !/^\d+(\.\d+)?$/.test(val);
        }

        for (const f of fields) {
            const el = document.getElementById(f.id);
            const v = el.value.trim();

            if (invalidNumber(v)) {
                alert(`Invalid value in: ${f.label}\nUse only numbers (0-9) and dot (.)`);
                el.focus();
                return; // STOP submit
            }
        }

        // Build payload
        const data = {};
        fields.forEach(f => {
            const input = document.getElementById(f.id);
            data[f.id] = input.value === "" ? null : input.value;
        });

        // Perform PUT request
        let response;
        try {
            response = await fetch(`/api/laboperations/${plantID}?date=${date}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });
        } catch (e) {
            alert("Network error while saving lab data.");
            return;
        }

        // ❌ If backend rejects → stop redirect and show real error
        if (!response.ok) {
            const errText = await response.text();
            alert("❌ Lab Operation not saved:\n" + errText);
            return;
        }

        // SUCCESS
        alert("✔ Laboratory Operation Updated Successfully!");
        window.location.href = `index.html?date=${encodeURIComponent(date)}`;
    };

    loadOperation();

</script>

</body>
</html>
