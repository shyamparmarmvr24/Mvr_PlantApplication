<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Update Laboratory Operation</title>

    <style>
        body {
            font-family: "Segoe UI", sans-serif;
            background: #f5f7fa;
            margin: 0;
            display: flex;
            justify-content: center;
        }

        .card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            max-width: 1100px;
            width: 100%;
            margin: 20px;
        }

        h2 {
            text-align: center;
            color: #0369a1;
            margin-bottom: 10px;
        }

        .top-info {
            text-align: center;
            font-weight: 700;
            margin-bottom: 18px;
        }

        /* ================= TABLE ================= */
        .table-wrap {
            width: 100%;
            overflow-x: auto;
        }

        table.lab-table {
            width: 100%;
            min-width: 950px;
            border-collapse: collapse;
            table-layout: fixed;
        }

        th {
            background: #0369a1;
            color: white;
            padding: 10px;
            font-size: 14px;
            text-align: center;
        }

        td {
            border: 1px solid #e6eef6;
            padding: 8px;
            text-align: center;
        }

        .input {
            width: 100%;
            padding: 6px;
            border-radius: 6px;
            border: 1px solid #cbd5e1;
            font-size: 13px;
            box-sizing: border-box;
        }

        /* ================= FLOW ================= */
        .flow-row {
            display: flex;
            gap: 16px;
            margin-top: 18px;
            align-items: center;
            flex-wrap: nowrap; /* keeps inputs side by side */
        }
        .flow-row .input {
                max-width: 180px;
            }

        .flow-row label {
            font-weight: 700;
            min-width: 220px;
        }

        /* ================= BUTTONS ================= */
        .buttons {
            text-align: center;
            margin-top: 22px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-size: 15px;
            cursor: pointer;
            margin: 0 6px;
        }

        .btn-save { background: #059669; color: white; }
        .btn-back { background: #94a3b8; color: white; }
    </style>
</head>

<body>

<div class="card">

    <h2>Update Laboratory Operation</h2>

    <div class="top-info" id="infoBox"></div>

    <!-- ================= LAB TABLE ================= -->
    <div class="table-wrap">
        <table class="lab-table">
            <thead>
            <tr>
                <th>Sample</th>
                <th>COD (mg/L)</th>
                <th>BOD (mg/L)</th>
                <th>TN (mg/L)</th>
                <th>Temperature (°C)</th>
                <th>TSS (mg/L)</th>
                <th>PH (pH)</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td><b>10:00 AM</b></td>
                <td><input id="codReading1" class="input" placeholder="Enter COD 1"></td>
                <td><input id="bodReading1" class="input" placeholder="Enter BOD 1"></td>
                <td><input id="thReading1" class="input" placeholder="Enter TN 1"></td>
                <td><input id="temperatureReading1" class="input" placeholder="Enter Temp 1"></td>
                <td><input id="tssReading1" class="input" placeholder="Enter TSS 1"></td>
                <td><input id="phReading1" class="input" placeholder="Enter PH 1"></td>
            </tr>

            <tr>
                <td><b>12:00 PM</b></td>
                <td><input id="codReading2" class="input" placeholder="Enter COD 2"></td>
                <td><input id="bodReading2" class="input" placeholder="Enter BOD 2"></td>
                <td><input id="thReading2" class="input" placeholder="Enter TN 2"></td>
                <td><input id="temperatureReading2" class="input" placeholder="Enter Temp 2"></td>
                <td><input id="tssReading2" class="input" placeholder="Enter TSS 2"></td>
                <td><input id="phReading2" class="input" placeholder="Enter PH 2"></td>
            </tr>

            <tr>
                <td><b>02:30 PM</b></td>
                <td><input id="codReading3" class="input" placeholder="Enter COD 3"></td>
                <td><input id="bodReading3" class="input" placeholder="Enter BOD 3"></td>
                <td><input id="thReading3" class="input" placeholder="Enter TN 3"></td>
                <td><input id="temperatureReading3" class="input" placeholder="Enter Temp 3"></td>
                <td><input id="tssReading3" class="input" placeholder="Enter TSS 3"></td>
                <td><input id="phReading3" class="input" placeholder="Enter PH 3"></td>
            </tr>

            <tr>
                <td><b>05:00 PM</b></td>
                <td><input id="codReading4" class="input" placeholder="Enter COD 4"></td>
                <td><input id="bodReading4" class="input" placeholder="Enter BOD 4"></td>
                <td><input id="thReading4" class="input" placeholder="Enter TN 4"></td>
                <td><input id="temperatureReading4" class="input" placeholder="Enter Temp 4"></td>
                <td><input id="tssReading4" class="input" placeholder="Enter TSS 4"></td>
                <td><input id="phReading4" class="input" placeholder="Enter PH 4"></td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- ================= FLOW METER ================= -->
    <div class="flow-row">
        <label>Flow Meter Reading (m³/h)</label>
        <input id="flowMeterReadingAm" class="input" placeholder="Enter Morning Reading">
        <input id="flowMeterReadingPm" class="input" placeholder="Enter Evening Reading">
    </div>
    <!-- ================= BUTTONS ================= -->
    <div class="buttons">
        <button class="btn btn-save" id="saveBtn">Save</button>
        <button class="btn btn-back" id="backBtn">Back</button>
    </div>

</div>

<script>
    const params = new URLSearchParams(window.location.search);
    const plantID = params.get("plantID");
    const date = params.get("date");

    async function loadPlantInfo() {
    let plantName = "-";

    try {
        const res = await fetch(`/api/plants/${plantID}`);
        if (res.ok) {
            const plant = await res.json();
            plantName = plant.plantName || "-";
        }
    } catch (e) {
        console.error("Failed to load plant name", e);
    }

    document.getElementById("infoBox").innerHTML =
        `Date: <span style="color:#f97316">${date}</span> |
         Plant ID: <span style="color:#059669">${plantID}</span> |
         Plant Name: <span style="color:#0369a1">${plantName}</span>`;
}


    document.getElementById("backBtn").onclick = () => {
        window.location.href = `index.html?date=${encodeURIComponent(date)}`;
    };

    const fields = [
        "codReading1","codReading2","codReading3","codReading4",
        "bodReading1","bodReading2","bodReading3","bodReading4",
        "thReading1","thReading2","thReading3","thReading4",
        "temperatureReading1","temperatureReading2","temperatureReading3","temperatureReading4",
        "tssReading1","tssReading2","tssReading3","tssReading4",
        "phReading1","phReading2","phReading3","phReading4",
        "flowMeterReadingAm","flowMeterReadingPm"
    ];

    async function loadLab() {
        const res = await fetch(`/api/laboperations/plant/${plantID}?date=${date}`);
        if (!res.ok) return;
        const data = await res.json();
        fields.forEach(f => {
            if (data && data[f] !== null && data[f] !== undefined) {
                document.getElementById(f).value = data[f];
            }
        });
    }

    document.getElementById("saveBtn").onclick = async () => {
    const payload = { operationDate: date };

    fields.forEach(f => {
        const el = document.getElementById(f);
        const v = el.value.trim();

        payload[f] = v === "" ? null : (isNaN(Number(v)) ? null : Number(v));
    });

    const res = await fetch(`/api/laboperations/${plantID}?date=${date}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    });

    if (!res.ok) {
        //  NO validation error shown unless backend fails
        return;
    }

    alert("✔ Laboratory Operation Updated Successfully!");
    window.location.href = `index.html?date=${encodeURIComponent(date)}`;
};

    // ================= ENTER KEY → MOVE TO NEXT INPUT =================
    document.addEventListener("keydown", function (e) {
        if (e.key !== "Enter") return;

        const target = e.target;

        // only for inputs
        if (target.tagName !== "INPUT") return;

        e.preventDefault(); // stop form submit

        // get all enabled & visible inputs in order
        const inputs = Array.from(
            document.querySelectorAll("input")
        ).filter(el =>
            !el.disabled &&
            el.type !== "hidden" &&
            el.offsetParent !== null
        );

        const index = inputs.indexOf(target);

        // focus next input if exists
        if(index > -1 && index < inputs.length - 1) {
            inputs[index + 1].focus();
        }
    });

    loadPlantInfo();
    loadLab();

</script>

</body>
</html>
