<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="https://mvrtech.org/MVR_Company_Logo%20copy.png">
    <title>View Laboratory Operation</title>

    <style>
        body {
            font-family:'Segoe UI', sans-serif;
            background:#eef2f7;
            margin:0;
            padding:0;
            display:flex;
            justify-content:center;
        }

        .card {
            background:white;
            padding:26px;
            border-radius:12px;
            box-shadow:0 10px 25px rgba(0,0,0,0.08);
            max-width:900px;
            width:100%;
            margin:20px;
        }

        h2 {
            text-align:center;
            margin-bottom:10px;
            color:#0369a1;
        }

        .top-info {
            font-weight:700;
            text-align:center;
            margin-bottom:16px;
            color:#374151;
        }

        table {
            width:100%;
            border-collapse:collapse;
            margin-top:10px;
        }

        table th, table td {
            border:1px solid #d9e2ec;
            padding:10px;
            font-size:15px;
        }

        table th {
            background:#0369a1;
            color:white;
            width:260px;
            text-align:left;
        }

        .progress-bar {
            width:240px;
            height:18px;
            background:#e5edf5;
            margin:12px auto;
            border-radius:10px;
            overflow:hidden;
        }

        .progress-fill {
            height:100%;
            width:0;
            transition:width 0.25s ease-out;
        }

        .progress-green { background:#10b981; }
        .progress-yellow { background:#f59e0b; }
        .progress-red { background:#ef4444; }

        .buttons {
            margin-top:20px;
            text-align:center;
        }

        .btn {
            padding:10px 18px;
            font-size:15px;
            border:none;
            border-radius:6px;
            color:white;
            cursor:pointer;
            margin:0 6px;
        }

        .btn-update { background:#059669; }
        .btn-back { background:#6b7280; }

    </style>
</head>

<body>

<div class="card">

    <h2>Laboratory Operation Details</h2>

    <div class="top-info" id="infoBox"></div>

    <!-- Progress -->
    <div style="text-align:center;">
        <div class="progress-bar">
            <div id="progressFill" class="progress-fill"></div>
        </div>
        <div id="progressText" style="font-weight:700; margin-bottom:14px;"></div>
    </div>

    <table>
        <thead>
        <tr><th>Field</th><th>Value</th></tr>
        </thead>
        <tbody id="fieldsBody"></tbody>
    </table>

    <div class="buttons">
        <button class="btn btn-update" id="updateBtn">Update</button>
        <button class="btn btn-back" id="backBtn">Back</button>
    </div>

</div>

<script>

    // -----------------------------------------------------
    // READ PARAMETERS
    // -----------------------------------------------------
    const params = new URLSearchParams(window.location.search);
    const plantID = params.get('plantID');
    const date = params.get('date');

    document.getElementById("infoBox").innerHTML =
        `Date: <span style="color:#f97316">${date}</span> &nbsp; | &nbsp;
         Plant ID: <span style="color:#059669">${plantID}</span>`;

    document.getElementById("backBtn").onclick = () => {
        window.location.href = `index.html?date=${encodeURIComponent(date)}`;
    };

    // -----------------------------------------------------
    // LAB FIELDS â€” EXACT BACKEND ORDER
    // -----------------------------------------------------
    const fields = [
        "cod",
        "bod",
        "th",
        "temperature",
        "tss",
        "ph",
        "velocity",
        "cumulativeFlow",
        "flowMeterReadingAm",
        "flowMeterReadingPm"
    ];

    // -----------------------------------------------------
    // PROGRESS CALCULATION
    // -----------------------------------------------------
    function calculateProgress(lab) {
        let total = fields.length;
        let filled = 0;

        fields.forEach(f => {
            if (lab[f] !== null && lab[f] !== undefined && lab[f] !== "")
                filled++;
        });

        return Math.round((filled / total) * 100);
    }

    function applyProgressBar(progress) {
        const fill = document.getElementById("progressFill");

        const color =
            progress === 100 ? "progress-green" :
            progress > 0     ? "progress-yellow" :
                               "progress-red";

        fill.className = `progress-fill ${color}`;
        fill.style.width = progress + "%";

        document.getElementById("progressText").textContent = progress + "% Completed";
    }

    // -----------------------------------------------------
    // LOAD LAB DATA
    // -----------------------------------------------------
    async function loadOperation() {
        const res = await fetch(`/api/laboperations/plant/${plantID}?date=${date}`);
        const text = await res.text();

        let lab = {};
        if (text && text.trim()) lab = JSON.parse(text);

        renderTable(lab);

        const progress = calculateProgress(lab);
        applyProgressBar(progress);

        document.getElementById("updateBtn").onclick = () =>
            window.location.href = `update-lab.html?plantID=${plantID}&date=${encodeURIComponent(date)}`;
    }

    function renderTable(lab) {
        const body = document.getElementById("fieldsBody");
        body.innerHTML = "";

        fields.forEach(f => {

            const label = f.replace(/([A-Z])/g, " $1")
                           .replace(/^./, c => c.toUpperCase());

            const value = lab[f] ?? "-";

            const tr = document.createElement("tr");
            tr.innerHTML = `<td>${label}</td><td>${value}</td>`;
            body.appendChild(tr);
        });
    }

    // -----------------------------------------------------
    // SSE AUTO-REFRESH
    // -----------------------------------------------------
    function startSSE() {
        const evt = new EventSource("/api/events/updates");
        evt.onmessage = () => loadOperation();
        evt.onerror = () => setTimeout(startSSE, 2000);
    }

    startSSE();
    loadOperation();

</script>

</body>
</html>
