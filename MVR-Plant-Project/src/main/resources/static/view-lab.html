<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="https://mvrtech.org/MVR_Company_Logo%20copy.png">
    <title>View Laboratory Operation</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>


    <style>
        body {
            font-family:'Segoe UI', sans-serif;
            background:#eef2f7;
            margin:0;
            padding:0;
            display:flex;
            justify-content:center;
        }

        .card {
            background:white;
            padding:26px;
            border-radius:12px;
            box-shadow:0 10px 25px rgba(0,0,0,0.08);
            max-width:900px;
            width:100%;
            margin:20px;
        }

        h2 {
            text-align:center;
            margin-bottom:10px;
            color:#0369a1;
        }

        .top-info {
            font-weight:700;
            text-align:center;
            margin-bottom:16px;
            color:#374151;
        }

        table {
            width:100%;
            border-collapse:collapse;
            margin-top:10px;
        }

        table th, table td {
            border:1px solid #d9e2ec;
            padding:10px;
            font-size:15px;
        }

        table th {
            background:#0369a1;
            color:white;
            width:260px;
            text-align:left;
        }

        .progress-bar {
            width:240px;
            height:18px;
            background:#e5edf5;
            margin:12px auto;
            border-radius:10px;
            overflow:hidden;
        }

        .progress-fill {
            height:100%;
            width:0;
            transition:width 0.25s ease-out;
        }

        .progress-green { background:#10b981; }
        .progress-yellow { background:#f59e0b; }
        .progress-red { background:#ef4444; }

        .buttons {
            margin-top:20px;
            text-align:center;
        }

        .btn {
            padding:10px 18px;
            font-size:15px;
            border:none;
            border-radius:6px;
            color:white;
            cursor:pointer;
            margin:0 6px;
        }

        .btn-update { background:#059669; }
        .btn-back { background:#6b7280; }

    </style>
</head>

<body>

<div class="card">

    <h2>Laboratory Operation Details</h2>

    <div class="top-info" id="infoBox"></div>

    <!-- Progress -->
    <div style="text-align:center;">
        <div class="progress-bar">
            <div id="progressFill" class="progress-fill"></div>
        </div>
        <div id="progressText" style="font-weight:700; margin-bottom:14px;"></div>
    </div>

    <table>
        <thead>
        <tr><th>Field</th><th>Value</th></tr>
        </thead>
        <tbody id="fieldsBody"></tbody>
    </table>

    <div class="buttons">
        <button class="btn btn-update" id="updateBtn">Update</button>
        <button class="btn btn-back" id="backBtn">Back</button>
        <button class="btn" style="background:#2563eb;" id="pdfBtn">Download PDF</button>

    </div>

</div>

<script>

const params = new URLSearchParams(window.location.search);
const plantID = params.get('plantID');
const date = params.get('date');

document.getElementById("infoBox").innerHTML =
    `Date: <span style="color:#f97316">${date}</span> &nbsp; | &nbsp;
     Plant ID: <span style="color:#059669">${plantID}</span>`;

document.getElementById("backBtn").onclick = () =>
    window.location.href = `index.html?date=${encodeURIComponent(date)}`;

const fields = [
    "cod", "bod", "th", "temperature", "tss", "ph",
    "velocity", "cumulativeFlow", "flowMeterReadingAm", "flowMeterReadingPm"
];

const units = {
    cod:"mg/L", bod:"mg/L", th:"mg/L", temperature:"Â°C", tss:"mg/L",
    ph:"", velocity:"m/s", cumulativeFlow:"liters",
    flowMeterReadingAm:"liters", flowMeterReadingPm:"liters"
};

function formatValue(field, value) {
    if (!value && value !== 0) return "-";
    return units[field] ? `${value} ${units[field]}` : value;
}

function calculateProgress(lab) {
    let filled = 0;
    fields.forEach(f => { if (lab[f] !== null && lab[f] !== "") filled++; });
    return Math.round((filled / fields.length) * 100);
}

function applyProgressBar(progress) {
    const bar = document.getElementById("progressFill");
    bar.className = progress === 100 ? "progress-fill progress-green"
                  : progress > 0 ? "progress-fill progress-yellow"
                                 : "progress-fill progress-red";
    bar.style.width = progress + "%";
    document.getElementById("progressText").textContent = progress + "% Completed";
}

async function loadOperation() {
    const res = await fetch(`/api/laboperations/plant/${plantID}?date=${date}`);
    const raw = await res.text();

    let lab = {};
    if (raw.trim()) lab = JSON.parse(raw);

    renderTable(lab);
    applyProgressBar(calculateProgress(lab));

    document.getElementById("updateBtn").onclick = () =>
        window.location.href = `update-lab.html?plantID=${plantID}&date=${encodeURIComponent(date)}`;
}

function renderTable(lab) {
    const body = document.getElementById("fieldsBody");
    body.innerHTML = "";

    fields.forEach(f => {
        let label = f.replace(/([A-Z])/g, " $1").replace(/^./, c => c.toUpperCase());
        body.innerHTML += `<tr><td>${label}</td><td>${formatValue(f, lab[f])}</td></tr>`;
    });
}

document.getElementById("pdfBtn").onclick = () => {

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:"pt", format:"a4" });

    doc.setFontSize(18);
    doc.text("Laboratory Operation Report", 40, 40);

    doc.setFontSize(12);
    doc.text(`Date: ${date} | Plant ID: ${plantID}`, 40, 60);

    const rows = [];
    document.querySelectorAll("#fieldsBody tr").forEach(tr => {
        let cols = tr.querySelectorAll("td");
        rows.push([cols[0].innerText, cols[1].innerText]);
    });

    doc.autoTable({
        head:[["Field","Value"]],
        body:rows,
        startY:90,
        theme:"grid",
        headStyles:{fillColor:[3,105,161]}
    });

    doc.save(`Lab_${plantID}_${date}.pdf`);
};

function startSSE() {
    const evt = new EventSource("/api/events/updates");
    evt.onmessage = loadOperation;
}

startSSE();
loadOperation();

</script>


</body>
</html>
