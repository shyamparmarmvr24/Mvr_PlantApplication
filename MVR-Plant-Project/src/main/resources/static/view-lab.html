<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>View Laboratory Operation</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        body {
            font-family: "Segoe UI", sans-serif;
            background: #eef2f7;
            margin: 0;
            display: flex;
            justify-content: center;
        }

        .card {
            background: white;
            padding: 26px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            max-width: 1100px;
            width: 100%;
            margin: 20px;
        }

        h2 {
            text-align: center;
            color: #0369a1;
            margin-bottom: 10px;
        }

        .top-info {
            text-align: center;
            font-weight: 700;
            margin-bottom: 16px;
        }

        /* ================= TABLE ================= */
        .table-wrap {
            width: 100%;
            overflow-x: auto;
        }

        table {
            width: 100%;
            min-width: 950px;
            border-collapse: collapse;
            table-layout: fixed;
        }

        th {
            background: #0369a1;
            color: white;
            padding: 10px;
            font-size: 14px;
            text-align: center;
        }

        td {
            border: 1px solid #d9e2ec;
            padding: 8px;
            text-align: center;
            font-size: 14px;
        }

        /* ================= PROGRESS ================= */
        .progress-bar {
            width: 260px;
            height: 18px;
            background: #e5edf5;
            margin: 14px auto;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            width: 0;
            transition: width 0.3s ease;
        }

        .green { background: #10b981; }
        .yellow { background: #f59e0b; }
        .red { background: #ef4444; }

        /* ================= BUTTONS ================= */
        .buttons {
            margin-top: 20px;
            text-align: center;
        }

        .btn {
            padding: 10px 18px;
            font-size: 15px;
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            margin: 0 6px;
        }

        .btn-update { background: #059669; }
        .btn-back { background: #6b7280; }
        .btn-pdf { background: #2563eb; }

         /* ================= PROGRESS SPACING ================= */
        .progress-section {
            text-align: center;
            margin-bottom: 26px;   /* GAP BETWEEN PROGRESS & TABLE */
        }

        .progress-text {
            font-weight: 700;
            margin-top: 6px;
        }

    </style>
</head>

<body>

<div class="card">

    <h2>Laboratory Operation Details</h2>

    <div class="top-info" id="infoBox"></div>

    <!-- ================= PROGRESS ================= -->
    <!-- ================= PROGRESS ================= -->
    <div class="progress-section">
        <div class="progress-bar">
            <div id="progressFill" class="progress-fill"></div>
        </div>
        <div id="progressText" class="progress-text"></div>
    </div>

    <!-- ================= TABLE ================= -->
    <div class="table-wrap">
        <table>
            <thead>
            <tr>
                <th>Time</th>
                <th>COD</th>
                <th>BOD</th>
                <th>TN</th>
                <th>Temperature</th>
                <th>TSS</th>
                <th>PH</th>
            </tr>
            </thead>
            <tbody id="labBody"></tbody>
        </table>
    </div>

    <!-- ================= FLOW ================= -->
    <table style="margin-top:14px;">
        <tr>
            <th style="width:260px;">Flow Meter Morning</th>
            <td id="flowAm">-</td>
            <th style="width:260px;">Flow Meter Evening</th>
            <td id="flowPm">-</td>
        </tr>
        <tr>
            <th>Cumulative Flow (Ltrs)</th>
            <td colspan="3" id="cumulativeFlow">-</td>
        </tr>
    </table>

    <!-- ================= BUTTONS ================= -->
    <div class="buttons">
        <button class="btn btn-update" id="updateBtn">Update</button>
        <button class="btn btn-back" id="backBtn">Back</button>
    </div>

</div>

<script>
    const params = new URLSearchParams(window.location.search);
    const plantID = params.get("plantID");
    const date = params.get("date");
    let sseConnection = null;

   async function loadPlantInfo() {
    let plantName = "-";

    try {
        const res = await fetch(`/api/plants/${plantID}`);
        if (res.ok) {
            const plant = await res.json();
            plantName = plant.plantName || "-";
        }
    } catch (e) {
        console.error("Failed to load plant name", e);
    }

    document.getElementById("infoBox").innerHTML =
        `Date: <span style="color:#f97316">${date}</span> |
         Plant ID: <span style="color:#059669">${plantID}</span> |
         Plant Name: <span style="color:#0369a1">${plantName}</span>`;
}

    document.getElementById("backBtn").onclick = () =>
        window.location.href = `index.html?date=${encodeURIComponent(date)}`;

    document.getElementById("updateBtn").onclick = () =>
        window.location.href = `update-lab.html?plantID=${plantID}&date=${encodeURIComponent(date)}`;

    const timeLabels = ["10:00 AM", "12:00 PM", "02:30 PM", "05:00 PM"];

    const fieldGroups = [
        ["codReading1","bodReading1","thReading1","temperatureReading1","tssReading1","phReading1"],
        ["codReading2","bodReading2","thReading2","temperatureReading2","tssReading2","phReading2"],
        ["codReading3","bodReading3","thReading3","temperatureReading3","tssReading3","phReading3"],
        ["codReading4","bodReading4","thReading4","temperatureReading4","tssReading4","phReading4"]
    ];

    function calculateProgress(lab) {
        let total = 0, filled = 0;
        fieldGroups.flat().forEach(f => {
            total++;
            if (lab[f] !== null && lab[f] !== undefined) filled++;
        });
        if (lab.flowMeterReadingAm != null) filled++;
        if (lab.flowMeterReadingPm != null) filled++;
        total += 2;
        return Math.round((filled / total) * 100);
    }

    function applyProgress(progress) {
        const bar = document.getElementById("progressFill");
        bar.className = "progress-fill " + (progress === 100 ? "green" : progress > 0 ? "yellow" : "red");
        bar.style.width = progress + "%";
        document.getElementById("progressText").innerText = progress + "% Completed";
    }

    async function loadLab() {
        const res = await fetch(`/api/laboperations/plant/${plantID}?date=${date}`);
        if (!res.ok) return;
        const lab = await res.json();

        const body = document.getElementById("labBody");
        body.innerHTML = "";

        fieldGroups.forEach((group, i) => {
            body.innerHTML += `
                <tr>
                    <td><b>${timeLabels[i]}</b></td>
                    ${group.map(f => `<td>${lab[f] ?? "-"}</td>`).join("")}
                </tr>`;
        });
        /* ================= AVERAGE ROW ================= */
            body.innerHTML += `
                <tr style="background:#f1f5f9; font-weight:700;">
                    <td><b>Average Values</b></td>
                    <td>${lab.cod ?? "-"}</td>
                    <td>${lab.bod ?? "-"}</td>
                    <td>${lab.tn ?? "-"}</td>
                    <td>${lab.temperature ?? "-"}</td>
                    <td>${lab.tss ?? "-"}</td>
                    <td>${lab.ph ?? "-"}</td>
                </tr>
            `;

        document.getElementById("flowAm").innerText = lab.flowMeterReadingAm ?? "-";
        document.getElementById("flowPm").innerText = lab.flowMeterReadingPm ?? "-";

        const cum =
        (Number(lab.flowMeterReadingPm || 0) - Number(lab.flowMeterReadingAm || 0)) * 1000;
        document.getElementById("cumulativeFlow").innerText =
        isNaN(cum) ? "-" : cum.toFixed(2) + " Ltrs";
        document.getElementById("cumulativeFlow").style="background:#f1f5f9; font-weight:700;"
        applyProgress(calculateProgress(lab));
    }

    function startSSE() {
    try {
        if (sseConnection) return;

        sseConnection = new EventSource("/api/events/updates");

        sseConnection.addEventListener("DATA_UPDATE", async (e) => {
            let data;
            try {
                data = JSON.parse(e.data);
            } catch {
                return;
            }

            // ðŸ” Lab updated anywhere â†’ refresh view
            if (
                data.entity === "LAB" &&
                String(data.plantId) === String(plantID)
            ) {
                loadLab();
            }
        });

        sseConnection.onerror = () => {
            sseConnection.close();
            sseConnection = null;
            setTimeout(startSSE, 2000);
        };

    } catch (err) {
        console.warn("SSE failed", err);
    }
}

document.addEventListener("visibilitychange", () => {
    if (document.hidden && sseConnection) {
        sseConnection.close();
        sseConnection = null;
    } else if (!document.hidden) {
        startSSE();
    }
});


    loadPlantInfo();
    loadLab();
    startSSE();
</script>

</body>
</html>
