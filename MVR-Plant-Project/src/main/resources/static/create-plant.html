<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Create Plant & Vehicles - MVR TECHNOLOGY</title>

    <style>
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: "Segoe UI", sans-serif;
            background: #f5f7fa;
            color: #0f172a;
        }
        header {
            background: linear-gradient(90deg, #0f172a, #0ea5e9);
            padding: 14px 20px;
            color: white;
            font-size: 22px;
            font-weight: 700;
            text-align: center;
            letter-spacing: 1px;
        }

        .container {
            max-width: 900px;
            margin: 30px auto 40px;
            background: white;
            border-radius: 12px;
            padding: 24px 26px 28px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.08);
        }

        h2 { text-align: center; margin-top: 0; margin-bottom: 18px; color: #0f172a; }

        .steps-indicator { display: flex; justify-content: space-between; margin-bottom: 18px; }
        .step-pill {
            flex: 1; text-align:center; padding: 8px 10px; font-size:13px; border-radius:999px;
            background:#e5e7eb; color:#4b5563; margin-right:6px;
        }
        .step-pill:last-child { margin-right:0; }
        .step-pill.active { background:#0ea5e9; color:white; font-weight:600; }
        .step-pill.done { background:#16a34a; color:white; }

        .step { display: none; }
        .step.active { display: block; }

        .form-row { display:flex; gap:16px; margin-bottom:14px; flex-wrap:wrap; }
        .form-group { flex:1; min-width:220px; }
        label { display:block; font-weight:600; margin-bottom:4px; font-size:14px; }
        input, select { width:100%; padding:9px 10px; border-radius:6px; border:1px solid #d1d5db; font-size:14px; }
        input:disabled, select:disabled { background:#f3f4f6; cursor:not-allowed; }
        .note { font-size:12px; color:#6b7280; margin-top:2px; }
        .buttons { margin-top:20px; display:flex; justify-content:space-between; }
        .btn { padding:10px 18px; border-radius:8px; border:none; cursor:pointer; font-size:14px; font-weight:600; }
        .btn-next { background:#0ea5e9; color:white; }
        .btn-next:hover { background:#0284c7; }
        .btn-prev { background:#6b7280; color:white; }
        .btn-prev:hover { background:#4b5563; }
        .btn-submit { background:#16a34a; color:white; }
        .btn-submit:hover { background:#15803d; }

        .vehicle-card, .employee-card { border:1px solid #e5e7eb; border-radius:10px; padding:14px 16px 10px; margin-bottom:14px; background:#f9fafb; }
        .vehicle-title, .employee-title { font-weight:600; margin-bottom:10px; color:#0f172a; }
        .section-title { font-size:16px; font-weight:600; margin:10px 0 6px; color:#111827; }
        .divider { height:1px; background:#e5e7eb; margin:12px 0 16px; }
        .error-msg { color:#b91c1c; font-size:13px; margin-top:4px; white-space:pre-line; }
        .success-msg { color:#15803d; font-size:14px; margin-top:8px; text-align:center; }

        .req { color: red; font-weight: bold; margin-left:6px; }

        @media (max-width: 600px) {
            .form-row { flex-direction: column; }
        }
    </style>
</head>

<body>

<header>Create Plant Vehicles And Employees</header>

<div class="container">

    <!-- Step Pills -->
    <div class="steps-indicator">
        <div class="step-pill active" id="pill-1">1. Basic Details</div>
        <div class="step-pill" id="pill-2">2. Power & Network</div>
        <div class="step-pill" id="pill-3">3. Devices & Counts</div>
        <div class="step-pill" id="pill-4">4. Vehicle Details</div>
        <div class="step-pill" id="pill-5">5. Employee Information</div>
    </div>

    <div id="formError" class="error-msg" style="display:none;"></div>
    <div id="formSuccess" class="success-msg" style="display:none;"></div>

    <form id="plantWizardForm" autocomplete="off">

        <!-- STEP 1: BASIC PLANT DETAILS -->
        <div class="step active" id="step-1">
            <div class="section-title">Plant Basic Information</div>
            <div class="divider"></div>

            <div class="form-row">
                <div class="form-group">
                    <label for="plantID">Plant ID <span class="req">*</span></label>
                    <input type="number" id="plantID" required />
                    <div class="note">Enter existing Plant ID to load & edit details.</div>
                </div>
                <div class="form-group">
                    <label for="plantName">Plant Name <span class="req">*</span></label>
                    <input type="text" id="plantName" required />
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="stateCode">State Code</label>
                    <input type="text" id="stateCode" />
                </div>
                <div class="form-group">
                    <label for="district">District</label>
                    <input type="text" id="district" />
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="kld">KLD <span class="req">*</span></label>
                    <input type="number" id="kld" required />
                </div>
                <div class="form-group">
                    <label for="wardNo">Ward No</label>
                    <input type="number" id="wardNo" />
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="pinCode">Pin Code</label>
                    <input type="number" id="pinCode" />
                </div>
                <div class="form-group">
                    <label for="zones">Zone <span class="req">*</span></label>
                    <input type="number" id="zones" required />
                </div>
            </div>

            <div class="section-title">MNIT & Construction</div>
            <div class="divider"></div>

            <div class="form-row">
                <div class="form-group">
                    <label for="mnit">MNIT <span class="req">*</span></label>
                    <select id="mnit" required>
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="mnitDate">MNIT Completion Date</label>
                    <input type="date" id="mnitDate" disabled />
                    <div class="note">Future dates not allowed</div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="constructionStartedDate">Construction Started</label>
                    <input type="date" id="constructionStartedDate" />
                </div>
                <div class="form-group">
                    <label for="civilWorkCompletedDate">Civil Work Completed</label>
                    <input type="date" id="civilWorkCompletedDate" />
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="machinaryAssembleDate">Machinery Commissioned Date</label>
                    <input type="date" id="machinaryAssembleDate" />
                </div>
            </div>

            <div class="buttons">
                <button type="button" class="btn btn-prev" onclick="window.location.href='index.html'">â—‚ Back</button>
                <button type="button" class="btn btn-next" onclick="goToStep(2)">Next â–¸</button>
            </div>
        </div>

        <!-- STEP 2: POWER / SOLAR / INTERNET -->
        <div class="step" id="step-2">
            <div class="section-title">Power & Solar</div>
            <div class="divider"></div>

            <div class="form-row">
                <div class="form-group">
                    <label for="permanentPower">Permanent Power <span class="req">*</span></label>
                    <select id="permanentPower" required>
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="permanentPowerDate">Permanent Power Completion Date</label>
                    <input type="date" id="permanentPowerDate" disabled />
                    <div class="note">Future dates not allowed</div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="solar">Solar <span class="req">*</span></label>
                    <select id="solar" required>
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="solarDate">Solar Integration Date</label>
                    <input type="date" id="solarDate" disabled />
                    <div class="note">Future dates not allowed</div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="internet">Internet <span class="req">*</span></label>
                    <select id="internet" required>
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="internetDate">Internet Completion Date</label>
                    <input type="date" id="internetDate" disabled />
                    <div class="note">Future dates not allowed</div>
                </div>
            </div>

            <div class="section-title">CTO / CTE Certification</div>
            <div class="divider"></div>

            <!-- CTO -->
            <div class="form-row">
                <div class="form-group">
                    <label for="ctoCertified">CTO Certified</label>
                    <select id="ctoCertified">
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="ctoIssuedDate">CTO Issued Date</label>
                    <input type="date" id="ctoIssuedDate" disabled />
                </div>
                <div class="form-group">
                    <label for="ctoExpiryDate">CTO Expiry Date</label>
                    <input type="date" id="ctoExpiryDate" disabled />
                </div>
            </div>

            <!-- CTE -->
            <div class="form-row">
                <div class="form-group">
                    <label for="cteCertified">CTE Certified</label>
                    <select id="cteCertified">
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="cteIssuedDate">CTE Issued Date</label>
                    <input type="date" id="cteIssuedDate" disabled />
                </div>
                <div class="form-group">
                    <label for="cteExpiryDate">CTE Expiry Date</label>
                    <input type="date" id="cteExpiryDate" disabled />
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="solarPlantCapacity">Solar Power Capacity (kW)</label>
                    <input type="number" id="solarPlantCapacity" />
                </div>
            </div>

            <div class="buttons">
                <button type="button" class="btn btn-prev" onclick="goToStep(1)">â—‚ Back</button>
                <button type="button" class="btn btn-next" onclick="goToStep(3)">Next â–¸</button>
            </div>
        </div>

        <!-- STEP 3: DEVICES & NO OF VEHICLES / EMPLOYEES -->
        <div class="step" id="step-3">
            <div class="section-title">Devices & Sensors</div>
            <div class="divider"></div>

            <div class="form-row">
                <div class="form-group">
                    <label for="ipPhoneDate">IP Phone Received Date</label>
                    <input type="date" id="ipPhoneDate" />
                </div>
                <div class="form-group">
                    <label for="cameraConfigurationDate">Camera Configuration Date</label>
                    <input type="date" id="cameraConfigurationDate" />
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="tabs">Tabs</label>
                    <select id="tabs">
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="tabsReceivedDate">Tabs Received Date</label>
                    <input type="date" id="tabsReceivedDate" disabled />
                    <div class="note">Future dates not allowed</div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="codAndBodSenserDate">COD & BOD Installation Date</label>
                    <input type="date" id="codAndBodSenserDate" />
                    <div class="note">Future dates not allowed</div>
                </div>
                <div class="form-group">
                    <label for="noOfVehicle">Number of Vehicles</label>
                    <input type="number" id="noOfVehicle" min="0" value="0" />
                    <div class="note">Enter 0 if there are no vehicles</div>
                </div>
                <div class="form-group">
                    <label for="noOfEmployees">Number of Employees</label>
                    <input type="number" id="noOfEmployees" min="0" value="0" />
                    <div class="note">Enter 0 if there are no employees</div>
                </div>
            </div>

            <div class="buttons">
                <button type="button" class="btn btn-prev" onclick="goToStep(2)">â—‚ Back</button>
                <button type="button" class="btn btn-next" onclick="prepareVehiclesAndGoToStep4()">Next â–¸</button>
            </div>
        </div>

        <!-- STEP 4: VEHICLE DETAILS -->
        <div class="step" id="step-4">
            <div class="section-title">Vehicle Information</div>
            <div class="divider"></div>

            <div id="vehicleFormsContainer"></div>

            <div class="buttons">
                <button type="button" class="btn btn-prev" onclick="goToStep(3)">â—‚ Back</button>
                <button type="button" class="btn btn-next" onclick="prepareEmployeesAndGoToStep5()">Next â–¸</button>
            </div>
        </div>

        <!-- STEP 5: EMPLOYEE DETAILS -->
        <div class="step" id="step-5">
            <div class="section-title">Employee Information</div>
            <div class="divider"></div>

            <div id="employeeFormsContainerStep5"></div>

            <div class="buttons">
                <button type="button" class="btn btn-prev" onclick="goToStep(4)">â—‚ Back</button>
                <button type="button" class="btn btn-submit" onclick="submitPlantAndVehicles()">Submit All</button>
            </div>
        </div>

    </form>
</div>

<script>
    // ----------------------- GLOBALS -----------------------
    let currentStep = 1;
    let existingPlantData = null;
    let existingVehiclesData = [];
    let existingEmployeesData = [];
    let isEditMode = false;

    const DRAFT_KEY = "plantWizardDraft_v1";
    let latestDraftCache = null; // keep last saved draft in memory for vehicles/employees restore

    const today = new Date().toISOString().split("T")[0];

    // ----------------------- STEP NAVIGATION -----------------------
    function updateStepPills() {
        for (let i = 1; i <= 5; i++) {
            const pill = document.getElementById("pill-" + i);
            pill.classList.remove("active", "done");
            if (i < currentStep) pill.classList.add("done");
            if (i === currentStep) pill.classList.add("active");
        }
    }

    function goToStep(step) {
        if (step > currentStep && !validateCurrentStep()) {
            return;
        }
        document.getElementById("formError").style.display = "none";

        document.getElementById("step-" + currentStep).classList.remove("active");
        currentStep = step;
        document.getElementById("step-" + currentStep).classList.add("active");
        updateStepPills();
    }

    // ----------------------- DATE LIMITS -----------------------
    function setMaxDate(id) {
        const el = document.getElementById(id);
        if (el) el.max = today;
    }

    [
        "mnitDate",
        "constructionStartedDate",
        "civilWorkCompletedDate",
        "machinaryAssembleDate",
        "permanentPowerDate",
        "solarDate",
        "internetDate",
        "ipPhoneDate",
        "cameraConfigurationDate",
        "tabsReceivedDate",
        "codAndBodSenserDate",
        "ctoIssuedDate",
        "cteIssuedDate"
    ].forEach(setMaxDate);

    // ----------------------- YES/NO â†’ ENABLE/DISABLE DATES -----------------------
    function setupToggleWithDate(selectId, dateId) {
        const sel = document.getElementById(selectId);
        const dateInput = document.getElementById(dateId);

        function refresh() {
            if (!sel) return;
            if (sel.value === "yes") {
                dateInput.disabled = false;
            } else {
                dateInput.disabled = true;
                dateInput.value = "";
            }
        }

        sel.addEventListener("change", refresh);
        refresh();
    }

    setupToggleWithDate("mnit", "mnitDate");
    setupToggleWithDate("permanentPower", "permanentPowerDate");
    setupToggleWithDate("solar", "solarDate");
    setupToggleWithDate("internet", "internetDate");
    setupToggleWithDate("tabs", "tabsReceivedDate");

    setupToggleWithDate("ctoCertified", "ctoIssuedDate");
    setupToggleWithDate("ctoCertified", "ctoExpiryDate");

    setupToggleWithDate("cteCertified", "cteIssuedDate");
    setupToggleWithDate("cteCertified", "cteExpiryDate");


    const noOfVehicleEl = document.getElementById("noOfVehicle");

    // ----------------------- ENTER KEY â†’ NEXT FIELD -----------------------
    document.addEventListener("keydown", function (e) {
        if (e.key !== "Enter") return;
        const target = e.target;
        if (target.tagName !== "INPUT" && target.tagName !== "SELECT") return;

        e.preventDefault();

        const focusables = Array.from(
            document.querySelectorAll(
                "input:not([type=hidden]):not([disabled]), select:not([disabled])"
            )
        ).filter(el => el.offsetParent !== null);

        const idx = focusables.indexOf(target);
        if (idx > -1 && idx < focusables.length - 1) {
            focusables[idx + 1].focus();
        }
    });

    // ----------------------- ERROR / SUCCESS HELPERS -----------------------
    function showError(msg) {
        const errBox = document.getElementById("formError");
        errBox.textContent = msg;
        errBox.style.display = "block";
        document.getElementById("formSuccess").style.display = "none";
        window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function showSuccess(msg) {
        const box = document.getElementById("formSuccess");
        box.textContent = msg;
        box.style.display = "block";
        document.getElementById("formError").style.display = "none";
        window.scrollTo({ top: 0, behavior: "smooth" });
    }

    async function extractErrorMessage(res) {
        let text;
        try {
            text = await res.text();
        } catch {
            return `Server error (${res.status}). Please try again.`;
        }

        if (!text) return `Server error (${res.status}). Please try again.`;

        try {
            const json = JSON.parse(text);
            // From GlobalExceptionHandler
            if (json.errors && typeof json.errors === "object") {
                const fieldMsgs = Object.entries(json.errors)
                    .map(([field, msg]) => `â€¢ ${field}: ${msg}`)
                    .join("\n");
                return `${json.message || "Validation error"}\n${fieldMsgs}`;
            }
            if (json.message) return json.message;
            return text;
        } catch {
            return text;
        }
    }

    // ----------------------- VALIDATION FOR EACH STEP -----------------------
    function validateCurrentStep() {
        const step = currentStep;

        if (step === 1) {
            const requiredIds = ["plantID", "plantName", "kld", "zones", "mnit"];
            for (const id of requiredIds) {
                const el = document.getElementById(id);
                if (!el) continue;
                if (!el.value || el.value.toString().trim() === "") {
                    showError("Please fill all required fields in Basic Details.");
                    el.focus();
                    return false;
                }
            }
        }

        if (step === 3) {
            const noOfVehicle = document.getElementById("noOfVehicle").value;
            if (noOfVehicle === "" || parseInt(noOfVehicle, 10) < 0) {
                showError("Please enter a valid number of vehicles (0 or more).");
                document.getElementById("noOfVehicle").focus();
                return false;
            }

            const noOfEmployees = document.getElementById("noOfEmployees").value;
            if (noOfEmployees === "" || parseInt(noOfEmployees, 10) < 0) {
                showError("Please enter a valid number of employees (0 or more).");
                document.getElementById("noOfEmployees").focus();
                return false;
            }
        }

        if (step === 4) {
            const noOfVehicle = parseInt(document.getElementById("noOfVehicle").value || "0", 10);
            if (noOfVehicle > 0) {
                for (let i = 1; i <= noOfVehicle; i++) {
                    const model = document.getElementById(`veh_${i}_model`);
                    const number = document.getElementById(`veh_${i}_number`);
                    const chassis = document.getElementById(`veh_${i}_chassis`);
                    const regDate = document.getElementById(`veh_${i}_regDate`);

                    if (!model || !number || !chassis || !regDate) {
                        showError(`Vehicle ${i} inputs are missing on the page.`);
                        return false;
                    }

                    if (!model.value.trim() || !number.value.trim() || !chassis.value.trim() || !regDate.value) {
                        showError(`Please fill all mandatory fields for Vehicle ${i}.`);
                        model.focus();
                        return false;
                    }
                }
            }
        }

        if (step === 5) {
            const noOfEmployees = parseInt(document.getElementById("noOfEmployees").value || "0", 10);
            if (noOfEmployees > 0) {
                for (let i = 1; i <= noOfEmployees; i++) {
                    const idEl = document.getElementById(`emp_${i}_id`);
                    const nameEl = document.getElementById(`emp_${i}_name`);
                    const desEl = document.getElementById(`emp_${i}_designation`);
                    const mobEl = document.getElementById(`emp_${i}_mobile`);
                    const addrEl = document.getElementById(`emp_${i}_address`);
                    const dobEl = document.getElementById(`emp_${i}_dob`);
                    const dojEl = document.getElementById(`emp_${i}_doj`);

                    if (!idEl || !nameEl || !desEl || !mobEl || !addrEl || !dobEl || !dojEl) {
                        showError(`Employee ${i} inputs are missing on the page.`);
                        return false;
                    }

                    if (!idEl.value || !nameEl.value.trim() || !desEl.value.trim() ||
                        !mobEl.value || !addrEl.value.trim() || !dobEl.value || !dojEl.value) {
                        showError(`Please fill all mandatory fields for Employee ${i}.`);
                        idEl.focus();
                        return false;
                    }
                }
            }
        }

        return true;
    }

    // ----------------------- LOAD EXISTING PLANT BY ID -----------------------
    async function loadPlantById(plantId) {
        if (!plantId) return;

        try {
            const plantRes = await fetch(`/api/plants/${plantId}`);
            if (!plantRes.ok) {
                existingPlantData = null;
                existingVehiclesData = [];
                existingEmployeesData = [];
                isEditMode = false;
                return;
            }

            const plantData = await plantRes.json();
            existingPlantData = plantData;
            isEditMode = true;

            document.getElementById("plantName").value = plantData.plantName || "";
            document.getElementById("stateCode").value = plantData.stateCode || "";
            document.getElementById("district").value = plantData.district || "";
            document.getElementById("kld").value = plantData.kld ?? "";
            document.getElementById("wardNo").value = plantData.wardNo ?? "";
            document.getElementById("pinCode").value = plantData.pinCode ?? "";
            document.getElementById("zones").value = plantData.zones ?? "";

            const setYesNo = (id, value) => {
                const sel = document.getElementById(id);
                if (!sel) return;
                sel.value = value ? "yes" : "no";
                sel.dispatchEvent(new Event("change"));
            };

            setYesNo("mnit", plantData.mnit);
            if (plantData.mnitDateOfCompletion) {
                document.getElementById("mnitDate").value = plantData.mnitDateOfCompletion;
            }

            setYesNo("permanentPower", plantData.permanentPower);
            if (plantData.permanentPowerDateOfCompletion) {
                document.getElementById("permanentPowerDate").value = plantData.permanentPowerDateOfCompletion;
            }

            setYesNo("solar", plantData.solar);
            if (plantData.solarDateOfCompletion) {
                document.getElementById("solarDate").value = plantData.solarDateOfCompletion;
            }

            setYesNo("internet", plantData.internet);
            if (plantData.internetDateOfCompletion) {
                document.getElementById("internetDate").value = plantData.internetDateOfCompletion;
            }

            setYesNo("ctoCertified", plantData.ctoCertified);
            if (plantData.ctoIssuedDate) {
                document.getElementById("ctoIssuedDate").value = plantData.ctoIssuedDate;
            }
            if (plantData.ctoExpiryDate) {
                document.getElementById("ctoExpiryDate").value = plantData.ctoExpiryDate;
            }

            setYesNo("cteCertified", plantData.cteCertified);
            if (plantData.cteIssuedDate) {
                document.getElementById("cteIssuedDate").value = plantData.cteIssuedDate;
            }
            if (plantData.cteExpiryDate) {
                document.getElementById("cteExpiryDate").value = plantData.cteExpiryDate;
            }


            document.getElementById("solarPlantCapacity").value = plantData.solarPlantCapacity ?? "";

            document.getElementById("constructionStartedDate").value = plantData.constructionStartedDate || "";
            document.getElementById("civilWorkCompletedDate").value = plantData.civilWorkCompletedDate || "";
            document.getElementById("machinaryAssembleDate").value = plantData.machinaryAssembleDate || "";

            document.getElementById("codAndBodSenserDate").value = plantData.codAndBodSenserDate || "";
            document.getElementById("ipPhoneDate").value = plantData.ipPhoneDate || "";
            document.getElementById("cameraConfigurationDate").value = plantData.cameraConfigurationDate || "";

            setYesNo("tabs", plantData.tabs);
            if (plantData.tabsReceivedDate) {
                document.getElementById("tabsReceivedDate").value = plantData.tabsReceivedDate;
            }

            const noOfVehicle = plantData.noOfVehicle ?? 0;
            const noOfEmployees = plantData.noOfEmployees ?? 0;

            document.getElementById("noOfVehicle").value = noOfVehicle;
            document.getElementById("noOfEmployees").value = noOfEmployees;

            try {
                const vehRes = await fetch(`/api/vehiclesinformation/plant/${plantId}`);
                if (vehRes.ok) {
                    existingVehiclesData = await vehRes.json();
                    if (!plantData.noOfVehicle && existingVehiclesData.length > 0) {
                        document.getElementById("noOfVehicle").value = existingVehiclesData.length;

                    }
                }
            } catch (e) {
                console.error("Error fetching vehicles for plant", e);
            }

            try {
                const empRes = await fetch(`/api/plantemployees/plant/${plantId}`);
                if (empRes.ok) {
                    existingEmployeesData = await empRes.json();
                    if (!plantData.noOfEmployees && existingEmployeesData.length > 0) {
                        document.getElementById("noOfEmployees").value = existingEmployeesData.length;
                    }
                }
            } catch (e) {
                console.error("Error fetching employees for plant", e);
            }

            showSuccess("Existing plant data loaded. You can edit and submit to update.");

        } catch (err) {
            console.error("Error loading plant by ID", err);
            showError("Failed to load existing plant details. Please try again.");
        }
    }

    document.getElementById("plantID").addEventListener("blur", function () {
        const plantIdVal = this.value;
        if (plantIdVal) {
            loadPlantById(plantIdVal);
        }
    });

    function toggleDriverLicence(i) {
    const des = document.getElementById(`emp_${i}_designation`);
    const block = document.getElementById(`emp_${i}_licence_block`);
    const dates = document.getElementById(`emp_${i}_licence_dates`);

    function refresh() {
        if (des.value === "Driver") {
            block.style.display = "";
            dates.style.display = "";
        } else {
            block.style.display = "none";
            dates.style.display = "none";

            document.getElementById(`emp_${i}_licenceType`).value = "";
            document.getElementById(`emp_${i}_licenceNumber`).value = "";
            document.getElementById(`emp_${i}_licenceIssueDate`).value = "";
            document.getElementById(`emp_${i}_licenceExpiryDate`).value = "";
        }
    }

    des.addEventListener("change", refresh);
    refresh();
}


    // ----------------------- VEHICLE / EMPLOYEE FORMS -----------------------
    async function prepareVehiclesAndGoToStep4() {
    if (!validateCurrentStep()) return;

    const vehicleContainer = document.getElementById("vehicleFormsContainer");
    vehicleContainer.innerHTML = "";

    let count = parseInt(document.getElementById("noOfVehicle").value || "0", 10);

    // if editing â†’ override count with actual existing vehicles
    if (isEditMode && existingVehiclesData.length > 0) {
        if (count < existingVehiclesData.length) {
            count = existingVehiclesData.length;
            document.getElementById("noOfVehicle").value = count;
        }
    }

    for (let i = 1; i <= count; i++) {
        const card = document.createElement("div");
        card.className = "vehicle-card";
        card.innerHTML = `
            <div class="vehicle-title">Vehicle ${i}</div>

            <div class="form-row">
                <div class="form-group">
                    <label>Model Name *</label>
                    <input type="text" id="veh_${i}_model">
                </div>
                <div class="form-group">
                    <label>Vehicle Number *</label>
                    <input type="text" id="veh_${i}_number">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Chassis Number *</label>
                    <input type="text" id="veh_${i}_chassis">
                </div>
                <div class="form-group">
                    <label>Date of Registration *</label>
                    <input type="date" id="veh_${i}_regDate" max="${today}">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Insurance Date</label>
                    <input type="date" id="veh_${i}_insDate" max="${today}">
                </div>
                <div class="form-group">
                    <label>Insurance Expiry Date</label>
                    <input type="date" id="veh_${i}_insExpDate">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>GPS Status</label>
                    <select id="veh_${i}_gpsStatus">
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>GPS Installation Date</label>
                    <input type="date" id="veh_${i}_gpsInstallDate" max="${today}" disabled />
                    <div class="note">Enabled only if GPS is Yes</div>
                </div>
            </div>


            <div class="divider"></div>
            <div class="section-title">Engine & Battery</div>

            <div class="form-row">
                <div class="form-group">
                    <label>Engine Number</label>
                    <input type="text" id="veh_${i}_engineNo">
                </div>
                <div class="form-group">
                    <label>Battery Make</label>
                    <input type="text" id="veh_${i}_batteryMake">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Battery Number</label>
                    <input type="text" id="veh_${i}_batteryNo">
                </div>
                <div class="form-group">
                    <label>Battery Purchase Date</label>
                    <input type="date" id="veh_${i}_batteryPurchaseDate" max="${today}">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Battery Expiry Date</label>
                    <input type="date" id="veh_${i}_batteryExpiryDate">
                </div>
            </div>

            <div class="divider"></div>
            <div class="section-title">Tyre Details</div>

            <div class="form-row">
                <div class="form-group">
                    <label>Front Right Tyre Make</label>
                    <input type="text" id="veh_${i}_tfrMake">
                </div>
                <div class="form-group">
                    <label>Front Right Tyre Serial</label>
                    <input type="text" id="veh_${i}_tfrSerial">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Front Left Tyre Make</label>
                    <input type="text" id="veh_${i}_tflMake">
                </div>
                <div class="form-group">
                    <label>Front Left Tyre Serial</label>
                    <input type="text" id="veh_${i}_tflSerial">
                </div>
            </div>

            <div class="divider"></div>
            <div class="section-title">Rear Tyres</div>

            <div class="form-row">
                <div class="form-group">
                    <label>Rear Right Inner Tyre Make</label>
                    <input type="text" id="veh_${i}_rrInnerMake">
                </div>
                <div class="form-group">
                    <label>Rear Right Inner Tyre Serial</label>
                    <input type="text" id="veh_${i}_rrInnerSerial">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Rear Right Outer Tyre Make</label>
                    <input type="text" id="veh_${i}_rrOuterMake">
                </div>
                <div class="form-group">
                    <label>Rear Right Outer Tyre Serial</label>
                    <input type="text" id="veh_${i}_rrOuterSerial">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Rear Left Inner Tyre Make</label>
                    <input type="text" id="veh_${i}_rlInnerMake">
                </div>
                <div class="form-group">
                    <label>Rear Left Inner Tyre Serial</label>
                    <input type="text" id="veh_${i}_rlInnerSerial">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Rear Left Outer Tyre Make</label>
                    <input type="text" id="veh_${i}_rlOuterMake">
                </div>
                <div class="form-group">
                    <label>Rear Left Outer Tyre Serial</label>
                    <input type="text" id="veh_${i}_rlOuterSerial">
                </div>
            </div>


            <div class="divider"></div>
            <div class="section-title">Stepney</div>

            <div class="form-row">
                <div class="form-group">
                    <label>Stepney Make</label>
                    <input type="text" id="veh_${i}_stepneyMake">
                </div>
                <div class="form-group">
                    <label>Stepney Serial No</label>
                    <input type="text" id="veh_${i}_stepneySerial">
                </div>
            </div>

        `;
        vehicleContainer.appendChild(card);
        setupVehicleGpsToggle(i);
    }

    // fill existing vehicles
    existingVehiclesData.forEach((v, idx) => {
        const i = idx + 1;
        document.getElementById(`veh_${i}_model`).value = v.vehicleModelName || "";
        document.getElementById(`veh_${i}_number`).value = v.vehicleNumber || "";
        document.getElementById(`veh_${i}_chassis`).value = v.vehicleChassisNo || "";
        document.getElementById(`veh_${i}_regDate`).value = v.dateOfRegistration || "";
        document.getElementById(`veh_${i}_insDate`).value = v.insuranceDate || "";
        document.getElementById(`veh_${i}_insExpDate`).value = v.insuranceExpiryDate || "";
        document.getElementById(`veh_${i}_gpsStatus`).value = v.gpsStatus ? "yes" : "no";
        document.getElementById(`veh_${i}_gpsInstallDate`).value =
            v.gpsInstallationDate || "";
        setupVehicleGpsToggle(i);

        document.getElementById(`veh_${i}_engineNo`).value = v.vehicleEngineNumber || "";
        document.getElementById(`veh_${i}_batteryMake`).value = v.vehicleBatteryMake || "";
        document.getElementById(`veh_${i}_batteryNo`).value = v.vehicleBatteryNumber || "";
        document.getElementById(`veh_${i}_batteryPurchaseDate`).value = v.vehicleBatteryPurchaseDate || "";
        document.getElementById(`veh_${i}_batteryExpiryDate`).value = v.vehicleBatteryExpiryDate || "";

        document.getElementById(`veh_${i}_tfrMake`).value = v.vehicleTyreFrontRightMake || "";
        document.getElementById(`veh_${i}_tfrSerial`).value = v.vehicleTyreFrontRightSerialNo || "";
        document.getElementById(`veh_${i}_tflMake`).value = v.vehicleTyreFrontLeftMake || "";
        document.getElementById(`veh_${i}_tflSerial`).value = v.vehicleTyreFrontLeftSerialNo || "";
        document.getElementById(`veh_${i}_rrInnerMake`).value = v.vehicleTyreRearRightInnerMake || "";
        document.getElementById(`veh_${i}_rrInnerSerial`).value = v.vehicleTyreRearRightInnerSerialNo || "";

        document.getElementById(`veh_${i}_rrOuterMake`).value = v.vehicleTyreRearRightOuterMake || "";
        document.getElementById(`veh_${i}_rrOuterSerial`).value = v.vehicleTyreRearRightOuterSerialNo || "";

        document.getElementById(`veh_${i}_rlInnerMake`).value = v.vehicleTyreRearLeftInnerMake || "";
        document.getElementById(`veh_${i}_rlInnerSerial`).value = v.vehicleTyreRearLeftInnerSerialNo || "";

        document.getElementById(`veh_${i}_rlOuterMake`).value = v.vehicleTyreRearLeftOuterMake || "";
        document.getElementById(`veh_${i}_rlOuterSerial`).value = v.vehicleTyreRearLeftOuterSerialNo || "";


        document.getElementById(`veh_${i}_stepneyMake`).value = v.stepneyMake || "";
        document.getElementById(`veh_${i}_stepneySerial`).value = v.stepneySerialNo || "";

    });

    goToStep(4);
}

    function prepareEmployeesAndGoToStep5() {
    if (!validateCurrentStep()) return;

    let count = parseInt(document.getElementById("noOfEmployees").value || "0", 10);
    const employeeContainer = document.getElementById("employeeFormsContainerStep5");
    employeeContainer.innerHTML = "";

    // ðŸ”¥ FIX 1: Ensure form shows ALL existing employees
    if (isEditMode && existingEmployeesData.length > 0) {
        if (count < existingEmployeesData.length) {
            count = existingEmployeesData.length;
            document.getElementById("noOfEmployees").value = count;
        }
    }

    if (count <= 0 || isNaN(count)) {
        employeeContainer.innerHTML = "<div class='note'>No employees entered. You can submit directly.</div>";
        goToStep(5);
        return;
    }

    // Generate employee forms
    for (let i = 1; i <= count; i++) {
        const card = document.createElement("div");
        card.className = "employee-card";
        card.innerHTML = `
            <div class="employee-title">Employee ${i}</div>

            <div class="form-row">
                <div class="form-group">
                    <label>Employee ID <span class="req">*</span></label>
                    <input type="number" id="emp_${i}_id" required />
                </div>
                <div class="form-group">
                    <label>Employee Name <span class="req">*</span></label>
                    <input type="text" id="emp_${i}_name" required />
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Designation <span class="req">*</span></label>
                    <select id="emp_${i}_designation" required class="input">
                        <option value="">-- Select Designation --</option>
                        <option value="Supervisor">Supervisor</option>
                        <option value="Operator">Operator</option>
                        <option value="Helper">Helper</option>
                        <option value="Driver">Driver</option>
                        <option value="Security Guard">Security Guard</option>
                    </select>

                    <div class="form-row" id="emp_${i}_licence_block" style="display:none;">
                        <div class="form-group">
                            <label>Licence Type</label>
                            <select id="emp_${i}_licenceType">
                                <option value="">-- Select Licence Type --</option>
                                <option value="Heavy">Heavy</option>
                                <option value="Light">Light</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Licence Number</label>
                            <input type="text" id="emp_${i}_licenceNumber">
                        </div>
                    </div>

                    <div class="form-row" id="emp_${i}_licence_dates" style="display:none;">
                        <div class="form-group">
                            <label>Licence Issue Date</label>
                            <input type="date" id="emp_${i}_licenceIssueDate" max="${today}">
                        </div>
                        <div class="form-group">
                            <label>Licence Expiry Date</label>
                            <input type="date" id="emp_${i}_licenceExpiryDate">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Mobile No <span class="req">*</span></label>
                    <input type="number" id="emp_${i}_mobile" required />
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Alternate/Emergency Mobile No</label>
                    <input type="number" id="emp_${i}_altMobile" />
                </div>
                <div class="form-group">
                    <label>Full Address <span class="req">*</span></label>
                    <input type="text" id="emp_${i}_address" required />
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Date of Birth <span class="req">*</span></label>
                    <input type="date" id="emp_${i}_dob" max="${today}" required />
                </div>
                <div class="form-group">
                    <label>Date of Joining <span class="req">*</span></label>
                    <input type="date" id="emp_${i}_doj" max="${today}" required />
                </div>
            </div>
        `;
        employeeContainer.appendChild(card);
        toggleDriverLicence(i);
    }

    // Prefill from existing data
    existingEmployeesData.forEach((emp, idx) => {
        const i = idx + 1;
        if (!emp) return;

        document.getElementById(`emp_${i}_id`).value = emp.employeeId ?? "";
        document.getElementById(`emp_${i}_name`).value = emp.employeeName ?? "";
        document.getElementById(`emp_${i}_designation`).value = emp.designation ?? "";
        document.getElementById(`emp_${i}_mobile`).value = emp.mobileNo ?? "";
        document.getElementById(`emp_${i}_altMobile`).value = emp.alternateMobNo ?? "";
        document.getElementById(`emp_${i}_address`).value = emp.address ?? "";
        document.getElementById(`emp_${i}_dob`).value = emp.dateOfBirth ?? "";
        document.getElementById(`emp_${i}_doj`).value = emp.dateOfJoining ?? "";
        document.getElementById(`emp_${i}_licenceType`).value = emp.licenceType ?? "";
        document.getElementById(`emp_${i}_licenceNumber`).value = emp.licenceNumber ?? "";
        document.getElementById(`emp_${i}_licenceIssueDate`).value = emp.licenceIssueDate ?? "";
        document.getElementById(`emp_${i}_licenceExpiryDate`).value = emp.licenceExpiryDate ?? "";

        toggleDriverLicence(i);
    });

    goToStep(5);
}

    // ----------------------- BUILD PAYLOADS -----------------------
    function buildPlantPayload() {
        return {
            plantID: Number(document.getElementById("plantID").value),
            plantName: document.getElementById("plantName").value.trim(),
            stateCode: document.getElementById("stateCode").value.trim() || null,
            district: document.getElementById("district").value.trim() || null,
            kld: Number(document.getElementById("kld").value),
            wardNo: document.getElementById("wardNo").value ? Number(document.getElementById("wardNo").value) : null,
            pinCode: document.getElementById("pinCode").value ? Number(document.getElementById("pinCode").value) : null,
            zones: Number(document.getElementById("zones").value),

            mnit: document.getElementById("mnit").value === "yes",
            permanentPower: document.getElementById("permanentPower").value === "yes",
            solar: document.getElementById("solar").value === "yes",
            internet: document.getElementById("internet").value === "yes",

            mnitDateOfCompletion: document.getElementById("mnitDate").value || null,
            permanentPowerDateOfCompletion: document.getElementById("permanentPowerDate").value || null,
            solarDateOfCompletion: document.getElementById("solarDate").value || null,
            internetDateOfCompletion: document.getElementById("internetDate").value || null,

            solarPlantCapacity: document.getElementById("solarPlantCapacity").value
                ? Number(document.getElementById("solarPlantCapacity").value)
                : null,

            constructionStartedDate: document.getElementById("constructionStartedDate").value || null,
            civilWorkCompletedDate: document.getElementById("civilWorkCompletedDate").value || null,
            machinaryAssembleDate: document.getElementById("machinaryAssembleDate").value || null,

            codAndBodSenserDate: document.getElementById("codAndBodSenserDate").value || null,
            ipPhoneDate: document.getElementById("ipPhoneDate").value || null,
            cameraConfigurationDate: document.getElementById("cameraConfigurationDate").value || null,

            tabs: document.getElementById("tabs").value === "yes",
            tabsReceivedDate: document.getElementById("tabsReceivedDate").value || null,

            noOfVehicle: Number(document.getElementById("noOfVehicle").value || 0),
            noOfEmployees: Number(document.getElementById("noOfEmployees").value || 0),

            ctoCertified: document.getElementById("ctoCertified").value === "yes",
            ctoIssuedDate: document.getElementById("ctoIssuedDate").value || null,
            ctoExpiryDate: document.getElementById("ctoExpiryDate").value || null,

            cteCertified: document.getElementById("cteCertified").value === "yes",
            cteIssuedDate: document.getElementById("cteIssuedDate").value || null,
            cteExpiryDate: document.getElementById("cteExpiryDate").value || null

        };
    }

    function buildVehiclesPayload() {
        const noOfVehicle = parseInt(document.getElementById("noOfVehicle").value || "0", 10);
        const vehicles = [];
        if (noOfVehicle <= 0) return vehicles;

        for (let i = 1; i <= noOfVehicle; i++) {
            vehicles.push({
                vehicleModelName: document.getElementById(`veh_${i}_model`)?.value.trim() || "",
                vehicleNumber: document.getElementById(`veh_${i}_number`)?.value.trim() || "",
                vehicleChassisNo: document.getElementById(`veh_${i}_chassis`)?.value.trim() || "",
                dateOfRegistration: document.getElementById(`veh_${i}_regDate`)?.value || null,
                insuranceDate: document.getElementById(`veh_${i}_insDate`)?.value || null,
                insuranceExpiryDate: document.getElementById(`veh_${i}_insExpDate`)?.value || null,
                gpsStatus: document.getElementById(`veh_${i}_gpsStatus`)?.value === "yes",
                gpsInstallationDate:
                    document.getElementById(`veh_${i}_gpsInstallDate`)?.value || null,
                vehicleEngineNumber: document.getElementById(`veh_${i}_engineNo`)?.value || null,
                vehicleBatteryMake: document.getElementById(`veh_${i}_batteryMake`)?.value || null,
                vehicleBatteryNumber: document.getElementById(`veh_${i}_batteryNo`)?.value || null,
                vehicleBatteryPurchaseDate: document.getElementById(`veh_${i}_batteryPurchaseDate`)?.value || null,
                vehicleBatteryExpiryDate: document.getElementById(`veh_${i}_batteryExpiryDate`)?.value || null,

                vehicleTyreFrontRightMake: document.getElementById(`veh_${i}_tfrMake`)?.value || null,
                vehicleTyreFrontRightSerialNo: document.getElementById(`veh_${i}_tfrSerial`)?.value || null,
                vehicleTyreFrontLeftMake: document.getElementById(`veh_${i}_tflMake`)?.value || null,
                vehicleTyreFrontLeftSerialNo: document.getElementById(`veh_${i}_tflSerial`)?.value || null,
                vehicleTyreRearRightInnerMake: document.getElementById(`veh_${i}_rrInnerMake`)?.value || null,
                vehicleTyreRearRightInnerSerialNo: document.getElementById(`veh_${i}_rrInnerSerial`)?.value || null,

                vehicleTyreRearRightOuterMake: document.getElementById(`veh_${i}_rrOuterMake`)?.value || null,
                vehicleTyreRearRightOuterSerialNo: document.getElementById(`veh_${i}_rrOuterSerial`)?.value || null,

                vehicleTyreRearLeftInnerMake: document.getElementById(`veh_${i}_rlInnerMake`)?.value || null,
                vehicleTyreRearLeftInnerSerialNo: document.getElementById(`veh_${i}_rlInnerSerial`)?.value || null,

                vehicleTyreRearLeftOuterMake: document.getElementById(`veh_${i}_rlOuterMake`)?.value || null,
                vehicleTyreRearLeftOuterSerialNo: document.getElementById(`veh_${i}_rlOuterSerial`)?.value || null,

                stepneyMake: document.getElementById(`veh_${i}_stepneyMake`)?.value || null,
                stepneySerialNo: document.getElementById(`veh_${i}_stepneySerial`)?.value || null

            });
        }
        return vehicles;
    }

    function buildEmployeesPayload() {
        const noOfEmployees = parseInt(document.getElementById("noOfEmployees").value || "0", 10);
        const employees = [];
        if (noOfEmployees <= 0) return employees;

        for (let i = 1; i <= noOfEmployees; i++) {
            const designation = document.getElementById(`emp_${i}_designation`).value;

employees.push({
    employeeId: document.getElementById(`emp_${i}_id`)?.value
        ? Number(document.getElementById(`emp_${i}_id`).value)
        : null,

    employeeName: document.getElementById(`emp_${i}_name`).value.trim(),
    designation,

    mobileNo: Number(document.getElementById(`emp_${i}_mobile`).value),

    alternateMobNo: document.getElementById(`emp_${i}_altMobile`).value
        ? Number(document.getElementById(`emp_${i}_altMobile`).value)
        : null,

    address: document.getElementById(`emp_${i}_address`).value.trim(),
    dateOfBirth: document.getElementById(`emp_${i}_dob`).value,
    dateOfJoining: document.getElementById(`emp_${i}_doj`).value,

    licenceType: designation === "Driver"
        ? document.getElementById(`emp_${i}_licenceType`).value || null
        : null,

    licenceNumber: designation === "Driver"
        ? document.getElementById(`emp_${i}_licenceNumber`).value || null
        : null,

    licenceIssueDate: designation === "Driver"
        ? document.getElementById(`emp_${i}_licenceIssueDate`).value || null
        : null,

    licenceExpiryDate: designation === "Driver"
        ? document.getElementById(`emp_${i}_licenceExpiryDate`).value || null
        : null
});

        }
        return employees;
    }

    //gps status vehicle
    function setupVehicleGpsToggle(index) {
    const gpsSel = document.getElementById(`veh_${index}_gpsStatus`);
    const gpsDate = document.getElementById(`veh_${index}_gpsInstallDate`);

    if (!gpsSel || !gpsDate) return;

    function refresh() {
        if (gpsSel.value === "yes") {
            gpsDate.disabled = false;
        } else {
            gpsDate.disabled = true;
            gpsDate.value = "";
        }
    }

    gpsSel.addEventListener("change", refresh);
    refresh();
    }


    // ----------------------- AUTOSAVE -----------------------
    function collectDraftState() {
        const fields = {};
        document.querySelectorAll("input, select").forEach(el => {
            if (el.id) {
                fields[el.id] = el.value;
            }
        });

        const vehicles = buildVehiclesPayload();
        const employees = buildEmployeesPayload();

        const draft = {
            step: currentStep,
            fields,
            vehicles,
            employees
        };
        latestDraftCache = draft;
        return draft;
    }

    function saveDraft() {
        try {
            const draft = collectDraftState();
            localStorage.setItem(DRAFT_KEY, JSON.stringify(draft));
        } catch (e) {
            console.warn("Failed to save draft", e);
        }
    }

    function clearDraft() {
        try {
            localStorage.removeItem(DRAFT_KEY);
        } catch {}
        latestDraftCache = null;
    }

    function restoreDraft() {
        try {
            const raw = localStorage.getItem(DRAFT_KEY);
            if (!raw) return;
            const draft = JSON.parse(raw);
            latestDraftCache = draft;

            if (draft.fields && typeof draft.fields === "object") {
                Object.entries(draft.fields).forEach(([id, val]) => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.value = val;
                    }
                });

                ["mnit","permanentPower","solar","internet","tabs","ctoCertified","cteCertified"]
                .forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.dispatchEvent(new Event("change"));
                });

            }

            if (draft.step && draft.step >= 1 && draft.step <= 5) {
                document.getElementById("step-" + currentStep).classList.remove("active");
                currentStep = draft.step;
                document.getElementById("step-" + currentStep).classList.add("active");
                updateStepPills();
            }
        } catch (e) {
            console.warn("Failed to restore draft", e);
        }
    }

    // autosave every 3 seconds
    setInterval(saveDraft, 3000);

    // ----------------------------------------
// Reset entire form when PlantID becomes empty
// ----------------------------------------
document.getElementById("plantID").addEventListener("input", function () {
    if (this.value.trim() === "") {

        // reset flags
        isEditMode = false;
        existingPlantData = null;
        existingVehiclesData = [];
        existingEmployeesData = [];

        // clear draft from storage
        clearDraft();

        // clear all fields
        document.querySelectorAll("input, select").forEach(el => {
            if (el.id && el.id !== "plantID") {
                el.value = "";
            }
        });

        // reset step counters
        document.getElementById("noOfVehicle").value = "0";
        document.getElementById("noOfEmployees").value = "0";

        // refresh dependent UI
        document.getElementById("vehicleFormsContainer").innerHTML = "";
        document.getElementById("employeeFormsContainerStep5").innerHTML = "";

        showSuccess("Form reset because Plant ID was cleared.");
    }
});


    // ----------------------- SUBMIT PLANT + VEHICLES + EMPLOYEES -----------------------
    async function submitPlantAndVehicles() {
        if (!validateCurrentStep()) return;

        document.getElementById("formError").style.display = "none";
        document.getElementById("formSuccess").style.display = "none";

        const plantPayload = buildPlantPayload();
        const vehiclesPayload = buildVehiclesPayload();
        const employeesPayload = buildEmployeesPayload();
        const plantId = plantPayload.plantID;

        try {
            let plantRes;

            // Check if plant exists (same PlantID)
            const checkPlant = await fetch(`/api/plants/${plantId}`);
            const exists = checkPlant.ok;

            if (exists) {
                plantRes = await fetch(`/api/plants/${plantId}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(plantPayload)
                });
            } else {
                plantRes = await fetch("/api/plants", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(plantPayload)
                });
            }

            if (!plantRes.ok) {
                const msg = await extractErrorMessage(plantRes);
                showError("Plant not saved. " + msg);
                return;
            }

            // SAVE VEHICLES
            if (vehiclesPayload.length > 0) {
                const vehiclePromises = vehiclesPayload.map((v, index) => {
                    const existingVehicle = existingVehiclesData[index];
                    if (existingVehicle && existingVehicle.vehicleID) {
                        return fetch(`/api/vehiclesinformation/update/${plantId}/${existingVehicle.vehicleID}`, {
                            method: "PUT",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(v)
                        });
                    }
                    return fetch(`/api/vehiclesinformation/create/${plantId}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(v)
                    });
                });

                const vehResults = await Promise.all(vehiclePromises);
                const failedIdx = vehResults.findIndex(r => !r.ok);
                if (failedIdx !== -1) {
                    const failedRes = vehResults[failedIdx];
                    const msg = await extractErrorMessage(failedRes);
                    showError(`Vehicle ${failedIdx + 1} not saved. ${msg}`);
                    return;
                }
            }

            // SAVE EMPLOYEES
            if (employeesPayload.length > 0) {
                const empPromises = employeesPayload.map((e, index) => {
                    const existingEmp = existingEmployeesData[index];
                    if (existingEmp) {
                        return fetch(`/api/plantemployees/update/${plantId}/${existingEmp.employeeId}`, {
                            method: "PUT",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(e)
                        });
                    }
                    return fetch(`/api/plantemployees/create/${plantId}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(e)
                    });
                });

                const empResults = await Promise.all(empPromises);
                const failedIdx = empResults.findIndex(r => !r.ok);
                if (failedIdx !== -1) {
                    const failedRes = empResults[failedIdx];
                    const msg = await extractErrorMessage(failedRes);
                    showError(`Employee ${failedIdx + 1} not saved. ${msg}`);
                    return;
                }
            }

            showSuccess(exists ? "Plant updated successfully!" : "Plant created successfully!");
            clearDraft(); // clear autosave only on full success

            setTimeout(() => {
                window.location.href = "index.html";
            }, 1500);

        } catch (err) {
            console.error(err);
            showError("Unexpected error occurred while saving data. Please check your inputs and try again.");
        }
    }

    // ----------------------- INITIAL SETUP -----------------------
    updateStepPills();
    restoreDraft();
    // Clear autosave when user closes or refreshes page
    window.addEventListener("beforeunload", () => {
    clearDraft();
     });
</script>
</body>
</html>